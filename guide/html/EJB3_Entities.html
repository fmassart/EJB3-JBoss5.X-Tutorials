<?xml version="1.0" encoding="UTF-8" standalone="no"?>

<!DOCTYPE html
  PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
   <head>
      <title>Chapter 12. Introduction to Entities in EJB3</title>
      <link rel="stylesheet" href="css/jbossorg.css" type="text/css"/>
      <meta name="generator" content="DocBook XSL Stylesheets V1.72.0"/>
      <link rel="start" href="index.html" title="JBoss EJB3 Tutorials"/>
      <link rel="up" href="index.html" title="JBoss EJB3 Tutorials"/>
      <link rel="prev" href="Injecting_EJB_in_Servlets.html" title="Chapter 11. Introduction to EJB injection in Servlets"/>
      <link rel="next" href="Extended_Persistence_Contexts.html" title="Chapter 13. Introduction to Extended Persistence Contexts"/>
   </head>
   <body>
      <p id="title">
         <a href="http://www.jboss.org" class="jbossOrg_href">
            <strong>
						        JBoss.org	
						</strong>
         </a>
         <a href="http://labs.jboss.com/projects/docs" class="commDoc_href">
            <strong>
						        Community Documentation	
						</strong>
         </a>
      </p>
      <ul class="docnav">
         <li class="previous">
            <a accesskey="p" href="Injecting_EJB_in_Servlets.html">
               <strong>Prev</strong>
            </a>
         </li>
         <li class="next">
            <a accesskey="n" href="Extended_Persistence_Contexts.html">
               <strong>Next</strong>
            </a>
         </li>
      </ul>
      <div class="chapter" lang="en">
         <div class="titlepage">
            <div>
               <div>
                  <h2 class="title">
                     <a id="EJB3_Entities"/>Chapter 12. Introduction to Entities in EJB3</h2>
               </div>
            </div>
         </div>
         <p>
		Entity Beans of EJB2.x have been given a complete overhaul in EJB 3.0.
		Entity beans (or Entities, as they are now called) are plain Java objects that can be allocated
		with <code class="literal">new</code> and attached/detached/reattached to persistence storage.
		Entities are not remotable and must be accessed through the new <code class="literal">javax.persistence.EntityManager</code> service.
		JBoss's EJB 3.0 entity implementation is built on top of Hibernate.
	</p>
         <div class="sect5" lang="en">
            <div class="titlepage"/>
		O/R Mapping :
	</div>
         <p>
		First let's look at the example implementation of two related Entities.
		<code class="literal">org.jboss.tutorial.entity.bean.Order</code> and <code class="literal">org.jboss.tutorial.entity.bean.LineItem</code>.
		These two entities form a one-to-many relationship.
	</p>
         <p>
		The persistence determines the persistent properties by looking for all getter/setter method pairs.
		By default, all getter/setter methods will be treated as persistence properties.
	</p>
         <p>
		Defining an Entity is easy. First, annotate the class as an <code class="literal">@Entity</code>. In the minimum, you must at
		least define a primary key field using the <code class="literal">@Id</code> annotation.

		</p>
         <pre class="programlisting">
		
@Id @GeneratedValue
public int getId()
{
   return id;
}
		
		</pre>
         <p>
		
         </p>
         <div class="note">
            <h2>Note</h2>
            <p>
				Annotations must be defined on the getter method or on the field. However, you cannot have a mix of annotations
				on the field and on the methods. The following example where we are mapping the <code class="literal">name</code> through
				the field and mapping the <code class="literal">age</code> through the method is not allowed:

				</p>
            <pre class="programlisting">
					
@Entity
public class Employee implements java.io.Serializable
{

	@Id
	@GeneratedValue(strategy=GenerationType.AUTO)
	private long id;

	@Column (name="NAME")
	private String name;

	private int age;

	@Column (name="AGE")
	public int getAge()
	{
		return this.age
	}

	public String getName()
	{

	}
	// other getter/setters
}
					
				</pre>
            <p>
			
            </p>
         </div>
         <p>

		The <code class="literal">@Id</code> annotation tells the container that <code class="literal">id</code> is the primary key property.
		The <code class="literal">@GeneratedValue</code> tells that it should be automatically generated by the container.
		The table name is specified using the <code class="literal">@Table</code> annotation

		</p>
         <pre class="programlisting">
		
@Table(name = "PURCHASE_ORDER")
		
		</pre>
         <p>

		If the table name isn't specified it defaults to the simple name of the class. For instance, the LineItem entity would be
		mapped to the LINEITEM table.
	</p>
         <div class="sect5" lang="en">
            <div class="titlepage"/>
		One to Many Relationship :
	</div>
         <p>
		The Order bean also defines a one to many relationship.

		</p>
         <pre class="programlisting">
			
@OneToMany(cascade = CascadeType.ALL, fetch = FetchType.EAGER, mappedBy="order")
public Collection&lt;LineItem&gt; getLineItems()
{
   return lineItems;
}
			
		</pre>
         <p>
		Generics must be used so that the container can determine what the entity Order is related to.
		</p>
         <p>
			
            <code class="literal">CascadeType.ALL</code> specifies that when an Order is created, any LineItems held in the <code class="literal">lineItems</code>
			collection will be created as well (<code class="literal">CascadeType.PERSIST</code>). If the Order is deleted from persistence storage,
			all related LineItems will be deleted (<code class="literal">CascadeType.REMOVE</code>). If an Order instance is reattached to persistence
			storage, any changes to the LineItems collection will be merged with persistence storage (<code class="literal">CascadeType.MERGE</code>).
		</p>
         <p>

		
         </p>
         <p>
			
            <code class="literal">FetchType.EAGER</code> specifies that when the Order is loaded whether or not to pre-fetch the relationship as well.
			If you want the LineItems to be loaded on demand, then specify <code class="literal">FetchType.LAZY</code>.
		</p>
         <p>

		
         </p>
         <p>
			The <code class="literal">mappedBy</code> attribute specifies that this is a bi-directional relationship that is managed by the order property
			on the LineItem entity.
		</p>
         <p>

	
         </p>
         <div class="sect5" lang="en">
            <div class="titlepage"/>
		Many to One Relationship :
	</div>
         <p>
		
         </p>
         <pre class="programlisting">
			
@ManyToOne
@JoinColumn(name = "order_id")
public Order getOrder()
{
   return order;
}
		
		</pre>
         <p>

		The <code class="literal">@JoinColumn</code> specifies the foreign key column within the LineItem table.

	</p>
         <div class="sect5" lang="en">
            <div class="titlepage"/>
		EntityManager :
	</div>
         <p>
		The <code class="literal">org.jboss.tutorial.entity.bean.ShoppingCartBean</code> allocates and stores all instances
		of Orders and LineItems. If you look at the example you can see that ShoppingCart interacts with Order as a plain Java object.
		It allocates it with <code class="literal">new</code>. It can pass the Order back to the client. The <code class="literal">checkout()</code>
		method actually stores it with persistence storage by using the required EntityManager service.

		The EntityManager service is injected using field injection and the <code class="literal">@PersistenceContext</code> annotation.
		</p>
         <pre class="programlisting">
			
@PersistenceContext
private EntityManager manager;

			
		</pre>
         <p>

		The EntityManager is central to EJB 3.0 as there are no homes. The EntityManager is used to do querying, creating,
		find by primary key, and removal of entities in EJB3.
	</p>
         <div class="sect5" lang="en">
            <div class="titlepage"/>
Building and Running
	</div>
         <div class="note">
            <h2>Note</h2>
            <p>
	To build and run the example, make sure you have installed JBoss 5.x.
	See the <a href="JBossAS5.html" title="1.1. JBoss Application Server 5.x">Section 1.1, “JBoss Application Server 5.x”</a> for details.
			</p>
         </div>
         <p>
			From the command prompt, move to the "entity" folder under the <a href="EJB3_TUTORIAL_HOME.html" title="1.3. Set the EJB3_TUTORIAL_HOME">Section 1.3, “Set the EJB3_TUTORIAL_HOME”</a>
		
         </p>
         <div class="sect5" lang="en">
            <div class="titlepage"/>
Ant Users:
	</div>
         <p>
		Make sure your JBossAS-5.x is running
		</p>
         <pre class="programlisting">
	
$ ant
$ ant run

run:
     [java] Buying 2 memory sticks
     [java] Buying a laptop
     [java] Print cart:
     [java] Total: $3000.0
     [java] 2     Memory stick     1000.0
     [java] 1     Laptop     2000.0
     [java] Checkout

     
	</pre>
         <div class="sect5" lang="en">
            <div class="titlepage"/>
Maven Users: Make sure the AS is not running.
	</div>
         <pre class="programlisting">
$ mvn clean install -PRunSingleTutorial
	</pre>
         <div class="sect5" lang="en">
            <div class="titlepage"/>
View the tables and rows:
	</div>
         <p>
		You can view the tables created by JBoss by going to the
		<a xmlns:xlink="http://www.w3.org/1999/xlink" href="http://localhost:8080/jmx-console/HtmlAdaptor?action=inspectMBean&amp;name=jboss%3Aservice%3DHypersonic%2Cdatabase%3DlocalDB">Hypersonic Service</a>,
		scrolling down to the <code class="literal">startDatabaseManager</code> button and clicking it.
		A Hypersonic SQL window will be minimized, but you can open it up to look at the tables and do queries.

	</p>
      </div>
      <ul class="docnav">
         <li class="previous">
            <a accesskey="p" href="Injecting_EJB_in_Servlets.html">
               <strong>Prev</strong>Chapter 11. Introduction to EJB injection in Serv...</a>
         </li>
         <li class="up">
            <a accesskey="u" href="#">
               <strong>Top of page</strong>
            </a>
         </li>
         <li class="home">
            <a accesskey="h" href="index.html">
               <strong>Front page</strong>
            </a>
         </li>
         <li class="next">
            <a accesskey="n" href="Extended_Persistence_Contexts.html">
               <strong>Next</strong>Chapter 13. Introduction to Extended Persistence ...</a>
         </li>
      </ul>
   </body>
</html>