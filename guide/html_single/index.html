<?xml version="1.0" encoding="UTF-8" standalone="no"?>

<!DOCTYPE html
  PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
   <head>
      <title>JBoss EJB3 Tutorials</title>
      <link rel="stylesheet" href="css/jbossorg.css" type="text/css"/>
      <meta name="generator" content="DocBook XSL Stylesheets V1.72.0"/>
   </head>
   <body>
      <div class="book" lang="en">
         <div class="titlepage">
            <div>
               <p id="title">
                  <a href="http://www.jboss.org" class="jbossOrg_href">
                     <strong>
						        JBoss.org	
						</strong>
                  </a>
                  <a href="http://labs.jboss.com/projects/docs" class="commDoc_href">
                     <strong>
						        Community Documentation	
						</strong>
                  </a>
               </p>
               <div>
                  <h1 class="title">
                     <a id="d0e1"/>JBoss EJB3 Tutorials</h1>
               </div>
               <div>
                  <h2 class="subtitle">A guide for using EJB3 on JBoss</h2>
               </div>
               <div>
                  <div class="authorgroup">
                     <h3 class="corpauthor">Bill Burke</h3>
                     <h3 class="corpauthor">Jaikiran Pai</h3>
                  </div>
               </div>
               <div>
                  <p class="releaseinfo">1.0</p>
               </div>
            </div>
            <hr/>
         </div>
         <div class="toc">
            <dl>
               <dt>
                  <span class="preface">
                     <a href="#target">Target Audience</a>
                  </span>
               </dt>
               <dt>
                  <span class="chapter">
                     <a href="#Installation">1. Installation</a>
                  </span>
               </dt>
               <dd>
                  <dl>
                     <dt>
                        <span class="section">
                           <a href="#JBossAS5">1.1. JBoss Application Server 5.x</a>
                        </span>
                     </dt>
                     <dt>
                        <span class="section">
                           <a href="#AntOrMaven2">1.2. Ant or Maven2</a>
                        </span>
                     </dt>
                     <dt>
                        <span class="section">
                           <a href="#EJB3_TUTORIAL_HOME">1.3. Set the EJB3_TUTORIAL_HOME</a>
                        </span>
                     </dt>
                  </dl>
               </dd>
               <dt>
                  <span class="chapter">
                     <a href="#Stateless_Beans">2. Introduction to EJB3 Stateless Beans</a>
                  </span>
               </dt>
               <dt>
                  <span class="chapter">
                     <a href="#Stateful_Beans">3. Introduction to EJB3 Stateful Beans</a>
                  </span>
               </dt>
               <dt>
                  <span class="chapter">
                     <a href="#Blob_and_Clob_support_in_EJB3">4. Introduction to Blob and Clob support in EJB3</a>
                  </span>
               </dt>
               <dt>
                  <span class="chapter">
                     <a href="#Caching_EJB3_Entities">5. Caching EJB3 Entities</a>
                  </span>
               </dt>
               <dt>
                  <span class="chapter">
                     <a href="#Callbacks_and_Callback_Handlers">6. Introduction to Callbacks and Callback Handlers in EJB3</a>
                  </span>
               </dt>
               <dt>
                  <span class="chapter">
                     <a href="#Composite_Primary_Keys_for_Entities_in_EJB3">7. Introduction to Composite Primary Keys and Primary Key Classes</a>
                  </span>
               </dt>
               <dt>
                  <span class="chapter">
                     <a href="#Dependencies_in_EJB3">8. Introduction to specifying dependencies in EJB3 beans</a>
                  </span>
               </dt>
               <dt>
                  <span class="chapter">
                     <a href="#EJB_2.1_Client_Adaptors">9. Introduction to using EJB2.1 client adaptors with EJB3</a>
                  </span>
               </dt>
               <dt>
                  <span class="chapter">
                     <a href="#Embeddable_Objects_in_EJB3_Entities">10. Introduction to embedding objects in EJB3 entities</a>
                  </span>
               </dt>
               <dt>
                  <span class="chapter">
                     <a href="#Injecting_EJB_in_Servlets">11. Introduction to EJB injection in Servlets</a>
                  </span>
               </dt>
               <dt>
                  <span class="chapter">
                     <a href="#EJB3_Entities">12. Introduction to Entities in EJB3</a>
                  </span>
               </dt>
               <dt>
                  <span class="chapter">
                     <a href="#Extended_Persistence_Contexts">13. Introduction to Extended Persistence Contexts</a>
                  </span>
               </dt>
               <dt>
                  <span class="chapter">
                     <a href="#Dependency_Injection">14. Introduction to dependency injection</a>
                  </span>
               </dt>
               <dt>
                  <span class="chapter">
                     <a href="#EJB3_Interceptors">15. Introduction to EJB3 Interceptors</a>
                  </span>
               </dt>
               <dt>
                  <span class="chapter">
                     <a href="#jboss.xml_deployment_descriptor">16. Usage of JBoss specific deployment descriptors</a>
                  </span>
               </dt>
               <dt>
                  <span class="chapter">
                     <a href="#Quartz_scheduler_integration">17. Quartz scheduler integration</a>
                  </span>
               </dt>
               <dt>
                  <span class="chapter">
                     <a href="#JNDI_Bindings">18. Binding your beans in JNDI</a>
                  </span>
               </dt>
               <dt>
                  <span class="chapter">
                     <a href="#Join_Inheritance_in_EJB3_Entities">19. Introduction Join Inheritance in EJB3 Entities</a>
                  </span>
               </dt>
               <dt>
                  <span class="chapter">
                     <a href="#Message_Driven_Beans">20. Introduction to Message Driven Beans in EJB3</a>
                  </span>
               </dt>
               <dt>
                  <span class="chapter">
                     <a href="#Message_Driven_Beans_with_deployment_descriptor">21. Configuring Message Driven Beans through deployment descriptors</a>
                  </span>
               </dt>
               <dt>
                  <span class="chapter">
                     <a href="#Merging_and_Basic_Queries_on_entities">22. Introduction to merging and querying of entities in EJB3</a>
                  </span>
               </dt>
               <dt>
                  <span class="chapter">
                     <a href="#EJB2.1_and_EJB3_references">23. Referencing EJB3 beans in EJB2.1 and vice versa</a>
                  </span>
               </dt>
               <dt>
                  <span class="chapter">
                     <a href="#EJB3_Entity_Relationships">24. Introduction to relationships between EJB3 entities</a>
                  </span>
               </dt>
               <dt>
                  <span class="chapter">
                     <a href="#Using_resource_references_in_EJB3">25. Introduction to binding the resources to ENC of EJB3 beans</a>
                  </span>
               </dt>
               <dt>
                  <span class="chapter">
                     <a href="#Secondary_Tables_for_EJB3_Entities">26. Introduction to Secondary tables for EJB3 entities</a>
                  </span>
               </dt>
               <dt>
                  <span class="chapter">
                     <a href="#Security_and_Transactions_in_EJB3">27. Introduction to Security and Transactions in EJB3</a>
                  </span>
               </dt>
               <dt>
                  <span class="chapter">
                     <a href="#Service_POJOs">28. Service POJOs (JBoss extension of EJB3)</a>
                  </span>
               </dt>
               <dt>
                  <span class="chapter">
                     <a href="#Service_POJOs_through_deployment_descriptors">29. Service POJOs (JBoss extension of EJB3) using deployment descriptors</a>
                  </span>
               </dt>
               <dt>
                  <span class="chapter">
                     <a href="#Single_Inheritance_in_EJB3_Entities">30. Introduction Single Inheritance in EJB3 Entities</a>
                  </span>
               </dt>
               <dt>
                  <span class="chapter">
                     <a href="#Stateful_Session_Beans_in_EJB3_with_deployment_descriptors">31. Configuring Stateful Session Beans with deployment descriptors in EJB3</a>
                  </span>
               </dt>
               <dt>
                  <span class="chapter">
                     <a href="#Stateless_Session_Beans_in_EJB3_with_deployment_descriptors">32. Configuring Stateless Session Beans with deployment descriptors in EJB3</a>
                  </span>
               </dt>
               <dt>
                  <span class="chapter">
                     <a href="#Table_per_Class_inheritance_in_EJB3_Entities">33. Table per Class inheritance in EJB3 Entities</a>
                  </span>
               </dt>
               <dt>
                  <span class="chapter">
                     <a href="#Timer_service_in_EJB3">34. Introduction to timer service in EJB3</a>
                  </span>
               </dt>
               <dt>
                  <span class="chapter">
                     <a href="#Hibernate_Session_In_EJB3">35. Injecting Hibernate Session and Session Factory in JBoss EJB3</a>
                  </span>
               </dt>
               <dt>
                  <span class="chapter">
                     <a href="#Asynchronous_Invocations">36. Asynchronous proxy for EJBs - JBoss specific extension to EJB3</a>
                  </span>
               </dt>
               <dt>
                  <span class="chapter">
                     <a href="#Partial_deployment_descriptor">37. Partial Deployment Descriptors</a>
                  </span>
               </dt>
               <dt>
                  <span class="chapter">
                     <a href="#Consumer_and_Producer">38. Message Driven POJOs (JBoss specific)</a>
                  </span>
               </dt>
               <dt>
                  <span class="chapter">
                     <a href="#TODO">39. TODO</a>
                  </span>
               </dt>
               <dd>
                  <dl>
                     <dt>
                        <span class="section">
                           <a href="#Maven_Users_TODO">39.1. TODO - Provide better support for Maven</a>
                        </span>
                     </dt>
                  </dl>
               </dd>
            </dl>
         </div>
         <div class="preface" lang="en">
            <div class="titlepage">
               <div>
                  <div>
                     <h2 class="title">
                        <a id="target"/>Target Audience</h2>
                  </div>
               </div>
            </div>
            <p>This tutorial is meant for EJB3 application developers on JBoss Application Server. The tutorial walks you through the EJB 3.0 features and how they deploy to JBoss.  Please check the <a href="#Installation" title="Chapter 1. Installation">Chapter 1, <i xmlns:xlink="http://www.w3.org/1999/xlink">Installation</i>
               </a> for system requirements.</p>
         </div>
         <div class="chapter" lang="en">
            <div class="titlepage">
               <div>
                  <div>
                     <h2 class="title">
                        <a id="Installation"/>Chapter 1. Installation</h2>
                  </div>
               </div>
            </div>
            <div class="toc">
               <dl>
                  <dt>
                     <span class="section">
                        <a href="#JBossAS5">1.1. JBoss Application Server 5.x</a>
                     </span>
                  </dt>
                  <dt>
                     <span class="section">
                        <a href="#AntOrMaven2">1.2. Ant or Maven2</a>
                     </span>
                  </dt>
                  <dt>
                     <span class="section">
                        <a href="#EJB3_TUTORIAL_HOME">1.3. Set the EJB3_TUTORIAL_HOME</a>
                     </span>
                  </dt>
               </dl>
            </div>
            <div class="section" lang="en">
               <div class="titlepage">
                  <div>
                     <div>
                        <h2 class="title">
                           <a id="JBossAS5"/>1.1. JBoss Application Server 5.x</h2>
                     </div>
                  </div>
               </div>
               <p>
You must set the JBOSS_HOME environment variable to run any of the tutorial examples.

				</p>
               <pre class="programlisting">
Unix:    $ export JBOSS_HOME=&lt;where your jboss 5.x distribution is&gt;
Windows: $ set JBOSS_HOME=&lt;where your jboss 5.x distribution is&gt;
				</pre>
               <p>

To run these examples you need JBossAS 5.0.1 GA or higher version (if available). JBossAS can be downloaded from <a xmlns:xlink="http://www.w3.org/1999/xlink" href="http://www.jboss.org/jbossas/downloads/">here</a>.

			</p>
            </div>
            <div class="section" lang="en">
               <div class="titlepage">
                  <div>
                     <div>
                        <h2 class="title">
                           <a id="AntOrMaven2"/>1.2. Ant or Maven2</h2>
                     </div>
                  </div>
               </div>
               <p>
The tutorials can be built with either Ant (version 1.7) or Maven (version 2.0.9). Depending on which build tool you want to use, you will have to download it from their sites.
			</p>
            </div>
            <div class="section" lang="en">
               <div class="titlepage">
                  <div>
                     <div>
                        <h2 class="title">
                           <a id="EJB3_TUTORIAL_HOME"/>1.3. Set the EJB3_TUTORIAL_HOME</h2>
                     </div>
                  </div>
               </div>
               <p>
				For easy reference throughout the tutorials, we use the EJB3_TUTORIAL_HOME which points to the top level folder where
				you downloaded the tutorials. Set it appropriately:
				</p>
               <pre class="programlisting">
Unix:    $ export EJB3_TUTORIAL_HOME=&lt;where your EJB3 tutorial is&gt;
Windows: $ set EJB3_TUTORIAL_HOME=&lt;where your EJB3 tutorial is&gt;
				</pre>
               <p>


			
               </p>
            </div>
         </div>
         <div class="chapter" lang="en">
            <div class="titlepage">
               <div>
                  <div>
                     <h2 class="title">
                        <a id="Stateless_Beans"/>Chapter 2. Introduction to EJB3 Stateless Beans</h2>
                  </div>
               </div>
            </div>
            <p>
It is very easy to create a Stateless Bean with EJB 3.0.  All bean types are homeless in EJB 3.0 so all you have to do to
create a Stateless bean is to create a bean class and have it implement at least one interface. Take a look at
<code class="literal">org.jboss.tutorial.stateless.bean.CalculatorBean</code>

	
            </p>
            <p>
The first thing to notice is that the class is tagged as <code class="literal">@Stateless</code>.  This marks the class as a stateless bean and
the deployer will deploy that class as a stateless bean EJB container.
	</p>
            <p>
CalculatorBean also implements two interfaces.  One is the remote interface of the EJB the other is the local interface.
	</p>
            <p>
Take a look at <code class="literal">org.jboss.tutorial.stateless.bean.CalculatorRemote</code>.
To define this as the remote interface of Calculator bean
you either annotate the bean class and specify what the remote interfaces are, or you annotate each remote interface the bean class
implements with @javax.ejb.Remote. only need to annotate the bean class with <code class="literal">@javax.ejb.Remote</code>.
Similar for <code class="literal">org.jboss.tutorial.stateless.bean.CalculatorLocal</code> as you need to annotate the bean
class with <code class="literal">@javax.ejb.Local</code> for it to be the local interface of the CalculatorBean.
	</p>
            <p>
		
            </p>
            <div class="sect5" lang="en">
               <div class="titlepage"/>
JNDI Bindings
		</div>
            <p>
The Calculator bean will have two JNDI bindings for the remote and Local interface.
By default, JBoss will use ejbName/local and ejbName/remote for the local and remote interfaces, respectively.
	</p>
            <p>
		
            </p>
            <div class="sect5" lang="en">
               <div class="titlepage"/>
Client
		</div>
            <p>
Open up <code class="literal">org.jboss.tutorial.stateless.client.Client</code>.
You'll see that it looks up the stateless bean under "ejbName/remote". Also notice that there is no Home interface and
you can begin executing on the stateless bean right away.

	</p>
            <p>
		
            </p>
            <div class="sect5" lang="en">
               <div class="titlepage"/>
Building and Running
		</div>
            <p>

		
            </p>
            <div class="note">
               <h2>Note</h2>
               <p>
To build and run the example, make sure you have installed JBoss 5.x.
See the <a href="#JBossAS5" title="1.1. JBoss Application Server 5.x">Section 1.1, “JBoss Application Server 5.x”</a> for details.
			</p>
            </div>
            <p>
		
            </p>
            <p>
			From the command prompt, move to the "stateless" folder under the <a href="#EJB3_TUTORIAL_HOME" title="1.3. Set the EJB3_TUTORIAL_HOME">Section 1.3, “Set the EJB3_TUTORIAL_HOME”</a>
		
            </p>
            <p>
		
            </p>
            <div class="sect5" lang="en">
               <div class="titlepage"/>
Ant Users:
		</div>
            <p>
		
            </p>
            <p>
		Make sure your JBossAS-5.x is running
		</p>
            <p>
	
            </p>
            <pre class="programlisting">
$ ant
$ ant run

	</pre>
            <p>

	
            </p>
            <div class="sect5" lang="en">
               <div class="titlepage"/>
Maven Users: Make sure the AS is not running.
	</div>
            <p>

	
            </p>
            <pre class="programlisting">
$ mvn clean install -PRunSingleTutorial
	</pre>
            <p>

	
            </p>
         </div>
         <div class="chapter" lang="en">
            <div class="titlepage">
               <div>
                  <div>
                     <h2 class="title">
                        <a id="Stateful_Beans"/>Chapter 3. Introduction to EJB3 Stateful Beans</h2>
                  </div>
               </div>
            </div>
            <p>
	It is very easy to create a Stateful Bean with EJB 3.0. All bean types are homeless in EJB 3.0 so all you have to do to create a
	Stateful bean is to create a bean class and have it implement at least one interface.
	Take a look at <code class="literal">org.jboss.tutorial.stateful.bean.ShoppingCartBean</code> in the tutorial.
	</p>
            <p>
	The first thing to notice is that the class is tagged as <code class="literal">@Stateful</code>. This marks the class as a stateful bean and
	the deployer will deploy that class as a stateful bean EJB container.
	</p>
            <p>
	ShoppingCartBean also implements a remote interface. Take a look at <code class="literal">org.jboss.tutorial.stateful.bean.ShoppingCart</code>
	
            </p>
            <p>
		
            </p>
            <div class="sect5" lang="en">
               <div class="titlepage"/>
@Remove
		</div>
            <p>
	Take another look at <code class="literal">org.jboss.tutorial.stateful.bean.ShoppingCartBean</code>.
	Look for the method annotated as @Remove. Instead of explicitly calling EJBObject.remove() in your applications and thus polluting it
	further with J2EE specific code, any method tagged with @Remove will cause the stateful bean instance to be removed from the container
	at the end of the method call.
	</p>
            <p>
		
            </p>
            <div class="sect5" lang="en">
               <div class="titlepage"/>
JNDI Bindings
		</div>
            <p>
	The ShoppingCartBean will have its remote interface bound in JNDI, by default, under the ejbName/local and/or ejbName/remote for
	the local and remote interfaces, respectively.
	</p>
            <p>
		
            </p>
            <div class="sect5" lang="en">
               <div class="titlepage"/>
Client
		</div>
            <p>
	Open up <code class="literal">org.jboss.tutorial.stateful.client.Client</code>.
  	You'll see that it looks up the stateful bean under "ejbName/remote". Also notice that there is no Home interface and you can begin
  	executing on the stateful bean right away. When you access the bean in JNDI, an instance of the stateful bean will be created on the server.
  	So, when you need a different instance of the stateful bean, you do an additional jndi.lookup() to get this new reference.

	</p>
            <p>
		
            </p>
            <div class="sect5" lang="en">
               <div class="titlepage"/>
Building and Running
		</div>
            <p>

		
            </p>
            <div class="note">
               <h2>Note</h2>
               <p>
			To build and run the example, make sure you have installed JBoss 5.x.
			See the <a href="#JBossAS5" title="1.1. JBoss Application Server 5.x">Section 1.1, “JBoss Application Server 5.x”</a> for details.
			</p>
            </div>
            <p>
		
            </p>
            <p>
			From the command prompt, move to the "stateful" folder under the <a href="#EJB3_TUTORIAL_HOME" title="1.3. Set the EJB3_TUTORIAL_HOME">Section 1.3, “Set the EJB3_TUTORIAL_HOME”</a>
		
            </p>
            <p>
		
            </p>
            <div class="sect5" lang="en">
               <div class="titlepage"/>
Ant Users:
		</div>
            <p>
		
            </p>
            <p>
		Make sure your JBossAS-5.x is running
		</p>
            <p>
	
            </p>
            <pre class="programlisting">
$ ant
$ ant run

	</pre>
            <p>

	
            </p>
            <div class="sect5" lang="en">
               <div class="titlepage"/>
Maven Users: Make sure the AS is not running.
	</div>
            <p>

	
            </p>
            <pre class="programlisting">
$ mvn clean install -PRunSingleTutorial
	</pre>
            <p>

	
            </p>
         </div>
         <div class="chapter" lang="en">
            <div class="titlepage">
               <div>
                  <div>
                     <h2 class="title">
                        <a id="Blob_and_Clob_support_in_EJB3"/>Chapter 4. Introduction to Blob and Clob support in EJB3</h2>
                  </div>
               </div>
            </div>
            <p>
	The EJB 3.0 specification has support for Blob and Clob types.  The specification allows you to map the following types to
an entity property:
		</p>
            <div class="itemizedlist">
               <ul>
                  <li>
                     <p>
					
                        <code class="literal">java.sql.Blob</code>
				
                     </p>
                  </li>
                  <li>
                     <p>
					
                        <code class="literal">java.sql.Clob</code>
				
                     </p>
                  </li>
                  <li>
                     <p>
					Any Serializable Object
				</p>
                  </li>
                  <li>
                     <p>
					byte[], Byte[]
				</p>
                  </li>
                  <li>
                     <p>
					char[], String, Character[]
				</p>
                  </li>
               </ul>
            </div>
            <p>
	
            </p>
            <p>
	To use this feature just need to use the <code class="literal">@javax.persistence.Lob</code> annotation. The <code class="literal">Lob</code> annotation is an
	encapsulation of what type of lob you want.  Below is an example of defining fields in an entity that are blobs or clobs.

		</p>
            <pre class="programlisting">
@Entity
public class BlobEntity implements Serializable
{
   private long id;
   private Blob blobby;
   private Clob clobby;

   @Id @GeneratedValue(strategy=GenerationType.IDENTITY)
   public long getId()
   {
      return id;
   }

   public void setId(long id)
   {
      this.id = id;
   }

   @Lob @Basic(fetch = FetchType.EAGER)
   public Blob getBlobby()
   {
      return blobby;
   }

   public void setBlobby(Blob blobby)
   {
      this.blobby = blobby;
   }

   @Lob @Basic(fetch = FetchType.EAGER)
   public Clob getClobby()
   {
      return clobby;
   }

   public void setClobby(Clob clobby)
   {
      this.clobby = clobby;
   }


}
		</pre>
            <p>
	
            </p>
            <div class="sect5" lang="en">
               <div class="titlepage"/>
Working with Blobs and Clobs:
	</div>
            <p>
Open up <code class="literal">org.jboss.tutorial.blob.bean.LobTesterBean</code> and look for the <code class="literal">create()</code> method. JBoss EJB3
is built on top of the Hibernate persistence engine.  Hibernate has some helper methods for creating blobs and clobs that {{LobTesterBean}}
uses.
	</p>
            <div class="sect5" lang="en">
               <div class="titlepage"/>
Blob creation:
	</div>
            <p>
		
               <code class="literal">org.hibernate.Hibernate.createBlob(byte[] bytes)</code>
		
               <code class="literal">org.hibernate.Hibernate.createBlob(InputStream stream, int length)</code>
		
               <code class="literal">org.hibernate.Hibernate.createBlob(InputStream stream)</code>
	
            </p>
            <div class="sect5" lang="en">
               <div class="titlepage"/>
Clob creation:
	</div>
            <p>
		
               <code class="literal">org.hibernate.Hibernate.createClob(String string)</code>
		
               <code class="literal">org.hibernate.Hibernate.createClob(Reader reader, int length)</code>
	
            </p>
            <p>
		Blobs and clobs must only be accessed within a transaction.  Blobs and clobs are also not serializable or detachable.
	</p>
            <div class="sect5" lang="en">
               <div class="titlepage"/>
Mapping Strings/byte[] to Clob/Blob:
	</div>
            <p>
		This is pretty easy, just look at BlobEntity2.java

		</p>
            <pre class="programlisting">
@Entity
public class BlobEntity2 implements Serializable
{
   private long id;
   private byte[] blobby;
   private String clobby;

   @Id @GeneratedValue(strategy=GenerationType.AUTO)
   public long getId()
   {
      return id;
   }

   public void setId(long id)
   {
      this.id = id;
   }

   @Lob @Basic(fetch = FetchType.EAGER)
   public byte[] getBlobby()
   {
      return blobby;
   }

   public void setBlobby(byte[] blobby)
   {
      this.blobby = blobby;
   }

   @Lob @Basic(fetch = FetchType.EAGER)
   public String getClobby()
   {
      return clobby;
   }

   public void setClobby(String clobby)
   {
      this.clobby = clobby;
   }


}

		</pre>
            <p>

	
            </p>
            <p>
		
            </p>
            <div class="sect5" lang="en">
               <div class="titlepage"/>
Building and Running:
		</div>
            <p>

		
            </p>
            <div class="note">
               <h2>Note</h2>
               <p>
	To build and run the example, make sure you have installed JBoss 5.x.
	See the <a href="#JBossAS5" title="1.1. JBoss Application Server 5.x">Section 1.1, “JBoss Application Server 5.x”</a> for details.
			</p>
            </div>
            <p>
		From the command prompt, move to the "blob" folder under the <a href="#EJB3_TUTORIAL_HOME" title="1.3. Set the EJB3_TUTORIAL_HOME">Section 1.3, “Set the EJB3_TUTORIAL_HOME”</a>
		
            </p>
            <div class="sect5" lang="en">
               <div class="titlepage"/>
Ant Users:
		</div>
            <p>
		
            </p>
            <p>
		Make sure your JBossAS-5.x is running
		</p>
            <p>
	
            </p>
            <pre class="programlisting">
$ ant
$ ant run

	</pre>
            <p>

	
            </p>
            <div class="sect5" lang="en">
               <div class="titlepage"/>
Maven Users: Make sure the AS is not running.
	</div>
            <p>

	
            </p>
            <pre class="programlisting">
$ mvn clean install -PRunSingleTutorial
	</pre>
            <p>

	
            </p>
            <div class="sect5" lang="en">
               <div class="titlepage"/>
View the tables and rows:
	</div>
            <p>
		You can view the tables created by JBoss by going to the
		<a xmlns:xlink="http://www.w3.org/1999/xlink" href="http://localhost:8080/jmx-console/HtmlAdaptor?action=inspectMBean&amp;name=jboss%3Aservice%3DHypersonic%2Cdatabase%3DlocalDB">Hypersonic Service</a>,
		scrolling down to the <code class="literal">startDatabaseManager</code> button and clicking it.
		A Hypersonic SQL window will be minimized, but you can open it up to look at the tables and do queries.

	</p>
         </div>
         <div class="chapter" lang="en">
            <div class="titlepage">
               <div>
                  <div>
                     <h2 class="title">
                        <a id="Caching_EJB3_Entities"/>Chapter 5. Caching EJB3 Entities</h2>
                  </div>
               </div>
            </div>
            <p>
		This tutorial shows you how to cache your entities using EJB 3.0 for JBoss

	</p>
            <div class="sect5" lang="en">
               <div class="titlepage"/>
		Caching primer :

		<p>
			To avoid roundtrips to the database, you can use a cache for your entities.
			JBoss EJB3 uses Hibernate as the JPA implementation which has support for a second-level cache.
			The Hibernate setup used for our JBoss EJB 3.0 implementation uses JBossCache as its underlying cache
			implementation. With caching enabled:

			</p>
               <div class="itemizedlist">
                  <ul>
                     <li>
					If you persist an entity (that has caching enabled) to the database via the entity manager
					the entity will also be added to the cache. Subsequent requests to fetch the entity, with
					this id, will be retrieved from cache and thus will save a database trip.
				</li>
                     <li>
					If you update an entity (that has caching enabled) and save the changes to the database via
					the entity manager the entity will also be updated in the cache.
				</li>
                     <li>
					If you remove an entity (that has caching enabled) from the database via the entity manager
					the entity will also be removed from the cache.
				</li>
                  </ul>
               </div>
               <p>
			JBossCache allows you to specify timeouts to cached entities. Entities not accessed within a certain
			amount of time are dropped from the cache in order to save memory.
		</p>
               <p>
			Furthermore, JBossCache supports clustering. If running within a cluster, and the cache is updated,
			changes to the entries in one node will be replicated to the corresponding entries in the other nodes
			in the cluster.
		</p>
            </div>
            <div class="sect5" lang="en">
               <div class="titlepage"/>
		Enabling caching and choosing cache :
		<p>
			Take a look at <code class="literal">META-INF/persistence.xml</code> which sets up the caching for this deployment:
			</p>
               <pre class="programlisting">
				
&lt;property name="hibernate.cache.use_second_level_cache" value="true"/&gt;
&lt;property name="hibernate.cache.use_query_cache" value="true"/&gt;
&lt;property name="hibernate.cache.region.factory_class" value="org.hibernate.cache.jbc2.JndiMultiplexedJBossCacheRegionFactory"/&gt;
&lt;property name="hibernate.cache.region.jbc2.cachefactory" value="java:CacheManager"/&gt;
&lt;property name="hibernate.cache.region.jbc2.cfg.entity" value="mvcc-entity"/&gt;
&lt;property name="hibernate.cache.region.jbc2.cfg.query" value="local-query"/&gt;
&lt;property name="hibernate.show_sql" value="true"/&gt;
				
			</pre>
               <p>
			
               </p>
               <div class="note">
                  <h2>Note</h2>
				These properties in the persistence.xml enabling caching and also configure JBossCache as the Cache manager.
				For more details about JBossCache and its configurations, have a look at the JBossCache project documentation.
			</div>
               <p>

			
               </p>
               <div class="note">
                  <h2>Note</h2>
				We have intentionally set the <code class="literal">hibernate.show_sql</code> property in the persistence.xml to true.
				When this property is set, Hibernate will print to STDOUT the sql queries that are fired to the database, when
				the entity is being operated upon. This will, later on, help us in verifying whether the entity is being picked up
				from cache or is being loaded from database through a SQL query.
			</div>
               <p>
		
               </p>
            </div>
            <div class="sect5" lang="en">
               <div class="titlepage"/>
		Entities:

		<p>
			You define your entities <code class="literal">org.jboss.tutorial.cachedentity.bean.Customer</code> and <code class="literal">org.jboss.tutorial.cachedentity.bean.Contact</code> the normal way.
			The default behaviour is to not cache anything, even with the settings shown above, in the persistence.xml.
			A very simplified rule of thumb is that you will typically want to do caching for objects that rarely change,
			and which are frequently read. We also annotate the classes with the <code class="literal">@Cache</code> annotation to
			indicate that the entities should be cached.
			</p>
               <pre class="programlisting">
				
@Entity
@Cache (usage=CacheConcurrencyStrategy.TRANSACTIONAL)
public class Customer implements java.io.Serializable
{
...
				
			</pre>
               <p>

			
               </p>
               <pre class="programlisting">
				
@Entity
@Cache (usage=CacheConcurrencyStrategy.TRANSACTIONAL)
public class Contact implements Serializable
{
...

				
			</pre>
               <p>
			This defines that the Customer and the Contact entities need to be cached. Any attempt to look up
			<code class="literal">Customer</code> or <code class="literal">Contact</code> by their primary key, will first attempt
			to read the entry from the cache. If it cannot be found it will try and load it up from the database.
		</p>
               <p>
			You can also cache relationship collections. Any attempt to access the <code class="literal">contacts</code> collection of
			<code class="literal">Customer</code> will attempt to load the data from the cache before hitting the database:
			</p>
               <pre class="programlisting">
				

@Entity
@Cache (usage=CacheConcurrencyStrategy.TRANSACTIONAL)
public class Customer implements java.io.Serializable
{
...

   @Cache (usage=CacheConcurrencyStrategy.TRANSACTIONAL)
   @OneToMany(mappedBy="customer", fetch=FetchType.EAGER, cascade=CascadeType.ALL)
   public Set&lt;Contact&gt; getContacts()
   {
      return contacts;
   }
...
}
				

			</pre>
               <p>

		
               </p>
            </div>
            <div class="sect5" lang="en">
               <div class="titlepage"/>
		Client :
		<p>
			Open <code class="literal">org.jboss.tutorial.cachedentity.client.CachedEntityRun</code>. It takes two arguments, they are the
			server:jndiport of the two nodes to use. If you look at the 'run' target of <code class="literal">META-INF/build.xml</code>
			you will see that they both default to localhost:1099, so in this case node1 and node2 will be the same,
			i.e. no clustering takes place.
		</p>
            </div>
            <div class="sect5" lang="en">
               <div class="titlepage"/>

Building and Running
	<p>
			
               </p>
               <div class="note">
                  <h2>Note</h2>
                  <p>
						To build and run the example, make sure you have installed JBoss 5.x.
						See the <a href="#JBossAS5" title="1.1. JBoss Application Server 5.x">Section 1.1, “JBoss Application Server 5.x”</a> for details.
					</p>
               </div>
               <p>
			From the command prompt, move to the "cachedentity" folder under the <a href="#EJB3_TUTORIAL_HOME" title="1.3. Set the EJB3_TUTORIAL_HOME">Section 1.3, “Set the EJB3_TUTORIAL_HOME”</a>
			
               </p>
               <div class="sect5" lang="en">
                  <div class="titlepage"/>
		Ant Users:
			</div>
               <p>
				
               </p>
               <p>
				Make sure the "all" server configuration of JBossAS-5.x is running
				</p>
               <p>
			
               </p>
               <pre class="programlisting">
			
$ ant
$ ant run

run:
     [java] Saving customer to node1 = localhost:1099
     [java] Looking for customer on node2 = localhost:1099 (should be available in cache)
     [java] Found customer on node2 (cache). Customer details follow:
     [java] Customer: id=1; name=JBoss
     [java]     Contact: id=2; name=Kabir
     [java]     Contact: id=1; name=Bill

		     
			</pre>
               <p>

			
               </p>
               <div class="sect5" lang="en">
                  <div class="titlepage"/>
		Maven Users: Make sure the AS is not running.
	        </div>
               <p>

	
               </p>
               <pre class="programlisting">
$ mvn clean install -PRunSingleTutorial

			</pre>
               <p>

		
               </p>
            </div>
            <p>
		On the server you will notice these logs:
		</p>
            <pre class="programlisting">
			
02:14:04,528 INFO  [STDOUT] Hibernate: insert into Customer (id, name) values (null, ?)
02:14:04,529 INFO  [STDOUT] Hibernate: call identity()
02:14:04,542 INFO  [STDOUT] Hibernate: insert into Contact (id, CUST_ID, name, tlf) values (null, ?, ?, ?)
02:14:04,543 INFO  [STDOUT] Hibernate: call identity()
02:14:04,544 INFO  [STDOUT] Hibernate: insert into Contact (id, CUST_ID, name, tlf) values (null, ?, ?, ?)
02:14:04,545 INFO  [STDOUT] Hibernate: call identity()
02:14:04,545 INFO  [EntityTestBean] Created customer named JBoss with 2 contacts
02:14:04,634 INFO  [EntityTestBean] Find customer with id = 1
02:14:04,645 INFO  [STDOUT] Hibernate: select customer0_.id as id0_1_, customer0_.name as name0_1_, contacts1_.CUST_ID as CUST4_3_, contacts1_.id as id3_, contacts1_.id as id1_0_, contacts1_.CUST_ID as CUST4_1_0_, contacts1_.name as name1_0_, contacts1_.tlf as tlf1_0_ from Customer customer0_ left outer join Contact contacts1_ on customer0_.id=contacts1_.CUST_ID where customer0_.id=?
02:14:04,682 INFO  [EntityTestBean] Customer with id = 1 found
02:14:04,756 INFO  [EntityTestBean] Find customer with id = 1
02:14:04,801 INFO  [EntityTestBean] Customer with id = 1 found

			

		</pre>
            <p>
		As you can see, the first time the customer with id = 1 was being requested through the entity manager, a database query was fired to
		fetch it, since it was not available in cache. The Customer object was then loaded from the database and stored in the cache. As can be
		seen in the next request to fetch the customer with the same id. This request to the entity manager, pulls up the entity from the cache
		instead of firing a database query.
	</p>
         </div>
         <div class="chapter" lang="en">
            <div class="titlepage">
               <div>
                  <div>
                     <h2 class="title">
                        <a id="Callbacks_and_Callback_Handlers"/>Chapter 6. Introduction to Callbacks and Callback Handlers in EJB3</h2>
                  </div>
               </div>
            </div>

		The EJB 3.0 specification defines some callbacks, and allows you to handle these by implementing your own callback handlers.
		The callbacks defined for each bean are shown below:
		<div class="itemizedlist">
               <ul>
                  <li>
                     <p>
					Stateless session bean callbacks
					</p>
                     <div class="itemizedlist">
                        <ul>
                           <li>
                              <code class="literal">PostConstruct</code> - is invoked when the bean is first created, after any dependency injection is done.
						</li>
                           <li>
                              <code class="literal">PreDestroy</code> - is invoked when the bean is removed from the pool or destroyed.
						</li>
                        </ul>
                     </div>
                     <p>
				
                     </p>
                  </li>
                  <li>
                     <p>
					Message-driven bean callbacks
					</p>
                     <div class="itemizedlist">
                        <ul>
                           <li>
                              <code class="literal">PostConstruct</code> - is invoked when the bean is first created, after any dependency injection is done.
						</li>
                           <li>
                              <code class="literal">PreDestroy</code> - is invoked when the bean is removed from the pool or destroyed.
						</li>
                        </ul>
                     </div>
                     <p>
				
                     </p>
                  </li>
                  <li>
                     <p>
					Stateful session bean callbacks
					</p>
                     <div class="itemizedlist">
                        <ul>
                           <li>
                              <code class="literal">PostConstruct</code> - is invoked when the bean is first created, after any dependency injection is done.
						</li>
                           <li>
                              <code class="literal">PreDestroy</code> - is invoked when the bean is removed from the pool or destroyed.
								It will happen before any <code class="literal">@Remove</code> annotated method is invoked.
						</li>
                           <li>
                              <code class="literal">PostActivate</code>
                           </li>
                           <li>
                              <code class="literal">PrePassivate</code>
                           </li>
                        </ul>
                     </div>
                     <p>
				
                     </p>
                  </li>
                  <li>
                     <p>
					Entity bean callbacks
					</p>
                     <div class="itemizedlist">
                        <ul>
                           <li>
                              <code class="literal">PrePersist</code> - Is invoked right before the entity is created in the database.
								Will cascade to all entities to which this operation is cascaded.
						</li>
                           <li>
                              <code class="literal">PostPersist</code> - Is invoked right after the entity is created in the database.
								Will cascade to all entities to which this operation is cascaded.
						</li>
                           <li>
                              <code class="literal">PreRemove</code> - Is invoked right before the entity is deleted in the database.
								Will cascade to all entities to which this operation is cascaded.
						</li>
                           <li>
                              <code class="literal">PostRemove</code> - Is invoked right after the entity is deleted in the database.
								Will cascade to all entities to which this operation is cascaded.
						</li>
                           <li>
                              <code class="literal">PreUpdate</code> - Takes place right before the database is updated.
						</li>
                           <li>
                              <code class="literal">PostUpdate</code> - Takes place immediately after the database has been updated.
						</li>
                           <li>
                              <code class="literal">PostLoad</code> - Takes place right after data has been loaded
								from the database and associated with the entity
						</li>
                        </ul>
                     </div>
                     <p>
					The callbacks are not compulsory, and you can define the ones you want to handle.
				</p>
                  </li>
               </ul>
            </div>
            <div class="sect5" lang="en">
               <div class="titlepage"/>
			Using callbacks on the bean class:
		</div>
            <p>
			You use the callbacks listed above by annotating methods in the bean class.
			The annotations live in the <code class="literal">javax.ejb</code> package so for example <code class="literal">PostConstruct</code>
			would be <code class="literal">javax.ejb.PostConstruct</code>. You can call the methods what you like, but their method signature
			must return a void and take no arguments. Look at the <code class="literal">org.jboss.tutorial.callback.bean.CustomerDAOBean</code>
			stateless session bean and you will see that the <code class="literal">preDestroyCallback()</code> method has been annotated with
			<code class="literal">@javax.ejb.PreDestroy</code>. For session/message-driven beans, just like for interceptors, if the bean class
			extends another class any callback annotated methods on the super class will be invoked first.
		</p>
            <div class="sect5" lang="en">
               <div class="titlepage"/>
			Entity listeners for entity beans:
		</div>
            <p>
			You can also separate out the callbacks for entity beans into a separate EntityListener class. Take a look at the
			<code class="literal">org.jboss.tutorial.callback.bean.Customer</code> entity bean, and you will see that the class has been annotated with
			<code class="literal">@javax.persistence.EntityListener("org.jboss.tutorial.callback.bean.CustomerCallbackListener")</code>.
			This specifies that the <code class="literal">org.jboss.tutorial.callback.bean.CustomerCallbackListener</code> class should be used as
			the callback listener class for the bean. Now open <code class="literal">org.jboss.tutorial.callback.bean.CustomerCalbackListener</code>
			and you will see that the class annotates the callback methods in the same way as when defining callbacks on the bean class itself.
			However, one __important difference__ is that callback methods defined in a listener class must take a single argument, which will
			be the bean we are working with. The parameter must be of type <code class="literal">java.lang.Object</code>, or the actual bean type.
		</p>
            <div class="sect5" lang="en">
               <div class="titlepage"/>
			Interceptors for session/message-driven beans:
		</div>
            <p>
			Callbacks for session beans can also be put into a separate class, configured as an interceptor.
			This means that your interceptors can initialise themselves when constructed. The lifecycle methods in an interceptor
			must have the following signature:

			</p>
            <pre class="programlisting">Object &lt;any method name&gt;(InvocationContext)</pre>
            <p>
			
               <code class="literal">org.jboss.tutorial.callback.bean.CustomerDAOBean</code> specifies that it wants to use an external interceptor.
			</p>
            <pre class="programlisting">
@Stateless
@Remote(CustomerDAO.class)
@Interceptors({LifecycleInterceptor.class})
public class CustomerDAOBean implements CustomerDAO
{
   ...
}
			</pre>
            <p>

			and <code class="literal">org.jboss.tutorial.callback.bean.LifecycleInterceptor</code> has a <code class="literal">@PostConstruct</code> annotated method.
			As shown, each interceptor lifecycle method must call <code class="literal">proceed</code> on the InvocationContext to invoke
			the next interceptor. Interceptors may contain both the <code class="literal">@AroundInvoke</code> methods for intercepting
			business methods, and lifecycle methods. If you want to configure lifecycle methods for your interceptors with xml,
			you will need to do this in the <code class="literal">interceptor</code> section of ejb-jar.xml, and the keywords are
			<code class="literal">post-construct-method</code>, <code class="literal">post-activate-method</code>, <code class="literal">pre-passivate-method</code>
			and <code class="literal">pre-destry-method</code>. For example:

			</p>
            <pre class="programlisting">
&lt;ejb-jar&gt;
   &lt;interceptors&gt;
      &lt;interceptor&gt;
         &lt;interceptor-class&gt;org.acme.SomeInterceptor&lt;/interceptor-class&gt;
         &lt;around-invoke-method&gt;
            &lt;method-name&gt;interceptorMethod&lt;/method-name&gt;
         &lt;/around-invoke-method&gt;
         &lt;post-construct-method&gt;
            &lt;method-name&gt;sendCancelMessage&lt;/method-name&gt;
         &lt;/post-construct-method&gt;
         &lt;pre-destroy-method&gt;
            &lt;method-name&gt;sendCancelMessage&lt;/method-name&gt;
         &lt;/pre-destroy-method&gt;
      &lt;/interceptor&gt;
   &lt;/interceptors&gt;
&lt;/ejb-jar&gt;

			</pre>
            <p>

			Interceptor methods for handling lifecycle events follow exactly the same ordering and inheritance rules as business method
			interceptor methods, and an interceptor instance follows the lifecycle of the bean instance it is bound to.

		</p>
            <p>
		
            </p>
            <div class="sect5" lang="en">
               <div class="titlepage"/>
Building and Running
		</div>
            <p>

		
            </p>
            <div class="note">
               <h2>Note</h2>
               <p>
	To build and run the example, make sure you have installed JBoss 5.x.
	See the <a href="#JBossAS5" title="1.1. JBoss Application Server 5.x">Section 1.1, “JBoss Application Server 5.x”</a> for details.
			</p>
            </div>
            <p>
		
            </p>
            <p>
			From the command prompt, move to the "callbacks" folder under the <a href="#EJB3_TUTORIAL_HOME" title="1.3. Set the EJB3_TUTORIAL_HOME">Section 1.3, “Set the EJB3_TUTORIAL_HOME”</a>
		
            </p>
            <p>
		
            </p>
            <div class="sect5" lang="en">
               <div class="titlepage"/>
Ant Users:
		</div>
            <p>
		
            </p>
            <p>
		Make sure your JBossAS-5.x is running
		</p>
            <p>
	
            </p>
            <pre class="programlisting">
$ ant
$ ant run

run:
     [java] Create Bill Burke and Monica Smith
     [java] Bill and Monica get married
     [java] Get all the Burkes
     [java] There are now 2 Burkes
     [java] Bill and Monica are moving abroad
	</pre>
            <p>

	
            </p>
            <div class="sect5" lang="en">
               <div class="titlepage"/>
Maven Users: Make sure the AS is not running.
	</div>
            <p>

	
            </p>
            <pre class="programlisting">
$ mvn clean install -PRunSingleTutorial
	</pre>
            <p>

In the jboss console window you should see:

	</p>
            <pre class="programlisting">
23:52:11,162 INFO  [STDOUT] LifecycleInterceptor postConstruct
23:52:11,162 INFO  [STDOUT] PostConstruct - Have EntityManager: true
23:52:11,424 INFO  [STDOUT] -- CustomerDAOBean.create()
23:52:11,575 INFO  [STDOUT] doPrePersist: About to create Customer: Bill Burke
23:52:11,608 INFO  [STDOUT] doPostPersist: Created Customer: Bill Burke
23:52:11,644 INFO  [STDOUT] -- CustomerDAOBean.create()
23:52:11,644 INFO  [STDOUT] doPrePersist: About to create Customer: Monica Smith
23:52:11,645 INFO  [STDOUT] doPostPersist: Created Customer: Monica Smith
23:52:11,655 INFO  [STDOUT] -- CustomerDAOBean.find()
23:52:11,673 INFO  [STDOUT] doPostLoad: Loaded Customer: Monica Smith
23:52:11,700 INFO  [STDOUT] -- CustomerDAOBean.merge()
23:52:11,704 INFO  [STDOUT] doPostLoad: Loaded Customer: Monica Smith
23:52:11,705 INFO  [STDOUT] doPreUpdate: About to update Customer: Monica Burke
23:52:11,727 INFO  [STDOUT] doPostUpdate: Updated Customer: Monica Burke
23:52:11,735 INFO  [STDOUT] -- CustomerDAOBean.findByLastName(id)
23:52:12,101 INFO  [STDOUT] doPostLoad: Loaded Customer: Bill Burke
23:52:12,102 INFO  [STDOUT] doPostLoad: Loaded Customer: Monica Burke
23:52:12,113 INFO  [STDOUT] -- CustomerDAOBean.delete()
23:52:12,116 INFO  [STDOUT] doPostLoad: Loaded Customer: Bill Burke
23:52:12,118 INFO  [STDOUT] doPreRemove: About to delete Customer: Bill Burke
23:52:12,124 INFO  [STDOUT] doPostLoad: Loaded Customer: Monica Burke
23:52:12,125 INFO  [STDOUT] doPreRemove: About to delete Customer: Monica Burke
23:52:12,128 INFO  [STDOUT] doPostRemove: Deleted Customer: Bill Burke
23:52:12,128 INFO  [STDOUT] doPostRemove: Deleted Customer: Monica Burke

	</pre>
            <p>
	Now if you open up the persistence.xml, in this tutorial, and uncomment the following:


	</p>
            <pre class="programlisting">
&lt;property name="hibernate.show_sql" value="true"/&gt;
	</pre>
            <p>
	and rebuild and run the tutorial, the output should be:

	</p>
            <pre class="programlisting">
00:00:24,514 INFO  [STDOUT] LifecycleInterceptor postConstruct
00:00:24,514 INFO  [STDOUT] PostConstruct - Have EntityManager: true
00:00:24,759 INFO  [STDOUT] -- CustomerDAOBean.create()
00:00:24,760 INFO  [STDOUT] doPrePersist: About to create Customer: Bill Burke
00:00:24,760 INFO  [STDOUT] Hibernate: insert into CUSTOMER (id, CITY, FIRST, LAST, STATE, STREET, ZIP) values (null, ?, ?, ?, ?, ?, ?)
00:00:24,761 INFO  [STDOUT] Hibernate: call identity()
00:00:24,762 INFO  [STDOUT] doPostPersist: Created Customer: Bill Burke
00:00:24,773 INFO  [STDOUT] -- CustomerDAOBean.create()
00:00:24,773 INFO  [STDOUT] doPrePersist: About to create Customer: Monica Smith
00:00:24,774 INFO  [STDOUT] Hibernate: insert into CUSTOMER (id, CITY, FIRST, LAST, STATE, STREET, ZIP) values (null, ?, ?, ?, ?, ?, ?)
00:00:24,774 INFO  [STDOUT] Hibernate: call identity()
00:00:24,775 INFO  [STDOUT] doPostPersist: Created Customer: Monica Smith
00:00:24,784 INFO  [STDOUT] -- CustomerDAOBean.find()
00:00:24,785 INFO  [STDOUT] Hibernate: select customer0_.id as id8_0_, customer0_.CITY as CITY8_0_, customer0_.FIRST as FIRST8_0_, customer0_.LAST as LAST8_0_, customer0_.STATE as STATE8_0_, customer0_.STREET as STREET8_0_, customer0_.ZIP as ZIP8_0_ from CUSTOMER customer0_ where customer0_.id=?
00:00:24,786 INFO  [STDOUT] doPostLoad: Loaded Customer: Monica Smith
00:00:24,817 INFO  [STDOUT] -- CustomerDAOBean.merge()
00:00:24,818 INFO  [STDOUT] Hibernate: select customer0_.id as id8_0_, customer0_.CITY as CITY8_0_, customer0_.FIRST as FIRST8_0_, customer0_.LAST as LAST8_0_, customer0_.STATE as STATE8_0_, customer0_.STREET as STREET8_0_, customer0_.ZIP as ZIP8_0_ from CUSTOMER customer0_ where customer0_.id=?
00:00:24,818 INFO  [STDOUT] doPostLoad: Loaded Customer: Monica Smith
00:00:24,818 INFO  [STDOUT] doPreUpdate: About to update Customer: Monica Burke
00:00:24,820 INFO  [STDOUT] Hibernate: update CUSTOMER set CITY=?, FIRST=?, LAST=?, STATE=?, STREET=?, ZIP=? where id=?
00:00:24,820 INFO  [STDOUT] doPostUpdate: Updated Customer: Monica Burke
00:00:24,834 INFO  [STDOUT] -- CustomerDAOBean.findByLastName(id)
00:00:24,880 INFO  [STDOUT] Hibernate: select customer0_.id as id8_, customer0_.CITY as CITY8_, customer0_.FIRST as FIRST8_, customer0_.LAST as LAST8_, customer0_.STATE as STATE8_, customer0_.STREET as STREET8_, customer0_.ZIP as ZIP8_ from CUSTOMER customer0_ where customer0_.LAST=?
00:00:24,881 INFO  [STDOUT] doPostLoad: Loaded Customer: Bill Burke
00:00:24,881 INFO  [STDOUT] doPostLoad: Loaded Customer: Monica Burke
00:00:24,896 INFO  [STDOUT] -- CustomerDAOBean.delete()
00:00:24,897 INFO  [STDOUT] Hibernate: select customer0_.id as id8_0_, customer0_.CITY as CITY8_0_, customer0_.FIRST as FIRST8_0_, customer0_.LAST as LAST8_0_, customer0_.STATE as STATE8_0_, customer0_.STREET as STREET8_0_, customer0_.ZIP as ZIP8_0_ from CUSTOMER customer0_ where customer0_.id=?
00:00:24,897 INFO  [STDOUT] doPostLoad: Loaded Customer: Bill Burke
00:00:24,898 INFO  [STDOUT] doPreRemove: About to delete Customer: Bill Burke
00:00:24,898 INFO  [STDOUT] Hibernate: select customer0_.id as id8_0_, customer0_.CITY as CITY8_0_, customer0_.FIRST as FIRST8_0_, customer0_.LAST as LAST8_0_, customer0_.STATE as STATE8_0_, customer0_.STREET as STREET8_0_, customer0_.ZIP as ZIP8_0_ from CUSTOMER customer0_ where customer0_.id=?
00:00:24,899 INFO  [STDOUT] doPostLoad: Loaded Customer: Monica Burke
00:00:24,899 INFO  [STDOUT] doPreRemove: About to delete Customer: Monica Burke
00:00:24,900 INFO  [STDOUT] Hibernate: delete from CUSTOMER where id=?
00:00:24,900 INFO  [STDOUT] doPostRemove: Deleted Customer: Bill Burke
00:00:24,900 INFO  [STDOUT] Hibernate: delete from CUSTOMER where id=?
00:00:24,900 INFO  [STDOUT] doPostRemove: Deleted Customer: Monica Burke


	</pre>
            <p>
	Thus you can see how the callbacks on the entity bean wrap the interaction with the database.
	</p>
         </div>
         <div class="chapter" lang="en">
            <div class="titlepage">
               <div>
                  <div>
                     <h2 class="title">
                        <a id="Composite_Primary_Keys_for_Entities_in_EJB3"/>Chapter 7. Introduction to Composite Primary Keys and Primary Key Classes</h2>
                  </div>
               </div>
            </div>
            <p>
	The EJB 3.0 specification allows you to define a primary key class as a <code class="literal">@Embeddable</code> and use it as the
	primary key of your Entity bean. One or more properties can be used as members of the primary key for that particular table.
	This tutorial is an adaptation of the "relationships" tutorial. It adds a primary key class to Customer that holds both
	the <code class="literal">name</code> and <code class="literal">id</code> of the Customer.
	</p>
            <pre class="programlisting">
	
@Embeddable
public class CustomerPK implements java.io.Serializable
{
   private long id;
   private String name;


   public CustomerPK()
   {
   }

   public CustomerPK(long id, String name)
   {
      this.id = id;
      this.name = name;
   }

   public long getId()
   {
      return id;
   }

   public void setId(long id)
   {
      this.id = id;
   }

   public String getName()
   {
      return name;
   }

   public void setName(String name)
   {
      this.name = name;
   }

   public int hashCode()
   {
      return (int) id + name.hashCode();
   }

   public boolean equals(Object obj)
   {
      if (obj == this) return true;
      if (!(obj instanceof CustomerPK)) return false;
      if (obj == null) return false;
      CustomerPK pk = (CustomerPK) obj;
      return pk.id == id &amp;&amp; pk.name.equals(name);
   }
}

	</pre>
            <div class="sect5" lang="en">
               <div class="titlepage"/>
	Mapping the primary key class:
	</div>
            <p>
		Open up <code class="literal">org.jboss.tutorial.composite.bean.Customer</code> and look for the <code class="literal">getPk()</code> method.
		This defines the primary key class.
		</p>
            <pre class="programlisting">
		
@EmbeddedId
public CustomerPK getPk()
{
   return pk;
}
		
		</pre>
            <p>

		The <code class="literal">org.jboss.tutorial.composite.bean.CustomerPK</code> class is mapped to
		<code class="literal">org.jboss.tutorial.composite.bean.Customer</code> just like any other embeddable object.
		The additional <code class="literal">@EmbeddedId</code> annotation specifies that it will be the primary key.
		</p>
            <div class="note">
               <h2>Note</h2>
               <p>
				If you provide a primary key class, JBoss cannot auto-generate the key for you. You must allocate
				a CustomerPK class and instantiate it with your id and name when you create the Customer.
			</p>
            </div>
            <p>
	
            </p>
            <div class="sect5" lang="en">
               <div class="titlepage"/>
		Many To Many
	</div>
            <p>
		There is a many-to-many relationship between <code class="literal">org.jboss.tutorial.composite.bean.Customer</code> and
		<code class="literal">org.jboss.tutorial.composite.bean.Flight</code>. In order to have a many-to-many relationship there
		needs to be a distinct join table that maps the many-to-many relationship. This is called an association table.
  		You need to use the <code class="literal">@JoinTable</code> annotation to define this join table. The <code class="literal">@JoinTable</code>
  		must be defined on both sides of the bi-directional relationship. Let's look at the Customer side of the relationship

  		</p>
            <pre class="programlisting">
	  		
@ManyToMany(cascade = {CascadeType.PERSIST, CascadeType.MERGE}, fetch = FetchType.EAGER, mappedBy="customers")
@JoinTable(name="flight_customer_table", joinColumns={@JoinColumn(name = "FLIGHT_ID")},
          	inverseJoinColumns={@JoinColumn(name = "CUSTOMER_ID"), @JoinColumn(name = "CUSTOMER_NAME")})
public Set&lt;Flight&gt; getFlights()
{
 		return flights;
}
	  		
  		</pre>
            <p>
  		The <code class="literal">mappedBy</code> attribute specifies which side of the relationship is responsible for managing the relationship.
  		If it is not set, then that side is responsible. So, for this example, the <code class="literal">Flight</code> Entity is responsible
  		for managing the relation. In this example, we are specifying multiple <code class="literal">inverseJoinColumns</code>
  		because Customer has a composite primary key.

  		Let's look at the other side of the relationship in Flight:

  		</p>
            <pre class="programlisting">
  			
@ManyToMany(cascade = {CascadeType.PERSIST, CascadeType.MERGE}, fetch = FetchType.EAGER)
@JoinTable(name = "flight_customer_table", joinColumns = {@JoinColumn(name = "FLIGHT_ID")},
         inverseJoinColumns = {@JoinColumn(name = "CUSTOMER_ID"), @JoinColumn(name = "CUSTOMER_NAME")})
public Set&lt;Customer&gt; getCustomers()
{
	return customers;
}
  			
  		</pre>
            <p>

  		The <code class="literal">Flight</code> Entity must also define the <code class="literal">@ManyToMany</code> and <code class="literal">@JoinTable</code>.

		The database associate table will look like this:

		</p>
            <pre class="programlisting">
		
create table FLIGHT_CUSTOMER_TABLE (
  		CUSTOMER_ID integer,
  		CUSTOMER_NAME varchar,
  		FLIGHT_ID integer
);
		
		</pre>
            <p>
	
            </p>
            <div class="sect5" lang="en">
               <div class="titlepage"/>
Building and Running
	</div>
            <div class="note">
               <h2>Note</h2>
               <p>
	To build and run the example, make sure you have installed JBoss 5.x.
	See the <a href="#JBossAS5" title="1.1. JBoss Application Server 5.x">Section 1.1, “JBoss Application Server 5.x”</a> for details.
			</p>
            </div>
            <p>
			From the command prompt, move to the "composite" folder under the <a href="#EJB3_TUTORIAL_HOME" title="1.3. Set the EJB3_TUTORIAL_HOME">Section 1.3, “Set the EJB3_TUTORIAL_HOME”</a>
		
            </p>
            <div class="sect5" lang="en">
               <div class="titlepage"/>
Ant Users:
	</div>
            <p>
		Make sure your JBossAS-5.x is running
		</p>
            <pre class="programlisting">
	
$ ant
$ ant run

run:
     [java] Air France customers
     [java] Bill
     [java] Monica
     [java] USAir customers
     [java] Molly
     
	</pre>
            <div class="sect5" lang="en">
               <div class="titlepage"/>
Maven Users: Make sure the AS is not running.
	</div>
            <pre class="programlisting">
$ mvn clean install -PRunSingleTutorial
	</pre>
            <div class="sect5" lang="en">
               <div class="titlepage"/>
View the tables and rows:
	</div>
            <p>
		You can view the tables created by JBoss by going to the
		<a xmlns:xlink="http://www.w3.org/1999/xlink" href="http://localhost:8080/jmx-console/HtmlAdaptor?action=inspectMBean&amp;name=jboss%3Aservice%3DHypersonic%2Cdatabase%3DlocalDB">Hypersonic Service</a>,
		scrolling down to the <code class="literal">startDatabaseManager</code> button and clicking it.
		A Hypersonic SQL window will be minimized, but you can open it up to look at the tables and do queries.

	</p>
         </div>
         <div class="chapter" lang="en">
            <div class="titlepage">
               <div>
                  <div>
                     <h2 class="title">
                        <a id="Dependencies_in_EJB3"/>Chapter 8. Introduction to specifying dependencies in EJB3 beans</h2>
                  </div>
               </div>
            </div>
            <p>
		Dependencies of an EJB on a service or services, including other EJBs, may be specified through the
		<code class="literal">&lt;depends&gt;</code> tag of the jboss.xml deployment descriptor. The <code class="literal">&lt;depends&gt;</code>
		tag is analagous to the <code class="literal">@org.jboss.ejb3.annotation.Depends</code> annotation. The dependencies control
		the deployment of EJBs such that an EJB will not deploy until all of it's dependencies have successfully deployed.

	</p>
            <div class="sect5" lang="en">
               <div class="titlepage"/>
		jboss-service.xml :
		<p>
			Take a look at <code class="literal">META-INF/jboss-service.xml</code>. This service deployment descriptor starts
			a service based on <code class="literal">org.jboss.tutorial.dependency.bean.DependedOn</code>.
			</p>
               <pre class="programlisting">
				
&lt;server&gt;
   &lt;mbean code="org.jboss.tutorial.dependency.bean.DependedOn" name="jboss.test:service=DependedOn"/&gt;
&lt;/server&gt;
				

			</pre>
               <p>
		
               </p>
            </div>
            <div class="sect5" lang="en">
               <div class="titlepage"/>
		jboss.xml :
		<p>
			Take a look at <code class="literal">META-INF/jboss.xml</code>. This deployment descriptor indicates that the
			<code class="literal">HasXmlMBeanDependencyBean</code> is dependent on the <code class="literal">jboss.test:service=DependedOn</code>
			started by <code class="literal">jboss-service.xml</code>. The <code class="literal">HasXmlMBeanDependencyBean</code> will not
			deploy until the <code class="literal">jboss.test:service=DependedOn</code> service has successfully started.
		</p>
            </div>
            <div class="sect5" lang="en">
               <div class="titlepage"/>

Building and Running
	<p>
			
               </p>
               <div class="note">
                  <h2>Note</h2>
                  <p>
						To build and run the example, make sure you have installed JBoss 5.x.
						See the <a href="#JBossAS5" title="1.1. JBoss Application Server 5.x">Section 1.1, “JBoss Application Server 5.x”</a> for details.
					</p>
               </div>
               <p>
			From the command prompt, move to the "dependency" folder under the <a href="#EJB3_TUTORIAL_HOME" title="1.3. Set the EJB3_TUTORIAL_HOME">Section 1.3, “Set the EJB3_TUTORIAL_HOME”</a>
			
               </p>
               <div class="sect5" lang="en">
                  <div class="titlepage"/>
		Ant Users:
			</div>
               <p>
				
               </p>
               <p>
				Make sure your JBossAS-5.x is running
				</p>
               <p>
			
               </p>
               <pre class="programlisting">
			
$ ant
$ ant run

run:
     [java] Lookup and bean access succeeded

		     
			</pre>
               <p>

			
               </p>
               <div class="sect5" lang="en">
                  <div class="titlepage"/>
Maven Users: Make sure the AS is not running.
	</div>
               <p>

	
               </p>
               <pre class="programlisting">
$ mvn clean install -PRunSingleTutorial
			</pre>
               <p>

		
               </p>
            </div>
         </div>
         <div class="chapter" lang="en">
            <div class="titlepage">
               <div>
                  <div>
                     <h2 class="title">
                        <a id="EJB_2.1_Client_Adaptors"/>Chapter 9. Introduction to using EJB2.1 client adaptors with EJB3</h2>
                  </div>
               </div>
            </div>
            <p>
		EJB 3.0 is backward compatible to EJB 2.x clients and supports the use of local and remote home interfaces as well as
		initialization methods (e.g. ejbCreate()). This capability is configured through annotations and/or through deployment
		descriptors.
	</p>
            <p>
		Take a look at <code class="literal">org.jboss.tutorial.ejb21_client_adaptors.bean.Session1Bean</code>. Note
		that the class is annotated with <code class="literal">@RemoteHome</code> and the <code class="literal">ejbCreate()</code> method is annotated
		with <code class="literal">@Init</code>. The former annotation indicates that the bean provides a EJB 2.1 style home interface. The latter
		annotation indicates that when the <code class="literal">create()</code> method is invoked from the home interface, the bean is initialized
		via the <code class="literal">ejbCreate</code> method.
		</p>
            <div class="note">
               <h2>Note</h2>
               <p>
				The initialization method (annotated with <code class="literal">@Init</code>) name is not restricted to be ejbCreate(). You can
				specify any other name for that method.
			</p>
            </div>
            <p>

	
            </p>
            <p>
		
               <code class="literal">org.jboss.tutorial.ejb21_client_adaptors.bean.Session2Bean</code> illustrates the use of a local home interface.
	</p>
            <div class="note">
               <h2>Note</h2>
               <p>
				There's a very important difference between the <code class="literal">remote</code> and a <code class="literal">business-remote</code>
				interface. The EJB2.x remote interfaces, which extend from EJBObject, are referred through the <code class="literal">&lt;remote&gt;</code>
				tag in the ejb-jar.xml. On the other hand, the EJB3 style Plain Old Java Interface which is implemented by your EJB3 style
				POJO bean is known as the business-remote interface and is represented by the <code class="literal">@Remote</code> and it's
				corresponding <code class="literal">&lt;business-remote&gt;</code> tag in ejb-jar.xml.

				Similar is the case with <code class="literal">&lt;local&gt;</code> and the <code class="literal">&lt;business-local&gt;</code> tags in ejb-jar.xml.
			</p>
               <p>
				In this tutorial, you will notice that we are using <code class="literal">remote</code> and <code class="literal">local</code> interfaces and
				not <code class="literal">business-remote</code> and <code class="literal">business-local</code> interfaces.
			</p>
            </div>
            <div class="note">
               <h2>Note</h2>
               <p>
			Since we are not using any <code class="literal">business-remote</code> or <code class="literal">business-local</code> interfaces, in this tutorial,
			unlike the "jndibinding" tutorial, we cannot use the <code class="literal">@RemoteBinding</code> or <code class="literal">@LocalBinding</code>
			annotations to bind the EJBs. Instead, we configure the jndi-names for these beans through the <code class="literal">META-INF/jboss.xml</code>:

			</p>
               <pre class="programlisting">
				
&lt;session&gt;
	&lt;ejb-name&gt;Session1&lt;/ejb-name&gt;
	&lt;jndi-name&gt;Session1Remote&lt;/jndi-name&gt;
&lt;/session&gt;
&lt;session&gt;
	&lt;ejb-name&gt;Session2&lt;/ejb-name&gt;
	&lt;local-jndi-name&gt;Session2Local&lt;/local-jndi-name&gt;
&lt;/session&gt;

				
			</pre>
               <p>
		
               </p>
            </div>
            <p>
		Similarly, <code class="literal">org.jboss.tutorial.ejb21_client_adaptors.bean.DeploymentDescriptorSession1Bean</code> and
		<code class="literal">org.jboss.tutorial.ejb21_client_adaptors.DeploymentDescriptorSession2Bean</code> mimic the behavior of
		the first two beans, but use deployment descriptors to indicate the home interface(s) and initialization method(s).
		Take a look at the <code class="literal">META-INF/ejb-jar.xml</code>. Note the <code class="literal">home</code> and <code class="literal">local-home</code>
		tags that indicate the respective home interfaces. Also, note the <code class="literal">init-method</code> tag that indicates the
		initialization method(s) executed when beans are created via the home interface(s).
	</p>
            <div class="sect5" lang="en">
               <div class="titlepage"/>

Building and Running
	<p>
			
               </p>
               <div class="note">
                  <h2>Note</h2>
                  <p>
						To build and run the example, make sure you have installed JBoss 5.x.
						See the <a href="#JBossAS5" title="1.1. JBoss Application Server 5.x">Section 1.1, “JBoss Application Server 5.x”</a> for details.
					</p>
               </div>
               <p>
			From the command prompt, move to the "ejb21_client_adaptors" folder under the <a href="#EJB3_TUTORIAL_HOME" title="1.3. Set the EJB3_TUTORIAL_HOME">Section 1.3, “Set the EJB3_TUTORIAL_HOME”</a>
			
               </p>
               <div class="sect5" lang="en">
                  <div class="titlepage"/>
		Ant Users:
			</div>
               <p>
				
               </p>
               <p>
				Make sure your JBossAS-5.x is running
				</p>
               <p>
			
               </p>
               <pre class="programlisting">
			
$ ant
$ ant run

run:
     [java] Session1 init value is initialized
     [java] Session2 init value is initialized
     [java] DeploymentDescriptor Session1 init value is initialized
     [java] DeploymentDescriptor Session2 init value is initialized

		     
			</pre>
               <p>

			
               </p>
               <div class="sect5" lang="en">
                  <div class="titlepage"/>
Maven Users: Make sure the AS is not running.
	</div>
               <p>

	
               </p>
               <pre class="programlisting">
$ mvn clean install -PRunSingleTutorial
			</pre>
               <p>

		
               </p>
            </div>
         </div>
         <div class="chapter" lang="en">
            <div class="titlepage">
               <div>
                  <div>
                     <h2 class="title">
                        <a id="Embeddable_Objects_in_EJB3_Entities"/>Chapter 10. Introduction to embedding objects in EJB3 entities</h2>
                  </div>
               </div>
            </div>
            <p>
		The EJB3 specification allows you to embed plain Java objects within your entities
		and map the properties of this embedded value object to columns within the entity's
		table.
	</p>
            <p>
	The <code class="literal">org.jboss.tutorial.embeddable.bean.Customer</code> entity encapsulates the name of the customer
	in the <code class="literal">org.jboss.tutorial.embeddable.bean.Name</code> value object. The
	<code class="literal">org.jboss.tutorial.embeddable.bean.Name</code> value object must be tagged with the <code class="literal">@Embeddable</code>
	annotation.

	</p>
            <pre class="programlisting">
	
@Embeddable
public class Name implements java.io.Serializable
	
	</pre>
            <p>

	The properties of Name must then be mapped to columns within Customer's table.

	</p>
            <pre class="programlisting">
	
@Embedded
@AttributeOverrides({
   @AttributeOverride(name = "first", column = {@Column(name = "FIRST_NAME")}),
   @AttributeOverride(name = "last", column = {@Column(name = "LAST_NAME")})
})
public Name getName()
{
   return name;
}
	
	</pre>
            <p>
	
            </p>
            <div class="sect5" lang="en">
               <div class="titlepage"/>
Building and Running
	</div>
            <div class="note">
               <h2>Note</h2>
               <p>
	To build and run the example, make sure you have installed JBoss 5.x.
	See the <a href="#JBossAS5" title="1.1. JBoss Application Server 5.x">Section 1.1, “JBoss Application Server 5.x”</a> for details.
			</p>
            </div>
            <p>
			From the command prompt, move to the "embeddable" folder under the <a href="#EJB3_TUTORIAL_HOME" title="1.3. Set the EJB3_TUTORIAL_HOME">Section 1.3, “Set the EJB3_TUTORIAL_HOME”</a>
		
            </p>
            <div class="sect5" lang="en">
               <div class="titlepage"/>
Ant Users:
	</div>
            <p>
		Make sure your JBossAS-5.x is running
		</p>
            <pre class="programlisting">
	
$ ant
$ ant run

run:
     [java] Create Bill Burke and Monica Smith
     [java] Bill and Monica get married
     [java] Get all the Burkes
     [java] There are now 2 Burkes
     
	</pre>
            <div class="sect5" lang="en">
               <div class="titlepage"/>
Maven Users: Make sure the AS is not running.
	</div>
            <pre class="programlisting">
$ mvn clean install -PRunSingleTutorial
	</pre>
            <div class="sect5" lang="en">
               <div class="titlepage"/>
View the tables and rows:
	</div>
            <p>
		You can view the tables created by JBoss by going to the
		<a xmlns:xlink="http://www.w3.org/1999/xlink" href="http://localhost:8080/jmx-console/HtmlAdaptor?action=inspectMBean&amp;name=jboss%3Aservice%3DHypersonic%2Cdatabase%3DlocalDB">Hypersonic Service</a>,
		scrolling down to the <code class="literal">startDatabaseManager</code> button and clicking it.
		A Hypersonic SQL window will be minimized, but you can open it up to look at the tables and do queries.

	</p>
         </div>
         <div class="chapter" lang="en">
            <div class="titlepage">
               <div>
                  <div>
                     <h2 class="title">
                        <a id="Injecting_EJB_in_Servlets"/>Chapter 11. Introduction to EJB injection in Servlets</h2>
                  </div>
               </div>
            </div>
            <p>
		This tutorial aims at showing how EJBs can be injected in a Servlet. In this tutorial we build an EAR file which
		contains a EJB module (jar file) and a web module (war file).
	</p>
            <p>
		Take a look at the <code class="literal">META-INF/application.xml</code> file:
		</p>
            <pre class="programlisting">
			
&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;!DOCTYPE application PUBLIC
	"-//Sun Microsystems, Inc.//DTD J2EE Application 1.3//EN"
	"http://java.sun.com/dtd/application_1_3.dtd"&gt;
&lt;application&gt;
  &lt;display-name&gt;jboss-ejb3-tutorial-ejb_injection&lt;/display-name&gt;
  &lt;description&gt;Enterprise application showing injection of EJB in Servlet&lt;/description&gt;
  &lt;module&gt;
    &lt;web&gt;
      &lt;web-uri&gt;jboss-ejb3-tutorial-enterprise_webapp.war&lt;/web-uri&gt;
      &lt;context-root&gt;/jboss-ejb3-tutorial-enterprise_webapp&lt;/context-root&gt;
    &lt;/web&gt;
  &lt;/module&gt;
  &lt;module&gt;
    &lt;ejb&gt;jboss-ejb3-tutorial-enterprise_ejb3app.jar&lt;/ejb&gt;
  &lt;/module&gt;
&lt;/application&gt;

			
		</pre>
            <p>
	
            </p>
            <div class="sect5" lang="en">
               <div class="titlepage"/>
		EJB module:
		<p>
			The EJB module in this tutorial consists of a EJB3 SLSB. Take a look at <code class="literal">org.jboss.tutorial.enterprise_app_ejb_injection.bean.CalculatorBean</code>:
			</p>
               <pre class="programlisting">
				
@Stateless(name="calculator")
@Remote(CalculatorRemote.class)
@Local(CalculatorLocal.class)
public class CalculatorBean implements CalculatorRemote, CalculatorLocal
{
...
				
			</pre>
               <p>
		
               </p>
		We will be using this bean in the servlet for performing the <code class="literal">add</code> and <code class="literal">subtract</code> operations.

		<div class="important">
                  <h2>Important</h2>
                  <p>
				When a EJB packaged in a jar file is deployed as part of an EAR, the default jndi-name for the business-remote interface
				will be of the form EARName/BeanName/remote. Similarly the local business-remote will have the default jndi-name of the form
				EARName/BeanName/local.
			</p>
               </div>
            </div>
            <div class="sect5" lang="en">
               <div class="titlepage"/>
		Web module:
		<p>
			The web module consists of a <code class="literal">index.html</code> and a servlet <code class="literal">org.jboss.tutorial.enterprise_app_ejb_injection.servlet.CalculatorActionServlet</code>.
			Take a look at the <code class="literal">WEB-INF/web.xml</code> which configures the <code class="literal">index.html</code> as the welcome page and
			also maps the servlet.
			</p>
               <pre class="programlisting">
				
 &lt;servlet&gt;
      &lt;servlet-name&gt;CalculatorActionServlet&lt;/servlet-name&gt;
      &lt;servlet-class&gt;org.jboss.tutorial.enterprise_app_ejb_injection.servlet.CalculatorActionServlet&lt;/servlet-class&gt;
 &lt;/servlet&gt;

&lt;!-- The servlet and jsp page mappings --&gt;
&lt;servlet-mapping&gt;
   &lt;servlet-name&gt;CalculatorActionServlet&lt;/servlet-name&gt;
   &lt;url-pattern&gt;/CalculatorAction&lt;/url-pattern&gt;
&lt;/servlet-mapping&gt;

&lt;welcome-file-list&gt;
	&lt;welcome-file&gt;index.html&lt;/welcome-file&gt;
&lt;/welcome-file-list&gt;

				
			</pre>
               <p>

			The <code class="literal">org.jboss.tutorial.enterpise_app_ejb_injection.bean.CalculatorLocal</code> will be injected in the
			<code class="literal">org.jboss.tutorial.enterprise_app_ejb_injection.servlet.CalculatorActionServlet</code> using the <code class="literal">@EJB</code>
			annotation:
			</p>
               <pre class="programlisting">
				
private CalculatorLocal calculator;

/**
 * Injecting the EJB
 */
@EJB(name = "calculator")
public void setCalculator(CalculatorLocal calculator)
{
   this.calculator = calculator;
}
				
			</pre>
               <p>
			
               </p>
               <div class="important">
                  <h2>Important</h2>
                  <p>
					For the injection to take place in a web module, your web.xml should use the 2.5 version of the web-app xsd:
					</p>
                  <pre class="programlisting">
						
&lt;web-app version="2.5"
	xmlns="http://java.sun.com/xml/ns/javaee"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="http://java.sun.com/xml/ns/javaee http://java.sun.com/xml/ns/javaee/web-app_2_5.xsd"&gt;
						
					</pre>
                  <p>
				
                  </p>
               </div>
               <p>

		
               </p>
            </div>
            <div class="sect5" lang="en">
               <div class="titlepage"/>
Building and Running
	</div>
            <div class="note">
               <h2>Note</h2>
               <p>
	To build and run the example, make sure you have installed JBoss 5.x.
	See the <a href="#JBossAS5" title="1.1. JBoss Application Server 5.x">Section 1.1, “JBoss Application Server 5.x”</a> for details.
			</p>
            </div>
            <p>
			From the command prompt, move to the "enterprise_app_ejb_injection" folder under the <a href="#EJB3_TUTORIAL_HOME" title="1.3. Set the EJB3_TUTORIAL_HOME">Section 1.3, “Set the EJB3_TUTORIAL_HOME”</a>
		
            </p>
            <div class="sect5" lang="en">
               <div class="titlepage"/>
Ant Users:
	</div>
            <p>
		Make sure your JBossAS-5.x is running
		</p>
            <pre class="programlisting">
	
$ ant
     
	</pre>
            <p>
		This will deploy the ear into the JBossAS-5.x server ("default" configuration).
	</p>
            <div class="sect5" lang="en">
               <div class="titlepage"/>
		To access the servlet, open a web browser and enter <a xmlns:xlink="http://www.w3.org/1999/xlink" href="http://localhost:8080/jboss-ejb3-tutorial-enterprise_webapp">http://localhost:8080/jboss-ejb3-tutorial-enterprise_webapp</a>.
		This will bring up a page where you can enter two number and either click on <code class="literal">Add</code> or <code class="literal">subtract</code>.
	</div>
            <div class="sect5" lang="en">
               <div class="titlepage"/>
Maven Users: Make sure the AS is not running.
	</div>
            <pre class="programlisting">
$ mvn clean install -PRunSingleTutorial
	</pre>
            <p>
		This will create the EAR in the <code class="literal">target</code> folder of the tutorial. Copy this EAR to the deploy folder of JBossAS-5.x
		and start the server (if it's already not started). Then follow the steps mentioned above, to access the servlet from the web browser.
	</p>
         </div>
         <div class="chapter" lang="en">
            <div class="titlepage">
               <div>
                  <div>
                     <h2 class="title">
                        <a id="EJB3_Entities"/>Chapter 12. Introduction to Entities in EJB3</h2>
                  </div>
               </div>
            </div>
            <p>
		Entity Beans of EJB2.x have been given a complete overhaul in EJB 3.0.
		Entity beans (or Entities, as they are now called) are plain Java objects that can be allocated
		with <code class="literal">new</code> and attached/detached/reattached to persistence storage.
		Entities are not remotable and must be accessed through the new <code class="literal">javax.persistence.EntityManager</code> service.
		JBoss's EJB 3.0 entity implementation is built on top of Hibernate.
	</p>
            <div class="sect5" lang="en">
               <div class="titlepage"/>
		O/R Mapping :
	</div>
            <p>
		First let's look at the example implementation of two related Entities.
		<code class="literal">org.jboss.tutorial.entity.bean.Order</code> and <code class="literal">org.jboss.tutorial.entity.bean.LineItem</code>.
		These two entities form a one-to-many relationship.
	</p>
            <p>
		The persistence determines the persistent properties by looking for all getter/setter method pairs.
		By default, all getter/setter methods will be treated as persistence properties.
	</p>
            <p>
		Defining an Entity is easy. First, annotate the class as an <code class="literal">@Entity</code>. In the minimum, you must at
		least define a primary key field using the <code class="literal">@Id</code> annotation.

		</p>
            <pre class="programlisting">
		
@Id @GeneratedValue
public int getId()
{
   return id;
}
		
		</pre>
            <p>
		
            </p>
            <div class="note">
               <h2>Note</h2>
               <p>
				Annotations must be defined on the getter method or on the field. However, you cannot have a mix of annotations
				on the field and on the methods. The following example where we are mapping the <code class="literal">name</code> through
				the field and mapping the <code class="literal">age</code> through the method is not allowed:

				</p>
               <pre class="programlisting">
					
@Entity
public class Employee implements java.io.Serializable
{

	@Id
	@GeneratedValue(strategy=GenerationType.AUTO)
	private long id;

	@Column (name="NAME")
	private String name;

	private int age;

	@Column (name="AGE")
	public int getAge()
	{
		return this.age
	}

	public String getName()
	{

	}
	// other getter/setters
}
					
				</pre>
               <p>
			
               </p>
            </div>
            <p>

		The <code class="literal">@Id</code> annotation tells the container that <code class="literal">id</code> is the primary key property.
		The <code class="literal">@GeneratedValue</code> tells that it should be automatically generated by the container.
		The table name is specified using the <code class="literal">@Table</code> annotation

		</p>
            <pre class="programlisting">
		
@Table(name = "PURCHASE_ORDER")
		
		</pre>
            <p>

		If the table name isn't specified it defaults to the simple name of the class. For instance, the LineItem entity would be
		mapped to the LINEITEM table.
	</p>
            <div class="sect5" lang="en">
               <div class="titlepage"/>
		One to Many Relationship :
	</div>
            <p>
		The Order bean also defines a one to many relationship.

		</p>
            <pre class="programlisting">
			
@OneToMany(cascade = CascadeType.ALL, fetch = FetchType.EAGER, mappedBy="order")
public Collection&lt;LineItem&gt; getLineItems()
{
   return lineItems;
}
			
		</pre>
            <p>
		Generics must be used so that the container can determine what the entity Order is related to.
		</p>
            <p>
			
               <code class="literal">CascadeType.ALL</code> specifies that when an Order is created, any LineItems held in the <code class="literal">lineItems</code>
			collection will be created as well (<code class="literal">CascadeType.PERSIST</code>). If the Order is deleted from persistence storage,
			all related LineItems will be deleted (<code class="literal">CascadeType.REMOVE</code>). If an Order instance is reattached to persistence
			storage, any changes to the LineItems collection will be merged with persistence storage (<code class="literal">CascadeType.MERGE</code>).
		</p>
            <p>

		
            </p>
            <p>
			
               <code class="literal">FetchType.EAGER</code> specifies that when the Order is loaded whether or not to pre-fetch the relationship as well.
			If you want the LineItems to be loaded on demand, then specify <code class="literal">FetchType.LAZY</code>.
		</p>
            <p>

		
            </p>
            <p>
			The <code class="literal">mappedBy</code> attribute specifies that this is a bi-directional relationship that is managed by the order property
			on the LineItem entity.
		</p>
            <p>

	
            </p>
            <div class="sect5" lang="en">
               <div class="titlepage"/>
		Many to One Relationship :
	</div>
            <p>
		
            </p>
            <pre class="programlisting">
			
@ManyToOne
@JoinColumn(name = "order_id")
public Order getOrder()
{
   return order;
}
		
		</pre>
            <p>

		The <code class="literal">@JoinColumn</code> specifies the foreign key column within the LineItem table.

	</p>
            <div class="sect5" lang="en">
               <div class="titlepage"/>
		EntityManager :
	</div>
            <p>
		The <code class="literal">org.jboss.tutorial.entity.bean.ShoppingCartBean</code> allocates and stores all instances
		of Orders and LineItems. If you look at the example you can see that ShoppingCart interacts with Order as a plain Java object.
		It allocates it with <code class="literal">new</code>. It can pass the Order back to the client. The <code class="literal">checkout()</code>
		method actually stores it with persistence storage by using the required EntityManager service.

		The EntityManager service is injected using field injection and the <code class="literal">@PersistenceContext</code> annotation.
		</p>
            <pre class="programlisting">
			
@PersistenceContext
private EntityManager manager;

			
		</pre>
            <p>

		The EntityManager is central to EJB 3.0 as there are no homes. The EntityManager is used to do querying, creating,
		find by primary key, and removal of entities in EJB3.
	</p>
            <div class="sect5" lang="en">
               <div class="titlepage"/>
Building and Running
	</div>
            <div class="note">
               <h2>Note</h2>
               <p>
	To build and run the example, make sure you have installed JBoss 5.x.
	See the <a href="#JBossAS5" title="1.1. JBoss Application Server 5.x">Section 1.1, “JBoss Application Server 5.x”</a> for details.
			</p>
            </div>
            <p>
			From the command prompt, move to the "entity" folder under the <a href="#EJB3_TUTORIAL_HOME" title="1.3. Set the EJB3_TUTORIAL_HOME">Section 1.3, “Set the EJB3_TUTORIAL_HOME”</a>
		
            </p>
            <div class="sect5" lang="en">
               <div class="titlepage"/>
Ant Users:
	</div>
            <p>
		Make sure your JBossAS-5.x is running
		</p>
            <pre class="programlisting">
	
$ ant
$ ant run

run:
     [java] Buying 2 memory sticks
     [java] Buying a laptop
     [java] Print cart:
     [java] Total: $3000.0
     [java] 2     Memory stick     1000.0
     [java] 1     Laptop     2000.0
     [java] Checkout

     
	</pre>
            <div class="sect5" lang="en">
               <div class="titlepage"/>
Maven Users: Make sure the AS is not running.
	</div>
            <pre class="programlisting">
$ mvn clean install -PRunSingleTutorial
	</pre>
            <div class="sect5" lang="en">
               <div class="titlepage"/>
View the tables and rows:
	</div>
            <p>
		You can view the tables created by JBoss by going to the
		<a xmlns:xlink="http://www.w3.org/1999/xlink" href="http://localhost:8080/jmx-console/HtmlAdaptor?action=inspectMBean&amp;name=jboss%3Aservice%3DHypersonic%2Cdatabase%3DlocalDB">Hypersonic Service</a>,
		scrolling down to the <code class="literal">startDatabaseManager</code> button and clicking it.
		A Hypersonic SQL window will be minimized, but you can open it up to look at the tables and do queries.

	</p>
         </div>
         <div class="chapter" lang="en">
            <div class="titlepage">
               <div>
                  <div>
                     <h2 class="title">
                        <a id="Extended_Persistence_Contexts"/>Chapter 13. Introduction to Extended Persistence Contexts</h2>
                  </div>
               </div>
            </div>
            <p>
		Usually, an EntityManager in JBoss EJB 3.0 lives and dies within a JTA transaction. Once the transaction is finished,
		all persistent objects are detached from the EntityManager and are no longer managed.
		Any local caching the EntityManager instance had done is lost. JBoss EJB 3.0 allows you to define long-living EntityManagers
		that live beyond the scope of a JTA transaction. This is called an Extended Persistence Context.

		When you specify that an injected EntityManager is an extended persistence context, all object instances remain managed.

	</p>
            <p>
		Extended persistence contexts can only be used within Stateful session beans. Take a look at
		<code class="literal">org.jboss.tutorial.extended.bean.ShoppingCartBean</code>.

		</p>
            <pre class="programlisting">
			
@Stateful
@Remote(ShoppingCart.class)
public class ShoppingCartBean implements ShoppingCart
{
   @PersistenceContext(type=PersistenceContextType.EXTENDED)
   EntityManager em;

   @EJB StatelessLocal stateless;

   private Customer customer;

   public long createCustomer()
   {
      customer = new Customer();
      customer.setName("William");
      em.persist(customer);
      return customer.getId();
   }

   public void update()
   {
      customer.setName("Bill");
   }
...
}

			
		</pre>
            <p>

		To inject an extended persistence context, you use the <code class="literal">type()</code> attribute and set it to <code class="literal">EXTENDED</code>.
		If you look at the <code class="literal">createCustomer()</code> method you notice that it is persisting a <code class="literal">Customer</code> object
		and storing a reference to that	created object within a member variable of the stateful bean. When the update() method is called,
		you see that the customer's state is modified. Since the entity manager used is EXTENDED, the customer member variable remains
		managed by the entitymanager and the modified state will be synchronized with the database.

	</p>
            <div class="sect5" lang="en">
               <div class="titlepage"/>
		Conversations :
	</div>
            <p>
		An even more interesting use case is when you combine extended persistence contexts with non-transactional methods.
		If you interact with an extended persistence context outside of a transaction, the inserts, updates, and deletes
		will be queued until you access the persistence context within a transaction. This means that any persist(), merge(),
		or remove() method you call will not actually result in a JDBC execution and thus an update of the database until
		you manually call EntityManager.flush().
		</p>
            <p>
			Why is this useful? Consider the usecase of a Setup Wizard on a website.  The Wizard has seven steps, seven web pages to enter
			stuff in.  It is extremely unwise to have a JTA transaction that spans multiple http requests, yet you do not want to commit
			anything to the database until all steps are complete.  Your code can interact with the EntityManager as it wants and you
			do not have to worry about updates or writing a lot of gluecode in your application to do all the entity manager's work in the
			final step of the wizard.  Efficient and highly performant. Because the managed persistent objects remain attached to the
			persistent context, all optmistic versioning checks can also be maintained within the application transaction.
			Here's an example on how to do this.

			</p>
            <pre class="programlisting">
				
@Stateful
@Remote(ShoppingCart.class)
public class ShoppingCartBean implements ShoppingCart
{
   @PersistenceContext(type=PersistenceContextType.EXTENDED)
   EntityManager em;

   @EJB StatelessLocal stateless;

   private Customer customer;

   public long createCustomer()
   {
      customer = new Customer();
      customer.setName("William");
      em.persist(customer);
      return customer.getId();
   }

   @TransactionAttribute(TransactionAttributeType.NOT_SUPPORTED)
   public void never()
   {
      customer.setName("Bob");
   }



   @Remove
   public void checkout()
   {
   }
}

				
			</pre>
            <p>
		
            </p>
            <p>
		Calling the never() method will update the managed customer object reference, but will not result in a database update until
		checkout() is called. The spec requires that any time you invoke a transactional method of a stateful bean,
		that the EntityManager join the transaction. Therefore, our never() update will be committed at the end of the checkout() method
		(which by default has the REQUIRED trasaction attribute).

	</p>
            <div class="sect5" lang="en">
               <div class="titlepage"/>
Building and Running
	</div>
            <div class="note">
               <h2>Note</h2>
               <p>
	To build and run the example, make sure you have installed JBoss 5.x.
	See the <a href="#JBossAS5" title="1.1. JBoss Application Server 5.x">Section 1.1, “JBoss Application Server 5.x”</a> for details.
			</p>
            </div>
            <p>
			From the command prompt, move to the "extended_pc" folder under the <a href="#EJB3_TUTORIAL_HOME" title="1.3. Set the EJB3_TUTORIAL_HOME">Section 1.3, “Set the EJB3_TUTORIAL_HOME”</a>
		
            </p>
            <div class="sect5" lang="en">
               <div class="titlepage"/>
Ant Users:
	</div>
            <p>
		Make sure your JBossAS-5.x is running
		</p>
            <pre class="programlisting">
	
$ ant
$ ant run

run:
     [java] Created customer: William
     [java] Customer's name should still be William as pc was not yet flushed:  Customer.getName() == William
     [java] Now that the pc has been flushed name should be 'Bob': Customer.getName() == Bob
     [java] Created customer: William
     [java] ShoppingCartBean.customer should stay managed because we're in an extended PC: Customer.getName() == Bill
     [java] Extended persistence contexts are propagated to nested EJB calls: Customer.getName() == Bill Jr.

     
	</pre>
            <div class="sect5" lang="en">
               <div class="titlepage"/>
Maven Users: Make sure the AS is not running.
	</div>
            <pre class="programlisting">
$ mvn clean install -PRunSingleTutorial
	</pre>
         </div>
         <div class="chapter" lang="en">
            <div class="titlepage">
               <div>
                  <div>
                     <h2 class="title">
                        <a id="Dependency_Injection"/>Chapter 14. Introduction to dependency injection</h2>
                  </div>
               </div>
            </div>
            <p>
		To facilitate test driven development, the EJB 3.0 specification allows you to use annotations to inject
		dependencies through annotations on fields or setter methods. Instead of complicated XML ejb-refs or resource refs,
		you can use the <code class="literal">@EJB</code> and <code class="literal">@Resource</code> annotations to set the value of a
		field or to call a setter method within your session bean with anything registered within JNDI.
		You can use the <code class="literal">@EJB</code> annotation to inject EJB references and <code class="literal">@Resource</code> to access datasources.
	</p>
            <p>
		Open up <code class="literal">org.jboss.tutorial.injection.bean.ShoppingCartBean</code>.
		ShoppingCartBean uses the Calculator stateless session EJB to do calculations. The example shows two ways to get access
		to the Calculator EJB.  One is:

		</p>
            <pre class="programlisting">
			
@EJB
private Calculator calculator;
			
		</pre>
            <p>

		When the ShoppingCartBean instance is created, the EJB container will set the calculator field using the jndiName
		of that particular referenced EJB.
	</p>
            <p>
		You are not limited to injecting dependencies on fields. You can also use @EJB on a setter method. The below example from
		ShoppingCartBean uses the <code class="literal">@EJB</code> annotation to inject the reference to the Calculator session bean:

		</p>
            <pre class="programlisting">
			
private Calculator set;

@EJB(beanName="org.jboss.tutorial.injection.bean.CalculatorBean")
public void setCalculator(Calculator c)
{
   set = c;
}

			
		</pre>
            <p>
	
            </p>
            <p>
		The <code class="literal">@javax.annotation.Resource</code> annotation allows you to inject resources.

		</p>
            <pre class="programlisting">
		
@Resource(mappedName="DefaultDS")
private javax.sql.DataSource ds;
		
		</pre>
            <p>

		
            </p>
            <div class="note">
               <h2>Note</h2>
               <p>
				In JBoss, whenever the mappedName() attribute is specified (with @Resource, @EJB), JBoss will use that as the GLOBAL jndi name to look it up.
			</p>
            </div>
            <p>

		The @Resource annotation is used to inject these singletons as well:

		</p>
            <pre class="programlisting">
			
@Resource
javax.ejb.SessionContext ctx;

@Resource
javax.ejb.TimerService timer;

@Resource
javax.ejb.UserTransaction ut;

			
		</pre>
            <p>

	
            </p>
            <p>
		
               <code class="literal">@EJB</code> and <code class="literal">@Resource</code> also create an entry within the JNDI ENC of the bean. So, the above @EJB
		injection will create an entry for the reference calculator bean under "java:comp/env/ejb/calculator".
	</p>
            <div class="sect5" lang="en">
               <div class="titlepage"/>
Building and Running
	</div>
            <div class="note">
               <h2>Note</h2>
               <p>
	To build and run the example, make sure you have installed JBoss 5.x.
	See the <a href="#JBossAS5" title="1.1. JBoss Application Server 5.x">Section 1.1, “JBoss Application Server 5.x”</a> for details.
			</p>
            </div>
            <p>
			From the command prompt, move to the "injection" folder under the <a href="#EJB3_TUTORIAL_HOME" title="1.3. Set the EJB3_TUTORIAL_HOME">Section 1.3, “Set the EJB3_TUTORIAL_HOME”</a>
		
            </p>
            <div class="sect5" lang="en">
               <div class="titlepage"/>
Ant Users:
	</div>
            <p>
		Make sure your JBossAS-5.x is running
		</p>
            <pre class="programlisting">
	
$ ant
$ ant run

run:
     [java] Buying 1 memory stick
     [java] Buying another memory stick
     [java] Buying a laptop
     [java] Print cart:
     [java] 2     Memory stick
     [java] 1     Laptop
     [java] Checkout

     
	</pre>
            <div class="sect5" lang="en">
               <div class="titlepage"/>
Maven Users: Make sure the AS is not running.
	</div>
            <pre class="programlisting">
$ mvn clean install -PRunSingleTutorial
	</pre>
         </div>
         <div class="chapter" lang="en">
            <div class="titlepage">
               <div>
                  <div>
                     <h2 class="title">
                        <a id="EJB3_Interceptors"/>Chapter 15. Introduction to EJB3 Interceptors</h2>
                  </div>
               </div>
            </div>
            <p>
		The EJB 3.0 spec defines the ability to apply custom made interceptors
		to the business methods
		of your session and message driven beans. EJB
		3.0 interceptors take the form of methods annotated with
		the
		<code class="literal">@javax.ejb.AroundInvoke</code>
		annotation. These methods must have the following signature:

		</p>
            <pre class="programlisting">
			
@javax.ejb.AroundInvoke
public Object &lt;Arbitrary method name&gt;(javax.ejb.InvocationContext ctx) throws java.lang.Exception

			
		</pre>
            <p>

		
            </p>
            <div class="note">
               <h2>Note</h2>
               <p>
				You can apply interceptors to JBoss specific @Service and
				@Consumer beans
			</p>
            </div>
            <p>

		You can either define an interceptor method in the bean class itself,
		or in separate classes.
		There can only be one interceptor method per
		class.
	</p>
            <div class="sect5" lang="en">
               <div class="titlepage"/>
		Interceptor method in bean class :
	</div>
            <p>
		Take a look at
		<code class="literal">org.jboss.tutorial.interceptor.bean.EmailMDB
		</code>
		. It contains this method:

		</p>
            <pre class="programlisting">
			
@AroundInvoke
public Object mdbInterceptor(InvocationContext ctx) throws Exception
{
   System.out.println("*** Intercepting call to EmailMDB.mdbInterceptor()");
   return ctx.proceed();
}
			
		</pre>
            <p>

		This method will wrap the call to EmailMDB.onMessage(). The call to
		ctx.proceed() causes the next object in the chain of
		interceptors to
		get invoked. At the end of the chain of interceptors, the actual bean
		method gets called.
		</p>
            <p>
			Similarly
			<code class="literal">org.jboss.tutorial.interceptor.bean.EmailSystemBean
			</code>
			has a method annotated with
			<code class="literal">@AroundInvoke</code>

			
            </p>
            <pre class="programlisting">
				
@AroundInvoke
public Object myBeanInterceptor(InvocationContext ctx) throws Exception
{
   if (ctx.getMethod().getName().equals("emailLostPassword"))
   {
      System.out.println("*** EmailSystemBean.myBeanInterceptor - username: " + ctx.getParameters()[0]);
   }

   return ctx.proceed();
}

				
			</pre>
            <p>
		
            </p>
            <p>
	
            </p>
            <div class="sect5" lang="en">
               <div class="titlepage"/>
		External interceptors :
	</div>
            <p>
		The rest of this example will be looking at adding interceptors
		external to the bean class, more specifically to
		<code class="literal">EmailSystemBean</code>
		. Interceptors can be bound in three different ways:
		</p>
            <div class="itemizedlist">
               <ul>
                  <li>
                     <p>
					Default
				</p>
                  </li>
                  <li>
                     <p>
					Class level
				</p>
                  </li>
                  <li>
                     <p>
					Method level
				</p>
                  </li>
               </ul>
            </div>
            <p>

		An external interceptor instance follows the lifecycle of the target
		bean instance.
	</p>
            <div class="sect5" lang="en">
               <div class="titlepage"/>
		Default interceptors :
	</div>
            <p>
		We will see how class and method-level interceptors can be bound to a
		bean or a bean's method using annotations or xml.
		Default interceptors
		can only be bound via xml. A Default interceptor is an interceptor
		that is invoked whenever a business method
		is invoked on any bean
		within the deployment.
		</p>
            <p>
			
               <code class="literal">org.jboss.tutorial.interceptor.bean.DefaultInterceptor
			</code>
			defines an
			<code class="literal">@AroundInvoke</code>
			method with the required method signature.

			</p>
            <pre class="programlisting">
					
@AroundInvoke
public Object intercept(InvocationContext ctx) throws Exception
{
   System.out.println("*** DefaultInterceptor intercepting " + ctx.getMethod().getName());
   try
   {
      return ctx.proceed();
   }
   finally
   {
      System.out.println("*** DefaultInterceptor exiting");
   }
}

					
			</pre>
            <p>

			As mentioned, default interceptors can only be applied via xml. In
			<code class="literal">META-INF/ejb-jar.xml</code>
			we have the following:

			</p>
            <pre class="programlisting">
					
&lt;assembly-descriptor&gt;
 &lt;!-- Default interceptor that will apply to all methods for all beans in deployment --&gt;
 &lt;interceptor-binding&gt;
      &lt;ejb-name&gt;*&lt;/ejb-name&gt;
      &lt;interceptor-class&gt;org.jboss.tutorial.interceptor.bean.DefaultInterceptor&lt;/interceptor-class&gt;
   &lt;/interceptor-binding&gt;
   ...
&lt;/assembly-descriptor&gt;

					
			</pre>
            <p>

			Using <code class="literal">*</code> for the ejb-name says that <code class="literal">DefaultInterceptor</code> is a default interceptor,
			i.e. it should intercept all calls to all beans within the deployment unit. We could have added more
			<code class="literal">interceptor-class</code> entries to bind more interceptors, as shown here:

			</p>
            <pre class="programlisting">
				
&lt;assembly-descriptor&gt;
   &lt;!-- Default interceptor that will apply to all methods for all beans in deployment --&gt;
   &lt;interceptor-binding&gt;
      &lt;ejb-name&gt;*&lt;/ejb-name&gt;
      &lt;interceptor-class&gt;org.jboss.tutorial.interceptor.bean.DefaultInterceptor&lt;/interceptor-class&gt;
      &lt;interceptor-class&gt;org.jboss.tutorial.interceptor.bean.AnotherInterceptor&lt;/interceptor-class&gt;
   &lt;/interceptor-binding&gt;
   ...
&lt;/assembly-descriptor&gt;

				
			</pre>
            <p>
			In this case <code class="literal">DefaultInterceptor</code> would be invoked before <code class="literal">AnotherInterceptor</code>.

		</p>
            <p>
	
            </p>
            <div class="sect5" lang="en">
               <div class="titlepage"/>
		Class-level interceptors :
	</div>
            <p>
		Class-level interceptors can be bound using xml or annotations.
			</p>
            <div class="sect5" lang="en">
               <div class="titlepage"/>
				Class-level using annotations :
			</div>
            <p>
			
            </p>
            <p>
				
               <code class="literal">org.jbos.tutorial.interceptor.EmailSystemBean</code> has been annotated:

				</p>
            <pre class="programlisting">
					
@Stateless
@Interceptors ({TracingInterceptor.class})
public class EmailSystemBean
{
   ...
}

					
				</pre>
            <p>
				This says that the <code class="literal">@AroundInvoke</code> annotated method of <code class="literal">org.jboss.tutorial.interceptor.bean.TracingInterceptor</code> should wrap all calls
				to <code class="literal">EmailSystemBean</code>'s business methods. The <code class="literal">@Interceptors</code> annotation can take an
				array of classes, so you can bind more than one class-level interceptor this way, e.g.
				</p>
            <pre class="programlisting">
					
@Stateless
@Interceptors ({TracingInterceptor.class, SomeInterceptor.class})
public class EmailSystemBean
{
   ...
}

					
				</pre>
            <p>

			
            </p>
            <p>

			
            </p>
            <div class="sect5" lang="en">
               <div class="titlepage"/>
				Class-level using xml :
			</div>
            <p>
			
            </p>
            <p>
				In the <code class="literal">META-INF/ejb-jar.xml</code> we have the following:

				</p>
            <pre class="programlisting">
					
&lt;assembly-descriptor&gt;
   ...
	  &lt;!-- Class interceptor that will apply to all methods for EmailSystemBean --&gt;
	   &lt;interceptor-binding&gt;
         &lt;ejb-name&gt;EmailSystemBean&lt;/ejb-name&gt;
         &lt;interceptor-class&gt;org.jboss.tutorial.interceptor.bean.OtherInterceptor&lt;/interceptor-class&gt;
      &lt;/interceptor-binding&gt;
   ...
&lt;/assembly-descriptor&gt;

					
				</pre>
            <p>

				Note that here we are specifying the ejb-name of the bean we want to apply the interceptor to.
				Hence, the <code class="literal">@AroundInvoke</code> annotated method of <code class="literal">org.jboss.tutorial.interceptor.bean.OtherInterceptor</code>
				will wrap all calls to <code class="literal">EmailSystemBean</code>'s business methods.
			</p>
            <p>

	
            </p>
            <div class="sect5" lang="en">
               <div class="titlepage"/>
		Method-level interceptors :
	</div>
            <p>
		Just as we can define default and class-level interceptors, we can also bind an interceptor to a particular business method
		of a bean
		</p>
            <div class="sect5" lang="en">
               <div class="titlepage"/>
			Method-level using annotations :
		</div>
            <p>
		
            </p>
            <p>
			
               <code class="literal">org.jboss.tutorial.interceptor.bean.EmailSystemBean</code>'s <code class="literal">sendBookingConfirmationMessage()</code>
			method has been annotated with the @Interceptors annotation specifying interceptors that will intercept when this perticular
			method is invoked.
			</p>
            <pre class="programlisting">
				
@Interceptors({AccountsConfirmInterceptor.class})
public void sendBookingConfirmationMessage(long orderId)
{
   ...
}

				
			</pre>
            <p>

			Method-level interceptors are in addition to default and class-level interceptors, meaning that when we call
			<code class="literal">EmailSystemBean.sendBookingConfirmationMessage()</code> we get intercepted by

			</p>
            <div class="itemizedlist">
               <ul>
                  <li>
                     <p>
						DefaultInterceptor (default)
					</p>
                  </li>
                  <li>
                     <p>
						TracingInterceptor (class-level)
					</p>
                  </li>
                  <li>
                     <p>
						OtherInterceptor (class-level)
					</p>
                  </li>
                  <li>
                     <p>
						AccountsConfirmInterceptor (method-level)
					</p>
                  </li>
               </ul>
            </div>
            <p>

			An interceptor method can choose to abort an invocation, by not calling
			<code class="literal">InvocationContext.proceed()</code>  as is done in <code class="literal">AccountConfirmInterceptor</code>'s interceptor method
			when a confirmation already exists.
		</p>
            <p>

		
            </p>
            <div class="sect5" lang="en">
               <div class="titlepage"/>
			Method-level using xml :
		</div>
            <p>
		
            </p>
            <p>
			We can also bind interceptors to a single business method within a bean using xml.
			But first let's define an interceptor using xml. All the examples we have looked at so far have used the <code class="literal">@AroundInvoke</code>
			annotation to mark the interceptor methods.	In <code class="literal">META-INF/ejb-jar.xml</code> we have the following:
			</p>
            <pre class="programlisting">
				
&lt;interceptors&gt;
     &lt;interceptor&gt;
        &lt;interceptor-class&gt;org.jboss.tutorial.interceptor.bean.AccountsCancelInterceptor&lt;/interceptor-class&gt;
        &lt;around-invoke&gt;
           &lt;method-name&gt;sendCancelMessage&lt;/method-name&gt;
        &lt;/around-invoke&gt;
		...

     &lt;/interceptor&gt;
&lt;/interceptors&gt;

				
			</pre>
            <p>
			This tells us that the <code class="literal">sendCancelMessage()</code> method of <code class="literal">org.jboss.tutorial.interceptor.bean.AccountsCancelInterceptor</code>
			is the interceptor method of this interceptor class. To bind interceptors to a particular method using xml, is much the same as how
			this was done for class-level interceptors apart from that we specify the <code class="literal">method-name</code> of the method we want to intercept.
			From our <code class="literal">META-INF/ejb-jar.xml</code>:
			</p>
            <pre class="programlisting">
				
 &lt;assembly-descriptor&gt;
    ...
	   &lt;!-- Method interceptor will apply to sendBookingCancellationMessage for EmailSystemBean --&gt;
	   &lt;interceptor-binding&gt;
         &lt;ejb-name&gt;EmailSystemBean&lt;/ejb-name&gt;
         &lt;interceptor-class&gt;org.jboss.tutorial.interceptor.bean.AccountsCancelInterceptor&lt;/interceptor-class&gt;
         &lt;method&gt;
           &lt;method-name&gt;sendBookingCancellationMessage&lt;/method-name&gt;
         &lt;/method&gt;
      &lt;/interceptor-binding&gt;

    ...
 &lt;/assembly-descriptor&gt;

				
			</pre>
            <p>
			In the case of overloaded methods, we can further narrow down the method by specifying the method parameters, as in this example:
			</p>
            <pre class="programlisting">
				
&lt;assembly-descriptor&gt;
   	...
	&lt;!-- Method interceptor will apply to sendBookingCancellationMessage for EmailSystemBean --&gt;
	   &lt;interceptor-binding&gt;
         &lt;ejb-name&gt;SomeBean&lt;/ejb-name&gt;
         &lt;interceptor-class&gt;SomeInterceptor&lt;/interceptor-class&gt;
         &lt;method&gt;
           &lt;method-name&gt;methodWithParam&lt;/method-name&gt;
           &lt;method-params&gt;
           		&lt;method-param&gt;int&lt;/method-param&gt;
           		&lt;method-param&gt;java.lang.String[]&lt;/method-param&gt;
           &lt;/method-params&gt;
         &lt;/method&gt;
      &lt;/interceptor-binding&gt;
&lt;/assembly-descriptor&gt;

				
			</pre>
            <p>
			
               <code class="literal">SomeInterceptor</code> will only get applied to the method of <code class="literal">SomeBean</code> that matches the signature,
			i.e. <code class="literal">methodWithParam(int, java.lang.String[])</code>
		
            </p>
            <p>

	
            </p>
            <div class="sect5" lang="en">
               <div class="titlepage"/>
		Exclusion of default and class interceptors :

		<p>
			For some beans we may want to exclude the default interceptors configured for the deployment, and for some methods
			within a bean class we may want to exclude the class interceptors for the bean (and/or the default interceptors)

			</p>
               <div class="sect5" lang="en">
                  <div class="titlepage"/>
				Annotations :

				<p>
					The <code class="literal">@javax.ejb.ExcludeDefaultInterceptors</code> annotation can be applied to a bean class or a method.
					If applied to a bean class, default interceptors will not get invoked for any of that bean class's methods. If applied
					to a bean business method, default interceptors will not get invoked when calling that method.
				</p>
                  <p>
					The <code class="literal">@javax.ejb.ExcludeClassInterceptors</code> annotation can be applied to a bean method. When this annotation
					is used class-level interceptors will not get invoked when calling that method.

				</p>
                  <p>
					
                     <code class="literal">org.jboss.tutorial.interceptor.bean.EmailMDB</code> defines

					</p>
                  <pre class="programlisting">
						
@ExcludeDefaultInterceptors
public class EmailMDB implements MessageListener
{
   ...
}

						
					</pre>
                  <p>
					so <code class="literal">DefaultInterceptor</code> is not invoked when invoking the <code class="literal">EmailMDB.onMessage()</code>
				
                  </p>
                  <p>
					
                     <code class="literal">org.jboss.tutorial.interceptor.bean.EmailSystemBean</code>'s  <code class="literal">noop</code> method is annotated with both
					<code class="literal">@ExcludeClassInterceptors</code> and <code class="literal">@ExcludeDefaultInterceptors</code> and so will not get intercepted
					by any of these.

					</p>
                  <pre class="programlisting">
						
@ExcludeClassInterceptors
@ExcludeDefaultInterceptors
public void noop()
{
   System.out.println("&lt;In EmailSystemBean.noop business method");
   System.out.println("Exiting EmailSystemBean.noop business method&gt;");
}

						
					</pre>
                  <p>
				
                  </p>
               </div>
               <p>

			
               </p>
               <div class="sect5" lang="en">
                  <div class="titlepage"/>
				XML :

				<p>
					We can also exclude class and method-level interceptors within an <code class="literal">interceptor-binding</code> by specifying the
					<code class="literal">exclude-class-interceptors</code> and <code class="literal">exclude-default-interceptors</code> elements.

					</p>
                  <pre class="programlisting">
						
&lt;assembly-descriptor&gt;
      ...

	   &lt;interceptor-binding&gt;
         &lt;ejb-name&gt;EmailSystemBean&lt;/ejb-name&gt;
         &lt;exclude-default-interceptors&gt;true&lt;/exclude-default-interceptors&gt;
         &lt;exclude-class-interceptors&gt;true&lt;/exclude-class-interceptors&gt;
         &lt;method&gt;
           &lt;method-name&gt;noop2&lt;/method-name&gt;
         &lt;/method&gt;
      &lt;/interceptor-binding&gt;
	...
&lt;/assembly-descriptor&gt;
						
					</pre>
                  <p>
				
                  </p>
               </div>
               <p>

		
               </p>
            </div>
            <div class="sect5" lang="en">
               <div class="titlepage"/>
		Inheritance Ordering :

		<p>
			If an interceptor (or bean class) inherits from another class which has a method declared to be an interceptor method,
			the interceptor methods from the super class will be invoked first. However, if the interceptor method in the superclass
			has been overridden (regardless of if the overriding method is declared to be an interceptor method or not) the superclass
			method is not invoked.
		</p>
               <p>
			Both <code class="literal">org.jboss.tutorial.interceptor.bean.AccountsConfirmInterceptor</code> and
			<code class="literal">org.jboss.tutorial.interceptor.bean.AccountsCancelInterceptor</code> inherit from
			<code class="literal">org.jboss.tutorial.interceptor.bean.AccountsInterceptor</code>.
		</p>
               <p>
			AccountsInterceptor declares the following interceptor method:

			</p>
               <pre class="programlisting">
				
@AroundInvoke
public Object intercept(InvocationContext ctx) throws Exception
{
   System.out.println("*** AccountsInterceptor intercepting " + ctx.getMethod().getName());
   try
   {
      return ctx.proceed();
   }
   finally
   {
      System.out.println("*** AccountsInterceptor exiting");
   }
}

				
			</pre>
               <p>
			This method is overridden by <code class="literal">AccountsConfirmInterceptor</code>, even though it is not <code class="literal">AccountsConfirmInterceptor</code>'s
			interceptor method:

			</p>
               <pre class="programlisting">
				
public class AccountsConfirmInterceptor extends AccountsInterceptor
{
   ...
   public Object intercept(InvocationContext ctx) throws Exception
   {
      //overrides AccountsInterceptor.intercept() so that will not be invoked
      return null;
   }


   @AroundInvoke
   public Object sendConfirmMessage(InvocationContext ctx) throws Exception
   {
      ...
   }
}
				
			</pre>
               <p>
			So when invoking <code class="literal">AccountsConfirmInterceptor</code>, we simply invoke its <code class="literal">sendConfirmMessage()</code> method.
			<code class="literal">AccountsCancelInterceptor</code>, on the other hand, does not override <code class="literal">AccountsInterceptor.intercept()</code>,
			so when invoking <code class="literal">AccountsCancelInterceptor</code>, we first get intercepted by <code class="literal">AccountsInterceptor.intercept()</code>
			followed by <code class="literal">AccountsCancelInterceptor.sendCancelMessage()</code>.

		</p>
            </div>
            <div class="sect5" lang="en">
               <div class="titlepage"/>
		Injection in interceptors:
		<div class="sect5" lang="en">
                  <div class="titlepage"/>
			Using Annotations :
			<p>
				Just like a bean class, an interceptor can be the target of dependency injection (see the "injection" tutorial for
				details about injection). The format for how this works is the same, and the injection works off the same ENC as
				the bean to which the interceptor is bound.
			</p>
                  <p>
				
                     <code class="literal">org.jboss.tutorial.interceptor.bean.AccountsConfirmInterceptor</code> has dependency injection set up using annotations:
				</p>
                  <pre class="programlisting">
					
public class AccountsConfirmInterceptor extends AccountsInterceptor
{
   @Resource(mappedName="java:ConnectionFactory")
   QueueConnectionFactory cf;

   @Resource(mappedName="queue/tutorial/accounts")
   Queue queue;

   @PersistenceContext
   EntityManager em;

   ...

					
				</pre>
                  <p>
			
                  </p>
			Remember that interceptors follow the same lifecycle as the bean they are bound to. The interceptors are created at the same
			time as the bean instance is created, and dependecy injection occurs before the first business method is called. In the example
			just shown, the container:
			<div class="itemizedlist">
                     <ul>
                        <li>
                           <p>
						Looks up <code class="literal">java:ConnectionFactory</code>, binds it in the ENC and injects this into the field <code class="literal">cf</code>
					
                           </p>
                        </li>
                        <li>
                           <p>
						Looks up <code class="literal">queue/tutorial/accounts</code>, binds it in the ENC and injects this into the field <code class="literal">queue</code>
					
                           </p>
                        </li>
                        <li>
                           <p>
						Obtains the default EntityManager and injects this into the field <code class="literal">em</code>
					
                           </p>
                        </li>
                     </ul>
                  </div>
               </div>
               <div class="sect5" lang="en">
                  <div class="titlepage"/>
			Using XML :
			<p>
				Injection, into interceptors, can also be configured via xml, using the traditional <code class="literal">ejb-ref</code>, <code class="literal">ejb-local-ref</code>,
				<code class="literal">resource-ref</code>, <code class="literal">resource-env-ref</code> etc. which bind the global names. The only difference
				from beans is that we put this into the {{interceptors}} element defining the interceptor.
				</p>
                  <pre class="programlisting">
					
&lt;interceptors&gt;
     &lt;interceptor&gt;
        &lt;interceptor-class&gt;org.jboss.tutorial.interceptor.bean.AccountsCancelInterceptor&lt;/interceptor-class&gt;
        &lt;around-invoke&gt;
           &lt;method-name&gt;sendCancelMessage&lt;/method-name&gt;
        &lt;/around-invoke&gt;
        &lt;resource-ref&gt;
        	&lt;res-ref-name&gt;jms/ConnFactory&lt;/res-ref-name&gt;
           &lt;res-type&gt;javax.jms.QueueConnectionFactory&lt;/res-type&gt;
           &lt;res-auth&gt;Container&lt;/res-auth&gt;
           &lt;mapped-name&gt;java:/ConnectionFactory&lt;/mapped-name&gt;
           &lt;injection-target&gt;
              &lt;injection-target-class&gt;org.jboss.tutorial.interceptor.bean.AccountsCancelInterceptor&lt;/injection-target-class&gt;
              &lt;injection-target-name&gt;cf&lt;/injection-target-name&gt;
           &lt;/injection-target&gt;
        &lt;/resource-ref&gt;
        &lt;resource-env-ref&gt;
        	&lt;resource-env-ref-name&gt;accountsQueue&lt;/resource-env-ref-name&gt;
           &lt;resource-env-ref-type&gt;javax.jms.Queue&lt;/resource-env-ref-type&gt;
           &lt;mapped-name&gt;queue/tutorial/accounts&lt;/mapped-name&gt;
           &lt;injection-target&gt;
              &lt;injection-target-class&gt;org.jboss.tutorial.interceptor.bean.AccountsCancelInterceptor&lt;/injection-target-class&gt;
              &lt;injection-target-name&gt;queue&lt;/injection-target-name&gt;
           &lt;/injection-target&gt;
        &lt;/resource-env-ref&gt;
     &lt;/interceptor&gt;
&lt;/interceptors&gt;

					
				</pre>
                  <p>
				
                  </p>
                  <div class="itemizedlist">
                     <ul>
                        <li>
                           <p>
							The container looks up <code class="literal">java:/ConnectionFactory</code> in JNDI and creates the <code class="literal">java:comp/env/jms/ConnFactory</code>
							entry in the bean's ENC, and following bean creation it injects the connection factory into <code class="literal">AccountsCancelInterceptor</code>'s
							<code class="literal">cf</code> field.
						</p>
                        </li>
                        <li>
                           <p>
							The container looks up <code class="literal">queue/tutorial/accounts</code> in JNDI and creates the <code class="literal">java:comp/env/accountsQueue</code>
							entry in the bean's ENC, and following bean creation it injects the queue into <code class="literal">AccountsCancelInterceptor</code>'s
							<code class="literal">queue</code> field.						</p>
                        </li>
                     </ul>
                  </div>
                  <p>
			
                  </p>
               </div>
            </div>
            <div class="sect5" lang="en">
               <div class="titlepage"/>
		Interceptor Ordering :
		<p>
			By default the ordering of interceptors when invoking a method are
			</p>
               <div class="itemizedlist">
                  <ul>
                     <li>
                        <p>
						External interceptors
					</p>
                     </li>
                     <li>
                        <p>
						Default interceptors, if present
					</p>
                     </li>
                     <li>
                        <p>
						Class interceptors, if present
					</p>
                     </li>
                     <li>
                        <p>
						Method interceptors, if present
					</p>
                     </li>
                     <li>
                        <p>
						Interceptor method on the bean class (using @AroundInvoke)
					</p>
                     </li>
                  </ul>
               </div>
               <p>
			Within each group (default, class, method) the order of the interceptors are from left to right as defined in the @Interceptors annotation,
			and then the xml interceptors.
		</p>
               <div class="sect5" lang="en">
                  <div class="titlepage"/>
			Overriding interceptor ordering :

			<p>
				You can override the default sort order of the external interceptors by specifiying an <code class="literal">interceptor-binding</code> with an <code class="literal">interceptor-order</code>
				specifying the order of the interceptors
				</p>
                  <pre class="programlisting">
					
&lt;assembly-descriptor&gt;
      &lt;interceptor-binding&gt;
         &lt;ejb-name&gt;EmailSystemBean&lt;/ejb-name&gt;
         &lt;interceptor-order&gt;
            &lt;interceptor-class&gt;org.jboss.tutorial.interceptor.bean.AccountsCancelInterceptor&lt;/interceptor-class&gt;
            &lt;interceptor-class&gt;org.jboss.tutorial.interceptor.bean.DefaultInterceptor&lt;/interceptor-class&gt;
            &lt;interceptor-class&gt;org.jboss.tutorial.interceptor.bean.OtherInterceptor&lt;/interceptor-class&gt;
            &lt;interceptor-class&gt;org.jboss.tutorial.interceptor.bean.TracingInterceptor&lt;/interceptor-class&gt;
         &lt;/interceptor-order&gt;
         &lt;method&gt;
           &lt;method-name&gt;sendBookingCancellationMessage&lt;/method-name&gt;
         &lt;/method&gt;
      &lt;/interceptor-binding&gt;
      ...
&lt;/assembly-descriptor&gt;

					
				</pre>
                  <p>
			
                  </p>
			So when invoking <code class="literal">EmailSystemBean.sendBookingCancellationMessage</code> we will get the following interception order,
			quite different from the default sort order
			<div class="itemizedlist">
                     <ul>
                        <li>
                           <p>
						AccountsCancelInterceptor (method-level)
					</p>
                        </li>
                        <li>
                           <p>
						DefaultInterceptor (default interceptor)
					</p>
                        </li>
                        <li>
                           <p>
						OtherInterceptor (2nd class-level interceptor)
					</p>
                        </li>
                        <li>
                           <p>
						TracingInterceptor (1st class-level interceptor)
					</p>
                        </li>
                     </ul>
                  </div>
               </div>
            </div>
            <div class="sect5" lang="en">
               <div class="titlepage"/>
		InvocationContext :
		<p>
			As you have seen the <code class="literal">@AroundInvoke</code> annotated interceptor methods all take a parameter of type
			<code class="literal">javax.ejb.InvocationContext</code>. The definition of <a xmlns:xlink="http://www.w3.org/1999/xlink" href="http://java.sun.com/javaee/5/docs/api/javax/interceptor/InvocationContext.html">InvocationContext</a> is:

			</p>
               <pre class="programlisting">
				

package javax.interceptor;

public interface InvocationContext {

	public java.lang.Object getTarget();

    public java.lang.reflect.Method getMethod();

	public java.lang.Object[] getParameters();

  	public void setParameters(java.lang.Object[] arg0);

	public java.util.Map getContextData();

	public java.lang.Object proceed() throws java.lang.Exception;
}
				

			</pre>
               <p>

			
               </p>
               <p>
				
                  <code class="literal">getBean()</code> - returns the bean instance on which we are calling a method
			</p>
               <p>
			
               </p>
               <p>
				
                  <code class="literal">getMethod()</code> - returns the method we are calling on the bean instance
			</p>
               <p>
			
               </p>
               <p>
				
                  <code class="literal">getParameters()</code> - returns the parameters for the method call
			</p>
               <p>
			
               </p>
               <p>
				
                  <code class="literal">setParameters()</code> - allows you to modify the parameters for the method call
			</p>
               <p>
			
               </p>
               <p>
				
                  <code class="literal">getContextData</code> - The EJB interceptions are stateless, but the same InvocationContext instance
				is used for each interceptor method in a chain. If you want to pass values between interceptor methods in the
				business method invocation you can store them in the Map retured by getContextData().
			</p>
               <p>
			
               </p>
               <p>
				
                  <code class="literal">proceed</code> - As discussed, invokes the next interceptor, or if we are in the last interceptor
				invokes the target bean method.
			</p>
               <p>

			In some case we might want access to the EJBContext, this can be injected into the interceptor instance using the
			<code class="literal">@Resource</code> annotation. The AroundInvoke methods share the JNDI name space of the bean for whose
			methods they are invoked and execute within the same transaction and security context as the business methods for
			which they are invoked.

		</p>
            </div>
            <div class="sect5" lang="en">
               <div class="titlepage"/>

Building and Running
	<p>
			
               </p>
               <div class="note">
                  <h2>Note</h2>
                  <p>
						To build and run the example, make sure you have installed JBoss 5.x.
						See the <a href="#JBossAS5" title="1.1. JBoss Application Server 5.x">Section 1.1, “JBoss Application Server 5.x”</a> for details.
					</p>
               </div>
               <p>
			From the command prompt, move to the "interceptor" folder under the <a href="#EJB3_TUTORIAL_HOME" title="1.3. Set the EJB3_TUTORIAL_HOME">Section 1.3, “Set the EJB3_TUTORIAL_HOME”</a>
			
               </p>
               <div class="sect5" lang="en">
                  <div class="titlepage"/>
		Ant Users:
			</div>
               <p>
				
               </p>
               <p>
				Make sure your JBossAS-5.x is running
				</p>
               <p>
			
               </p>
               <pre class="programlisting">
			
$ ant
$ ant run

run:
     [java] Starting
     [java]
     [java] Calling emailLostPassword
     [java] Waiting 2 seconds
     [java]
     [java] Calling sendBookingConfirmationMessage
     [java] Waiting 2 seconds
     [java]
     [java] Calling sendBookingConfirmationMessage
     [java] Waiting 2 seconds
     [java]
     [java] Calling sendBookingCancellationMessage
     [java] Waiting 2 seconds
     [java]
     [java] Calling noop
     [java] Waiting 2 seconds
     [java]
     [java] Calling noop2
     [java] Waiting 2 seconds
     [java] Done

		     
			</pre>
               <p>

			
               </p>
               <div class="sect5" lang="en">
                  <div class="titlepage"/>
Maven Users: Make sure the AS is not running.
	</div>
               <p>

	
               </p>
               <pre class="programlisting">
$ mvn clean install -PRunSingleTutorial
			</pre>
               <p>

			
               </p>
               <p>
				
               </p>
               <pre class="programlisting">
					
21:49:01,888 INFO  [STDOUT] *** DefaultInterceptor intercepting emailLostPassword
21:49:01,889 INFO  [STDOUT] *** TracingInterceptor intercepting emailLostPassword
21:49:01,889 INFO  [STDOUT] *** OtherInterceptor intercepting emailLostPassword
21:49:01,889 INFO  [STDOUT] *** EmailSystemBean.myBeanInterceptor - username: whatever
21:49:01,889 INFO  [STDOUT] &lt;In EmailSystemBean.emailLostPassword business method
21:49:02,083 INFO  [STDOUT] Message sent successfully to remote queue.
21:49:02,130 INFO  [STDOUT] Exiting EmailSystemBean.emailLostPassword business method&gt;
21:49:02,130 INFO  [STDOUT] *** OtherInterceptor exiting
21:49:02,130 INFO  [STDOUT] *** TracingInterceptor invocation of org.jboss.tutorial.interceptor.bean.EmailSystemBean.emailLostPassword() took 241ms
21:49:02,130 INFO  [STDOUT] *** DefaultInterceptor exiting
21:49:02,179 WARN  [InterceptorsFactory] EJBTHREE-1246: Do not use InterceptorsFactory with a ManagedObjectAdvisor, InterceptorRegistry should be used via the bean container
21:49:02,180 WARN  [InterceptorsFactory] EJBTHREE-1246: Do not use InterceptorsFactory with a ManagedObjectAdvisor, InterceptorRegistry should be used via the bean container
21:49:02,185 INFO  [STDOUT] *** EmailMDB.mdbInterceptor intercepting
21:49:02,185 INFO  [STDOUT]
----------------
EMailMDB - Got message, sending email
----------------
21:49:04,251 INFO  [STDOUT] *** DefaultInterceptor intercepting sendBookingConfirmationMessage
21:49:04,251 INFO  [STDOUT] *** TracingInterceptor intercepting sendBookingConfirmationMessage
21:49:04,251 INFO  [STDOUT] *** OtherInterceptor intercepting sendBookingConfirmationMessage
21:49:04,251 INFO  [STDOUT] *** AccountsConfirmInterceptor intercepting
21:49:04,395 INFO  [STDOUT] *** AccountsConfirmInterceptor - recording confirmation
21:49:04,431 INFO  [STDOUT] *** AccountsConfirmInterceptor - notifying accounts dept sendBookingConfirmationMessage
21:49:04,440 INFO  [STDOUT] &lt;In EmailSystemBean.sendBookingConfirmationMessage business method
21:49:04,455 WARN  [InterceptorsFactory] EJBTHREE-1246: Do not use InterceptorsFactory with a ManagedObjectAdvisor, InterceptorRegistry should be used via the bean container
21:49:04,455 WARN  [InterceptorsFactory] EJBTHREE-1246: Do not use InterceptorsFactory with a ManagedObjectAdvisor, InterceptorRegistry should be used via the bean container
21:49:04,458 INFO  [STDOUT] *** DefaultInterceptor intercepting onMessage
21:49:04,459 INFO  [STDOUT]
----------------
AccountsMDB - Got message Confirming order 100
----------------
21:49:04,459 INFO  [STDOUT] *** DefaultInterceptor exiting
21:49:04,466 INFO  [STDOUT] Message sent successfully to remote queue.
21:49:04,467 INFO  [STDOUT] Exiting EmailSystemBean.sendBookingConfirmationMessage business method&gt;
21:49:04,467 INFO  [STDOUT] *** AccountsConfirmInterceptor exiting
21:49:04,467 INFO  [STDOUT] *** OtherInterceptor exiting
21:49:04,467 INFO  [STDOUT] *** TracingInterceptor invocation of org.jboss.tutorial.interceptor.bean.EmailSystemBean.sendBookingConfirmationMessage() took 216ms
21:49:04,467 INFO  [STDOUT] *** DefaultInterceptor exiting
21:49:04,478 INFO  [STDOUT] *** EmailMDB.mdbInterceptor intercepting
21:49:04,478 INFO  [STDOUT]
----------------
EMailMDB - Got message, sending email
----------------
21:49:06,533 INFO  [STDOUT] *** DefaultInterceptor intercepting sendBookingConfirmationMessage
21:49:06,533 INFO  [STDOUT] *** TracingInterceptor intercepting sendBookingConfirmationMessage
21:49:06,533 INFO  [STDOUT] *** OtherInterceptor intercepting sendBookingConfirmationMessage
21:49:06,533 INFO  [STDOUT] *** AccountsConfirmInterceptor intercepting
21:49:06,547 INFO  [STDOUT] *** AccountsConfirmInterceptor - order has already been confirmed aborting
21:49:06,548 INFO  [STDOUT] *** AccountsConfirmInterceptor exiting
21:49:06,548 INFO  [STDOUT] *** OtherInterceptor exiting
21:49:06,548 INFO  [STDOUT] *** TracingInterceptor invocation of org.jboss.tutorial.interceptor.bean.EmailSystemBean.sendBookingConfirmationMessage() took 15ms
21:49:06,548 INFO  [STDOUT] *** DefaultInterceptor exiting
21:49:08,577 INFO  [STDOUT] *** AccountsInterceptor intercepting sendBookingCancellationMessage
21:49:08,577 INFO  [STDOUT] *** AccountsCancelInterceptor intercepting sendBookingCancellationMessage
21:49:08,577 INFO  [STDOUT] *** AccountsConfirmInterceptor - notifying accounts dept
21:49:08,593 INFO  [STDOUT] *** DefaultInterceptor intercepting sendBookingCancellationMessage
21:49:08,593 INFO  [STDOUT] *** OtherInterceptor intercepting sendBookingCancellationMessage
21:49:08,593 INFO  [STDOUT] *** TracingInterceptor intercepting sendBookingCancellationMessage
21:49:08,593 INFO  [STDOUT] &lt;In EmailSystemBean.sendBookingCancellationMessage business method
21:49:08,605 INFO  [STDOUT] Message sent successfully to remote queue.
21:49:08,606 INFO  [STDOUT] Exiting EmailSystemBean.sendBookingCancellationMessage business method&gt;
21:49:08,606 INFO  [STDOUT] *** TracingInterceptor invocation of org.jboss.tutorial.interceptor.bean.EmailSystemBean.sendBookingCancellationMessage() took 13ms
21:49:08,606 INFO  [STDOUT] *** OtherInterceptor exiting
21:49:08,606 INFO  [STDOUT] *** DefaultInterceptor exiting
21:49:08,606 INFO  [STDOUT] *** AccountsCancelInterceptor exiting
21:49:08,606 INFO  [STDOUT] *** AccountsInterceptor exiting
21:49:08,617 INFO  [STDOUT] *** EmailMDB.mdbInterceptor intercepting
21:49:08,617 INFO  [STDOUT]
----------------
EMailMDB - Got message, sending email
----------------
21:49:08,620 INFO  [STDOUT] *** DefaultInterceptor intercepting onMessage
21:49:08,620 INFO  [STDOUT]
----------------
AccountsMDB - Got message Cancelling order 100
----------------
21:49:08,620 INFO  [STDOUT] *** DefaultInterceptor exiting
21:49:10,628 INFO  [STDOUT] &lt;In EmailSystemBean.noop business method
21:49:10,628 INFO  [STDOUT] Exiting EmailSystemBean.noop business method&gt;
21:49:12,648 INFO  [STDOUT] &lt;In EmailSystemBean.noop2 business method
21:49:12,648 INFO  [STDOUT] Exiting EmailSystemBean.noop2 business method&gt;

						
					</pre>
               <p>
			
               </p>
               <p>
			
               </p>
               <div class="note">
                  <h2>Note</h2>
                  <p>
					Look at the JBoss console window to see the output of the interceptions taking place, the EmailMDB and AccountsMDB
					might occur in slightly different places since they execute asynchronously.
				</p>
                  <p>
					You can ignore the [WARN] messages:
					</p>
                  <pre class="programlisting">
21:49:02,179 WARN  [InterceptorsFactory] EJBTHREE-1246: Do not use InterceptorsFactory with a ManagedObjectAdvisor, InterceptorRegistry should be used via the bean container
21:49:02,180 WARN  [InterceptorsFactory] EJBTHREE-1246: Do not use InterceptorsFactory with a ManagedObjectAdvisor, InterceptorRegistry should be used via the bean container

					</pre>
                  <p>
				
                  </p>
               </div>
               <p>
		
               </p>
            </div>
         </div>
         <div class="chapter" lang="en">
            <div class="titlepage">
               <div>
                  <div>
                     <h2 class="title">
                        <a id="jboss.xml_deployment_descriptor"/>Chapter 16. Usage of JBoss specific deployment descriptors</h2>
                  </div>
               </div>
            </div>
            <p>
		The EJB 3.0 specification supports the usage of deployment descriptors to describe ejb metadata
		or override most metadata described via annotations. The jboss.xml deployment descriptor describes
		JBoss specific metadata, including remote and local JNDI names, cluster configuration, a security domain,
		additional references, security principal, and container configuration. Annotations which define the ejb
		(e.g. <code class="literal">@Stateful</code>, <code class="literal">@Remote</code>) cannot be overridden.

	</p>
            <div class="sect5" lang="en">
               <div class="titlepage"/>
		jboss.xml :

		<p>
			Take a look at <code class="literal">META-INF/jboss.xml</code>.
			</p>
               <div class="itemizedlist">
                  <ul>
                     <li>
					The <code class="literal">jndi-name</code> element defines the remote JNDI binding for the <code class="literal">ShoppingCartBean</code> stateful session bean.
					This JNDI binding overrides the default binding or a binding specified through the <code class="literal">@RemoteBinding</code> annotation.
					Similarly, the <code class="literal">local-jndi-name</code> element specifies the local JNDI binding.
				</li>
                     <li>
					The <code class="literal">clustered</code> element indicates that the ejb is clustered, with <code class="literal">partition-name</code> and
					<code class="literal">load-balance-policy</code> specifying the cluster name and load balance policy, respectively.
					These elements will override the parameters specified in the <code class="literal">@Clustered</code> annotation.
					In this example, you will see that the <code class="literal">ShoppingCartBean</code> ejb is clustered.
					<div class="note">
                           <h2>Note</h2>
						If you build and run this example with the "default" server configuration, the deployment will
						fail, as the default server configuration does not support clustering. You will have to run this
						example on the "all" server configuration which supports clustering
					</div>
                     </li>
                     <li>
					The <code class="literal">security-domain</code> element specifies a security domain for the ejb, overriding
					any security domain set through the <code class="literal">@SecurityDomain</code> annotation. In this example,
					you will see that a security domain is set through the jboss.xml deployment descriptor and unless a
					Principal and Credential (i.e. user/password) is set in the client, requests to the ejb will fail
					with a javax.ejb.EJBAccessException.

					<div class="note">
                           <h2>Note</h2>
						The jboss.xml shows using the security-domain at a bean level as well at the entire deployment level.
						Each bean can have its own security-domain and will override the one set at the deployment level.
					</div>
                     </li>
                  </ul>
               </div>
               <p>

		
               </p>
            </div>
            <div class="sect5" lang="en">
               <div class="titlepage"/>

Building and Running
	<p>
			
               </p>
               <div class="note">
                  <h2>Note</h2>
                  <p>
						To build and run the example, make sure you have installed JBoss 5.x.
						See the <a href="#JBossAS5" title="1.1. JBoss Application Server 5.x">Section 1.1, “JBoss Application Server 5.x”</a> for details.
					</p>
               </div>
               <p>
			From the command prompt, move to the "jboss_deployment_descriptor" folder under the <a href="#EJB3_TUTORIAL_HOME" title="1.3. Set the EJB3_TUTORIAL_HOME">Section 1.3, “Set the EJB3_TUTORIAL_HOME”</a>
			
               </p>
               <div class="sect5" lang="en">
                  <div class="titlepage"/>
		Ant Users:
			</div>
               <p>
				
               </p>
               <p>
				Make sure the "all" server configuration of JBossAS-5.x is running
				</p>
               <p>
			
               </p>
               <pre class="programlisting">
			
$ ant
$ ant run

run:
     [java] Attempting to buy 1 memory stick with incorrect password
     [java] Caught javax.ejb.EJBAccessException as expected
     [java] Setting user/password
     [java] bill is a shopper, so is allowed to buy
     [java] Buying 1 memory stick
     [java] Buying another memory stick
     [java] Buying a laptop
     [java] Print cart:
     [java] 2     Memory stick
     [java] 1     Laptop
     [java] bill is not a clerk, so is not allowed to price check
     [java] Caught EJBAccessException as expected
     [java] Checkout
     [java] Should throw an object not found exception by invoking on cart after @Remove method
     [java] Successfully caught no such object exception.
     [java] Caught javax.ejb.EJBAccessException, for SLSB, as expected
     [java] Now passing the correct user/password to access the SLSB
     [java] Successfully accessed SLSB

		     
			</pre>
               <p>

			
               </p>
               <div class="sect5" lang="en">
                  <div class="titlepage"/>
Maven Users: Make sure the AS is not running.
	</div>
               <p>

	
               </p>
               <pre class="programlisting">
$ mvn clean install -PRunSingleTutorial
			</pre>
               <p>

		
               </p>
            </div>
         </div>
         <div class="chapter" lang="en">
            <div class="titlepage">
               <div>
                  <div>
                     <h2 class="title">
                        <a id="Quartz_scheduler_integration"/>Chapter 17. Quartz scheduler integration</h2>
                  </div>
               </div>
            </div>
            <p>
		JBossAS comes bundled with Quartz integration packaged as a JCA Message-Inflow resource adapter <code class="literal">quartz-ra.rar</code>.
		This integration allows you to schedule stateless or stateful quartz jobs and have the job be posted to a
		Message Driven bean. The Quartz Resource Adapter creates a non-persistent scheduler. Jobs are created from
		the information in the MDB's activation config spec.
		</p>
            <div class="note">
               <h2>Note</h2>
               <p>
				Currently only cron jobs are allowed to be configured.
			</p>
            </div>
            <p>
	
            </p>
            <p>
		Take a look at the <code class="literal">org.jboss.tutorial.jca_inflow_quartz.bean.AnnotatedQuartzMDBBean</code>:
		</p>
            <pre class="programlisting">
			
@MessageDriven(activationConfig =
{@ActivationConfigProperty(propertyName = "cronTrigger", propertyValue = "0/2 * * * * ?")})
@ResourceAdapter("quartz-ra.rar")
public class AnnotatedQuartzMDBBean implements Job
{
...
			
		</pre>
            <p>
		This is a simple MDB that implements the <code class="literal">org.quartz.Job</code> interface. The <code class="literal">cronTrigger</code>
		activation spec attribute is required. In this you specify a cron syntax as documented in the Quartz documentation.
		The <code class="literal">@org.jboss.ejb3.annotation.ResourceAdapter</code> annotation is used to tell the EJB container which
		resource adapter to use for the inflow implementation.

	</p>
            <div class="sect5" lang="en">
               <div class="titlepage"/>
		Using deployment descriptors :
		<p>
			Instead of using annotations, you can also use a deployment descriptor to configure the MDB for Quartz
			integration. Take a look at <code class="literal">META-INF/ejb-jar.xml</code> and <code class="literal">META-INF/jboss.xml</code>
			The ejb-jar.xml configures the <code class="literal">cronTrigger</code> through the <code class="literal">&lt;activation-config&gt;</code>
			element:

			</p>
               <pre class="programlisting">
				
&lt;message-driven&gt;
   &lt;ejb-name&gt;ExampleMDB&lt;/ejb-name&gt;
   &lt;ejb-class&gt;org.jboss.tutorial.quartz.bean.QuartzMDBBean&lt;/ejb-class&gt;
   &lt;transaction-type&gt;Container&lt;/transaction-type&gt;
   &lt;activation-config&gt;
      &lt;activation-config-property&gt;
         &lt;activation-config-property-name&gt;cronTrigger&lt;/activation-config-property-name&gt;
         &lt;activation-config-property-value&gt;0/2 * * * * ?&lt;/activation-config-property-value&gt;
      &lt;/activation-config-property&gt;


   &lt;/activation-config&gt;
&lt;/message-driven&gt;
				
			</pre>
               <p>
			The jboss.xml configures the <code class="literal">resource-adapter-name</code> :
			</p>
               <pre class="programlisting">
				
&lt;message-driven&gt;
   &lt;ejb-name&gt;ExampleMDB&lt;/ejb-name&gt;
   &lt;resource-adapter-name&gt;quartz-ra.rar&lt;/resource-adapter-name&gt;
&lt;/message-driven&gt;
				
			</pre>
               <p>
		
               </p>
            </div>
            <div class="sect5" lang="en">
               <div class="titlepage"/>

Building and Running
	<p>
			
               </p>
               <div class="note">
                  <h2>Note</h2>
                  <p>
						To build and run the example, make sure you have installed JBoss 5.x.
						See the <a href="#JBossAS5" title="1.1. JBoss Application Server 5.x">Section 1.1, “JBoss Application Server 5.x”</a> for details.
					</p>
               </div>
               <p>
			From the command prompt, move to the "jca_inflow_quartz" folder under the <a href="#EJB3_TUTORIAL_HOME" title="1.3. Set the EJB3_TUTORIAL_HOME">Section 1.3, “Set the EJB3_TUTORIAL_HOME”</a>
			
               </p>
               <div class="sect5" lang="en">
                  <div class="titlepage"/>
		Ant Users:
			</div>
               <p>
				
               </p>
               <p>
				Make sure the "default" server configuration of JBossAS-5.x is running
				</p>
               <p>
			
               </p>
               <pre class="programlisting">
			
$ ant
		     
			</pre>
               <p>
			This will deploy the jar into the JBossAS-5.x server ("default" configuration).

			</p>
               <div class="sect5" lang="en">
                  <div class="titlepage"/>
Maven Users: Make sure the AS is not running.
	</div>
               <p>

	
               </p>
               <pre class="programlisting">
$ mvn clean install -PRunSingleTutorial
			</pre>
               <p>
			This will create the jar in the <code class="literal">target</code> folder of the tutorial. Copy this jar to the deploy folder of JBossAS-5.x
		</p>
            </div>
            <p>
		On the server side when the application is deployed, you will notice these logs:

		</p>
            <pre class="programlisting">
			
18:46:57,053 INFO  [QuartzMDBBean] ************** JOB: job.4.1232457416127
18:46:58,023 INFO  [AnnotatedQuartzMDBBean] ************** here in annotated!!!!
18:46:58,026 INFO  [QuartzMDBBean] ************** JOB: job.2.1232457416077
18:47:00,019 INFO  [AnnotatedQuartzMDBBean] ************** here in annotated!!!!
18:47:00,021 INFO  [QuartzMDBBean] ************** JOB: job.2.1232457416077
18:47:00,023 INFO  [QuartzMDBBean] ************** JOB: job.4.1232457416127
18:47:02,020 INFO  [AnnotatedQuartzMDBBean] ************** here in annotated!!!!
18:47:02,023 INFO  [QuartzMDBBean] ************** JOB: job.2.1232457416077
18:47:03,019 INFO  [QuartzMDBBean] ************** JOB: job.4.1232457416127
18:47:04,022 INFO  [AnnotatedQuartzMDBBean] ************** here in annotated!!!!
18:47:04,024 INFO  [QuartzMDBBean] ************** JOB: job.2.1232457416077
18:47:06,019 INFO  [AnnotatedQuartzMDBBean] ************** here in annotated!!!!
18:47:06,021 INFO  [QuartzMDBBean] ************** JOB: job.2.1232457416077
18:47:06,024 INFO  [QuartzMDBBean] ************** JOB: job.4.1232457416127
18:47:08,019 INFO  [AnnotatedQuartzMDBBean] ************** here in annotated!!!!
18:47:08,021 INFO  [QuartzMDBBean] ************** JOB: job.2.1232457416077
18:47:09,020 INFO  [QuartzMDBBean] ************** JOB: job.4.1232457416127

			
		</pre>
            <p>

	
            </p>
         </div>
         <div class="chapter" lang="en">
            <div class="titlepage">
               <div>
                  <div>
                     <h2 class="title">
                        <a id="JNDI_Bindings"/>Chapter 18. Binding your beans in JNDI</h2>
                  </div>
               </div>
            </div>
            <p>
		By default, when the application is deployed in a jar, session beans will bind to JNDI in the form <code class="literal">ejbName/remote</code> for remote
		interfaces and <code class="literal">ejbName/local</code> in the case of local interfaces. When the EJBs are deployed in an .ear file, the default
		jndi binding will be prepended by the name of the .ear file.  So if the ear file name is <code class="literal">foo.ear</code> the default jndi
		names would be <code class="literal">foo/EJB-NAME/remote</code> and <code class="literal">foo/EJB-NAME/local</code>. You can override this behavior
		by defining your own <code class="literal">@org.jboss.ejb3.annotation.LocalBinding</code> and/or <code class="literal">@org.jboss.ejb3.annotation.RemoteBinding</code>.

	</p>
            <div class="sect5" lang="en">
               <div class="titlepage"/>
		Local Interface JNDI Binding :
		<p>
			To change the JNDI name for your local interface use the <code class="literal">@org.jboss.ejb3.annotation.LocalBinding</code> annotation.
			</p>
               <pre class="programlisting">
				
@Stateless
@LocalBinding(jndiBinding="custom/MySession")
public class MySessionBean implements MySession
{
}

				
			</pre>
               <p>
		
               </p>
            </div>
            <div class="sect5" lang="en">
               <div class="titlepage"/>
		Remote Interface JNDI Binding :
		<p>
			To change the JNDI name for your remote interface use the <code class="literal">@org.jboss.ejb3.annotation.RemoteBinding</code> annotation.

			</p>
               <pre class="programlisting">
				
@Stateless
@RemoteBinding(jndiBinding="custom/remote/MySession")
public class MySessionBean implements MySession
{
}

				
			</pre>
               <p>
		
               </p>
            </div>
            <div class="sect5" lang="en">
               <div class="titlepage"/>
		Persistence unit JNDI Bindings :
		<p>
			Persistence units are not bound into JNDI by default. You can bind them by defining some jboss specific properties
			in persistence.xml.
			</p>
               <pre class="programlisting">
				
&lt;persistence&gt;
   &lt;persistence-unit name="manager1"&gt;
      &lt;jta-data-source&gt;java:/DefaultDS&lt;/jta-data-source&gt;
      &lt;jar-file&gt;MyApp.jar&lt;/jar-file&gt;
      &lt;class&gt;org.acme.Employee&lt;/class&gt;
      &lt;class&gt;org.acme.Person&lt;/class&gt;
      &lt;class&gt;org.acme.Address&lt;/class&gt;
      &lt;properties&gt;
         &lt;property name="jboss.entity.manager.jndi.name" value="java:/Manager1"/&gt;
         &lt;property name="jboss.entity.manager.factory.jndi.name" value="java:/Manager1Factory"/&gt;
      &lt;/properties&gt;
   &lt;/persistence-unit&gt;
&lt;/persistence&gt;

				
			</pre>
               <p>

		
               </p>
            </div>
            <div class="sect5" lang="en">
               <div class="titlepage"/>
		Client :
		<p>
			Open up <code class="literal">org.jboss.tutorial.jndibinding.client.Client</code>.
			You'll see that it looks up the stateless bean under "Calculator". Also notice that there is no Home interface
			and you can begin executing on the stateless bean right away.
		</p>
            </div>
            <div class="sect5" lang="en">
               <div class="titlepage"/>

Building and Running
	<p>
			
               </p>
               <div class="note">
                  <h2>Note</h2>
                  <p>
						To build and run the example, make sure you have installed JBoss 5.x.
						See the <a href="#JBossAS5" title="1.1. JBoss Application Server 5.x">Section 1.1, “JBoss Application Server 5.x”</a> for details.
					</p>
               </div>
               <p>
			From the command prompt, move to the "jndibinding" folder under the <a href="#EJB3_TUTORIAL_HOME" title="1.3. Set the EJB3_TUTORIAL_HOME">Section 1.3, “Set the EJB3_TUTORIAL_HOME”</a>
			
               </p>
               <div class="sect5" lang="en">
                  <div class="titlepage"/>
		Ant Users:
			</div>
               <p>
				
               </p>
               <p>
				Make sure your JBossAS-5.x is running
				</p>
               <p>
			
               </p>
               <pre class="programlisting">
			
$ ant
$ ant run

run:
     [java] 1 + 1 = 2
     [java] 1 - 1 = 0

		     
			</pre>
               <p>

			
               </p>
               <div class="sect5" lang="en">
                  <div class="titlepage"/>
Maven Users: Make sure the AS is not running.
	</div>
               <p>

	
               </p>
               <pre class="programlisting">
$ mvn clean install -PRunSingleTutorial
			</pre>
               <p>
		
               </p>
            </div>
         </div>
         <div class="chapter" lang="en">
            <div class="titlepage">
               <div>
                  <div>
                     <h2 class="title">
                        <a id="Join_Inheritance_in_EJB3_Entities"/>Chapter 19. Introduction Join Inheritance in EJB3 Entities</h2>
                  </div>
               </div>
            </div>
            <p>
		The EJB3 specification allows you to define entities that inherit from one another.
		The inheritance relationships can be reflected in queries as well. So, if you queried based
		on the base class, the query is polymorphic.
	</p>
            <p>
		The tutorial example uses the join table strategy to map an inheritance relationship of
		<code class="literal">org.jboss.tutorial.joininheritance.bean.Pet</code>, which is the base class
		for <code class="literal">org.jboss.tutorial.joininheritance.bean.Cat</code> and
		<code class="literal">org.jboss.tutorial.joininheritance.bean.Dog</code>.
	</p>
            <p>
		With the join table strategy there is a table per class in the hierarchy, but the subclass tables
		only have the extra attribute they define in their subclass. A discriminator column is NOT required
		to differentiate between which class type is persisted in a particular row unlike the single table mapping.
		The persistence manager does not need a discrimiator column to figure out the type.
	</p>
            <p>
		This is what the annotations look like for Pet:
		</p>
            <pre class="programlisting">
			
@Entity
@Inheritance(strategy = InheritanceType.JOINED)
public class Pet implements java.io.Serializable
{
...
			

		</pre>
            <p>

		
            </p>
            <pre class="programlisting">
			
@Entity
@Inheritance(strategy = InheritanceType.JOINED)
public class Dog extends Pet
{
...

			
		</pre>
            <p>
	
            </p>
            <div class="sect5" lang="en">
               <div class="titlepage"/>
		Polymorphic Queries :

		<p>
			
                  <code class="literal">org.jboss.tutorial.joininheritance.bean.PetDAOBean</code> stateless EJB wraps
			some polymorphic queries.

			</p>
               <pre class="programlisting">
				
public List findByWeight(double weight)
{
   return manager.createQuery("from Pet p where p.weight &lt; :weight").setParameter("weight", weight).getResultList();
}


				
			</pre>
               <p>
			Even though the <code class="literal">findByWeight</code> method queries on Pet, either Dog or Cat instances
			can be returned.
		</p>
            </div>
            <div class="sect5" lang="en">
               <div class="titlepage"/>
		Table Mapping :

		<p>
			The table mapping for this example looks like this:
			</p>
               <pre class="programlisting">
				
create table PET (
  ID integer primary key,
  ANIMAL_TYPE varchar,
  NAME varchar,
  WEIGHT double
);

create table CAT (
  ID integer primary key,
  LIVES int
);

create table DOG (
  ID integer primary key,
  NUMBONES int
);

				

			</pre>
               <p>
			The join inheritance mapping is less efficient than the single table strategy as the SQL query is more complicated.
		</p>
            </div>
            <div class="sect5" lang="en">
               <div class="titlepage"/>

Building and Running
	<p>
			
               </p>
               <div class="note">
                  <h2>Note</h2>
                  <p>
						To build and run the example, make sure you have installed JBoss 5.x.
						See the <a href="#JBossAS5" title="1.1. JBoss Application Server 5.x">Section 1.1, “JBoss Application Server 5.x”</a> for details.
					</p>
               </div>
               <p>
			From the command prompt, move to the "joininheritance" folder under the <a href="#EJB3_TUTORIAL_HOME" title="1.3. Set the EJB3_TUTORIAL_HOME">Section 1.3, “Set the EJB3_TUTORIAL_HOME”</a>
			
               </p>
               <div class="sect5" lang="en">
                  <div class="titlepage"/>
		Ant Users:
			</div>
               <p>
				
               </p>
               <p>
				Make sure your JBossAS-5.x is running
				</p>
               <p>
			
               </p>
               <pre class="programlisting">
			
$ ant
$ ant run

run:
     [java] Sox
     [java] Junior

		     
			</pre>
               <p>

			
               </p>
               <div class="sect5" lang="en">
                  <div class="titlepage"/>
Maven Users: Make sure the AS is not running.
	</div>
               <p>

	
               </p>
               <pre class="programlisting">
$ mvn clean install -PRunSingleTutorial
			</pre>
               <p>

		
               </p>
            </div>
            <div class="sect5" lang="en">
               <div class="titlepage"/>
			View the tables and rows:

		<p>
			You can view the tables created by JBoss by going to the
			<a xmlns:xlink="http://www.w3.org/1999/xlink" href="http://localhost:8080/jmx-console/HtmlAdaptor?action=inspectMBean&amp;name=jboss%3Aservice%3DHypersonic%2Cdatabase%3DlocalDB">Hypersonic Service</a>,
			scrolling down to the <code class="literal">startDatabaseManager</code> button and clicking it.
			A Hypersonic SQL window will be minimized, but you can open it up to look at the tables and do queries.

		</p>
            </div>
         </div>
         <div class="chapter" lang="en">
            <div class="titlepage">
               <div>
                  <div>
                     <h2 class="title">
                        <a id="Message_Driven_Beans"/>Chapter 20. Introduction to Message Driven Beans in EJB3</h2>
                  </div>
               </div>
            </div>
            <p>
		This example shows you how to implement an MDB with EJB 3.0 using annotations.

	</p>
            <p>
		Take a look at <code class="literal">org.jboss.tutorial.mdb.bean.ExampleMDB</code>. The @MessageDriven annotation
		defines the bean as an MDB. The <code class="literal">activationConfig</code> attribute contains much of the MDB configuration via
		<code class="literal">@ActivationConfigProperty</code>. Also notice that the MDB source contains properties for
		<code class="literal">destinationType</code> and <code class="literal">destination</code>

	
            </p>
            <p>
		The following is the list of standard Activation Config Properties available from the JCA 1.5 specification.
		Also listed are the respective types and default values where defined.
		</p>
            <div class="informaltable">
               <table border="1">
                  <colgroup>
                     <col/>
                     <col/>
                     <col/>
                     <col/>
                  </colgroup>
                  <thead>
                     <tr>
                        <th>Name</th>
                        <th>Type</th>
                        <th>Remarks</th>
                        <th>Mandatory?</th>
                        <th>Default value</th>
                     </tr>
                  </thead>
                  <tbody>
                     <tr>
                        <td>destination</td>
                        <td>java.lang.String</td>
                        <td>The jndi name of the Queue or Topic</td>
                        <td>Yes</td>
                        <td> </td>
                     </tr>
                     <tr>
                        <td>destinationType</td>
                        <td>java.lang.String</td>
                        <td>The type of destination valid values are javax.jms.Queue or javax.jms.Topic</td>
                        <td>No</td>
                        <td> </td>
                     </tr>
                     <tr>
                        <td>messageSelector</td>
                        <td>java.lang.String</td>
                        <td>The message selector of the subscription</td>
                        <td>No</td>
                        <td> </td>
                     </tr>
                     <tr>
                        <td>acknowledgeMode</td>
                        <td>int</td>
                        <td>The type of acknowledgement when not using transacted jms - valid values AUTO_ACKNOWLEDGE or DUPS_OK_ACKNOWLEDGE</td>
                        <td>No</td>
                        <td>AUTO_ACKNOWLEDGE</td>
                     </tr>
                     <tr>
                        <td>clientID</td>
                        <td>java.lang.String</td>
                        <td>The client id of the connection</td>
                        <td>No</td>
                        <td> </td>
                     </tr>
                     <tr>
                        <td>subscriptionDurability</td>
                        <td>String</td>
                        <td>Whether topic subscriptions are durable. Valid values are Durable or NonDurable</td>
                        <td>No</td>
                        <td>NonDurable</td>
                     </tr>
                     <tr>
                        <td>subscriptionName</td>
                        <td>String</td>
                        <td>The subsription name of the topic subscription</td>
                        <td>No</td>
                        <td> </td>
                     </tr>
                  </tbody>
               </table>
            </div>
            <p>
		The following is the list of Activation Config Properties available as JBoss extensions.

		</p>
            <div class="informaltable">
               <table border="1">
                  <colgroup>
                     <col/>
                     <col/>
                     <col/>
                     <col/>
                  </colgroup>
                  <thead>
                     <tr>
                        <th>Name</th>
                        <th>Type</th>
                        <th>Remarks</th>
                        <th>Mandatory?</th>
                        <th>Default value</th>
                     </tr>
                  </thead>
                  <tbody>
                     <tr>
                        <td>isTopic</td>
                        <td>boolean</td>
                        <td>Sets the destinationType</td>
                        <td>No</td>
                        <td>false</td>
                     </tr>
                     <tr>
                        <td>providerAdapterJNDI</td>
                        <td>java.lang.String</td>
                        <td>The jndi name of the jms provider</td>
                        <td>No</td>
                        <td>java:/DefaultJMSProvider</td>
                     </tr>
                     <tr>
                        <td>user</td>
                        <td>java.lang.String</td>
                        <td>The user id used to connect to the jms server</td>
                        <td>No</td>
                        <td> </td>
                     </tr>
                     <tr>
                        <td>pass</td>
                        <td>java.lang.String</td>
                        <td>The password of the user</td>
                        <td>No</td>
                        <td> </td>
                     </tr>
                     <tr>
                        <td>maxMessages</td>
                        <td>int</td>
                        <td>Read this number of messages before delivering messages to the mdb.
							Each message is delivered individually on the same thread in an attempt to
							avoid context excessive context switching
						</td>
                        <td>No</td>
                        <td>1</td>
                     </tr>
                     <tr>
                        <td>minSession</td>
                        <td>int</td>
                        <td>The minimum number of jms sessions that are available to concurrently deliver messages to this mdb</td>
                        <td>No</td>
                        <td>1</td>
                     </tr>
                     <tr>
                        <td>maxSession</td>
                        <td>int</td>
                        <td>The maximum number of jms sessions that are available to concurrently deliver messages to this mdb</td>
                        <td>No</td>
                        <td>15</td>
                     </tr>
                     <tr>
                        <td>reconnectInterval</td>
                        <td>long</td>
                        <td>The length of time in seconds between attempts to (re-)connect to the jms provider</td>
                        <td>No</td>
                        <td>10 seconds</td>
                     </tr>
                     <tr>
                        <td>keepAlive</td>
                        <td>long</td>
                        <td>The length of time in milliseconds that sessions over the minimum are kept alive</td>
                        <td>No</td>
                        <td>60 seconds</td>
                     </tr>
                     <tr>
                        <td>sessionTransacted</td>
                        <td>boolean</td>
                        <td>Whether the sessions are transacted</td>
                        <td>No</td>
                        <td>true</td>
                     </tr>
                     <tr>
                        <td>useDLQ</td>
                        <td>boolean</td>
                        <td>Whether to use a DLQ handler</td>
                        <td>No</td>
                        <td>true</td>
                     </tr>
                     <tr>
                        <td>dLQJNDIName</td>
                        <td>java.lang.String</td>
                        <td>The JNDI name of the DLQ</td>
                        <td>No</td>
                        <td>queue/DLQ</td>
                     </tr>
                     <tr>
                        <td>dLQHandler</td>
                        <td>java.lang.String</td>
                        <td>The org.jboss.resource.adapter.jms.inflow.DLQHandler implementation class name</td>
                        <td>No</td>
                        <td>org.jboss.resource.adapter.jms.inflow.dlq.GenericDLQHandler</td>
                     </tr>
                     <tr>
                        <td>dLQUser</td>
                        <td>java.lang.String</td>
                        <td>The user id used to make the dlq connection to the jms server</td>
                        <td>No</td>
                        <td> </td>
                     </tr>
                     <tr>
                        <td>dLQPassword</td>
                        <td>java.lang.String</td>
                        <td>The password of the dLQUser</td>
                        <td>No</td>
                        <td> </td>
                     </tr>
                     <tr>
                        <td>dLQClientID</td>
                        <td>java.lang.String</td>
                        <td>The client id of the dlq connection</td>
                        <td>No</td>
                        <td> </td>
                     </tr>
                     <tr>
                        <td>dLQMaxResent</td>
                        <td>int</td>
                        <td>The maximum number of times a message is redelivered before it is sent to the DLQ</td>
                        <td>No</td>
                        <td>5</td>
                     </tr>
                     <tr>
                        <td>redeliverUnspecified</td>
                        <td>boolean</td>
                        <td>Whether to attempt to redeliver a message in an unspecified transaction context</td>
                        <td>No</td>
                        <td>true</td>
                     </tr>
                     <tr>
                        <td>transactionTimeout</td>
                        <td>int</td>
                        <td>Time in seconds for the transaction timeout</td>
                        <td>No</td>
                        <td>Default is the timeout set for the resource manager</td>
                     </tr>
                     <tr>
                        <td>DeliveryActive</td>
                        <td>boolean</td>
                        <td>Whether the MDB should make the subscription at initial deployment or wait for start() or stopDelivery()
                        on the corresponding MBean. You can set this to false if you want to prevent messages from being delivered
                        to the MDB (which is still starting) during server startup</td>
                        <td>No</td>
                        <td>true</td>
                     </tr>
                  </tbody>
               </table>
            </div>
            <p>
	
            </p>
            <div class="sect5" lang="en">
               <div class="titlepage"/>
		The Destination :

		<p>
			The <code class="literal">queue-example-service.xml</code> file defines the queues for this tutorial.
		</p>
            </div>
            <div class="sect5" lang="en">
               <div class="titlepage"/>
		Configuring Default MDB Properties :
		<p>
			You can configure MDBs to have default properties using the <code class="literal">@org.jboss.ejb3.annotation.DefaultActivationSpecs</code>
			annotations. Take a look at <code class="literal">custom-ejb3-interceptors-aop.xml</code>. Here we define a custom container
			configuration domain, <code class="literal">"Custom Message Driven Bean"</code>, that adds a <code class="literal">@DefaultActivationSpecs</code>
			annotation and <code class="literal">destinationType</code> and <code class="literal">destination</code> properties to each MDB using this domain.
			Now take a look at <code class="literal">org.jboss.tutorial.mdb.bean.DefaultedExampleMDB</code>. The MDB is configured to use the
			<code class="literal">"Custom Message Driven Bean"</code> container configuration domain via the <code class="literal">@AspectDomain</code> annotation.
			Note there are no properties defined in the <code class="literal">@MessageDriven</code> annotation (they are all from the defaults).
		</p>
            </div>
            <div class="sect5" lang="en">
               <div class="titlepage"/>

Building and Running
	<p>
			
               </p>
               <div class="note">
                  <h2>Note</h2>
                  <p>
						To build and run the example, make sure you have installed JBoss 5.x.
						See the <a href="#JBossAS5" title="1.1. JBoss Application Server 5.x">Section 1.1, “JBoss Application Server 5.x”</a> for details.
					</p>
               </div>
               <p>
			From the command prompt, move to the "mdb" folder under the <a href="#EJB3_TUTORIAL_HOME" title="1.3. Set the EJB3_TUTORIAL_HOME">Section 1.3, “Set the EJB3_TUTORIAL_HOME”</a>
			
               </p>
               <div class="sect5" lang="en">
                  <div class="titlepage"/>
		Ant Users:
			</div>
               <p>
				
               </p>
               <p>
				Make sure your JBossAS-5.x is running
				</p>
               <p>
			
               </p>
               <pre class="programlisting">
			
$ ant
$ ant run

run:
     [java] Message sent successfully to remote queue queue/tutorial/example
     [java] Message sent successfully to remote queue queue/tutorial/defaultedexample



		     
			</pre>
               <p>

			
               </p>
               <div class="sect5" lang="en">
                  <div class="titlepage"/>
Maven Users: Make sure the AS is not running.
	</div>
               <p>

	
               </p>
               <pre class="programlisting">
$ mvn clean install -PRunSingleTutorial
			</pre>
               <p>

			On the server console, you will notice the following logs:
			</p>
               <pre class="programlisting">
				
15:37:57,148 INFO  [STDOUT] ----------------
15:37:57,148 INFO  [STDOUT] Received defaulted message
15:37:57,148 INFO  [STDOUT] ----------------
15:37:57,210 INFO  [STDOUT] ----------------
15:37:57,210 INFO  [STDOUT] Received message
15:37:57,210 INFO  [STDOUT] ----------------

				
			</pre>
               <p>
		
               </p>
            </div>
         </div>
         <div class="chapter" lang="en">
            <div class="titlepage">
               <div>
                  <div>
                     <h2 class="title">
                        <a id="Message_Driven_Beans_with_deployment_descriptor"/>Chapter 21. Configuring Message Driven Beans through deployment descriptors</h2>
                  </div>
               </div>
            </div>
            <p>
		You configure properties by using the &lt;message-driven&gt; element and sub elements which correspond to the
		<code class="literal">@ActivationConfigProperty</code> annotation.
		</p>
            <p>ejb-jar.xml:</p>
            <p>
		
            </p>
            <pre class="programlisting">
			
&lt;message-driven&gt;
	&lt;ejb-name&gt;ExampleMDB&lt;/ejb-name&gt;
	&lt;ejb-class&gt;org.jboss.tutorial.mdb_deployment_descriptor.bean.ExampleMDB&lt;/ejb-class&gt;
     &lt;transaction-type&gt;Bean&lt;/transaction-type&gt;
     &lt;message-destination-type&gt;javax.jms.Queue&lt;/message-destination-type&gt;
   &lt;activation-config&gt;
      &lt;activation-config-property&gt;
      	&lt;activation-config-property-name&gt;acknowledgeMode&lt;/activation-config-property-name&gt;
      	&lt;activation-config-property-value&gt;AUTO_ACKNOWLEDGE&lt;/activation-config-property-value&gt;
      &lt;/activation-config-property&gt;
    &lt;/activation-config&gt;

&lt;/message-driven&gt;

			
		</pre>
            <p>

		
            </p>
            <p>jboss.xml</p>
            <p>
		
            </p>
            <pre class="programlisting">
			
&lt;message-driven&gt;
   &lt;ejb-name&gt;ExampleMDB&lt;/ejb-name&gt;
   &lt;destination-jndi-name&gt;queue/tutorial/example&lt;/destination-jndi-name&gt;
&lt;/message-driven&gt;
			
		</pre>
            <p>

		The <code class="literal">queue/tutorial/example</code> is configured through the <code class="literal">queue-example-service.xml</code>
	
            </p>
            <div class="sect5" lang="en">
               <div class="titlepage"/>

Building and Running
	<p>
			
               </p>
               <div class="note">
                  <h2>Note</h2>
                  <p>
						To build and run the example, make sure you have installed JBoss 5.x.
						See the <a href="#JBossAS5" title="1.1. JBoss Application Server 5.x">Section 1.1, “JBoss Application Server 5.x”</a> for details.
					</p>
               </div>
               <p>
			From the command prompt, move to the "mdb_deployment_descriptor" folder under the <a href="#EJB3_TUTORIAL_HOME" title="1.3. Set the EJB3_TUTORIAL_HOME">Section 1.3, “Set the EJB3_TUTORIAL_HOME”</a>
			
               </p>
               <div class="sect5" lang="en">
                  <div class="titlepage"/>
		Ant Users:
			</div>
               <p>
				
               </p>
               <p>
				Make sure your JBossAS-5.x is running
				</p>
               <p>
			
               </p>
               <pre class="programlisting">
			
$ ant
$ ant run

run:
     [java] Message sent successfully to remote queue.


		     
			</pre>
               <p>

			
               </p>
               <div class="sect5" lang="en">
                  <div class="titlepage"/>
Maven Users: Make sure the AS is not running.
	</div>
               <p>

	
               </p>
               <pre class="programlisting">
$ mvn clean install -PRunSingleTutorial
			</pre>
               <p>

			On the server console, you will notice the following logs:
			</p>
               <pre class="programlisting">
				
23:37:38,175 INFO  [STDOUT] ----------------
23:37:38,175 INFO  [STDOUT] Received message
23:37:38,175 INFO  [STDOUT] ----------------

				
			</pre>
               <p>
		
               </p>
            </div>
         </div>
         <div class="chapter" lang="en">
            <div class="titlepage">
               <div>
                  <div>
                     <h2 class="title">
                        <a id="Merging_and_Basic_Queries_on_entities"/>Chapter 22. Introduction to merging and querying of entities in EJB3</h2>
                  </div>
               </div>
            </div>
            <p>
		This example shows a bunch of things. First, it introduces the <code class="literal">@Column</code> annotation.
		It also shows how entities can be detached and re-attached to persistence storage using the <code class="literal">EntityManager.merge()</code>.
		It also shows some basic queries.

	</p>
            <div class="sect5" lang="en">
               <div class="titlepage"/>
		@Column :

		<p>
			EJB 3.0 has a complete Object/Relational mapping. You can use the <code class="literal">@Column</code> annotation to specify
			which column in the table your property should map to. Take a look at the <code class="literal">org.jboss.tutorial.merge.bean.Customer</code>
			entity.
			</p>
               <pre class="programlisting">
				
@Column(name = "FIRST")
public String getFirst()
{
   return first;
}

				
			</pre>
               <p>

		
               </p>
            </div>
            <div class="sect5" lang="en">
               <div class="titlepage"/>
		Find by primary key :
		<p>
			The <code class="literal">EntityManager</code> service has a built in find by primary key method:
			</p>
               <pre class="programlisting">
				
&lt;T&gt; find(Class&lt;T&gt;, Object pk)
				
			</pre>
               <p>
			The <code class="literal">org.jboss.tutorial.merge.bean.CustomerDAOBean</code> stateless EJB's <code class="literal">find()</code> method
			wraps remote calls to the EntityManager.
			</p>
               <pre class="programlisting">
				
public Customer find(int id)
{
   return manager.find(Customer.class, id);
}

				
			</pre>
               <p>
		
               </p>
            </div>
            <div class="sect5" lang="en">
               <div class="titlepage"/>
		Queries :
		<p>
			
                  <code class="literal">EntityManager</code> allows you to create query objects on the fly that can be reused over and over,
			or just one time.  Queries also support named parameters. The <code class="literal">org.jboss.tutorial.merge.bean.CustomerDAOBean</code>
			reflects this usage in the <code class="literal">findByLastName</code> method.
			</p>
               <pre class="programlisting">
				
public List findByLastName(String name)
{
   return manager.createQuery("from Customer c where c.last = :name").setParameter("name", name).getResultList();
}

				
			</pre>
               <p>
		
               </p>
            </div>
            <div class="sect5" lang="en">
               <div class="titlepage"/>
		Merging :
		<p>
			The Value Object pattern is built into EJB 3.0. You can detach an object from persistence storage and send it across
			the network to the client. The client can make updates locally to the object, send it back to the server and the changes
			can be merged/synchronized back to the database using the <code class="literal">EntityManager.merge()</code> method.
			This is exactly what the <code class="literal">org.jboss.tutorial.merge.client.Client</code> does.

		</p>
            </div>
            <div class="sect5" lang="en">
               <div class="titlepage"/>

Building and Running
	<p>
			
               </p>
               <div class="note">
                  <h2>Note</h2>
                  <p>
						To build and run the example, make sure you have installed JBoss 5.x.
						See the <a href="#JBossAS5" title="1.1. JBoss Application Server 5.x">Section 1.1, “JBoss Application Server 5.x”</a> for details.
					</p>
               </div>
               <p>
			From the command prompt, move to the "merge" folder under the <a href="#EJB3_TUTORIAL_HOME" title="1.3. Set the EJB3_TUTORIAL_HOME">Section 1.3, “Set the EJB3_TUTORIAL_HOME”</a>
			
               </p>
               <div class="sect5" lang="en">
                  <div class="titlepage"/>
		Ant Users:
			</div>
               <p>
				
               </p>
               <p>
				Make sure your JBossAS-5.x is running
				</p>
               <p>
			
               </p>
               <pre class="programlisting">
			
$ ant
$ ant run

run:
     [java] Create Bill Burke and Monica Smith
     [java] Bill and Monica get married
     [java] Get all the Burkes
     [java] There are now 2 Burkes



		     
			</pre>
               <p>

			
               </p>
               <div class="sect5" lang="en">
                  <div class="titlepage"/>
Maven Users: Make sure the AS is not running.
	</div>
               <p>

	
               </p>
               <pre class="programlisting">
$ mvn clean install -PRunSingleTutorial
			</pre>
               <p>

		
               </p>
            </div>
            <div class="sect5" lang="en">
               <div class="titlepage"/>
			View the tables and rows:

		<p>
			You can view the tables created by JBoss by going to the
			<a xmlns:xlink="http://www.w3.org/1999/xlink" href="http://localhost:8080/jmx-console/HtmlAdaptor?action=inspectMBean&amp;name=jboss%3Aservice%3DHypersonic%2Cdatabase%3DlocalDB">Hypersonic Service</a>,
			scrolling down to the <code class="literal">startDatabaseManager</code> button and clicking it.
			A Hypersonic SQL window will be minimized, but you can open it up to look at the tables and do queries.

		</p>
            </div>
         </div>
         <div class="chapter" lang="en">
            <div class="titlepage">
               <div>
                  <div>
                     <h2 class="title">
                        <a id="EJB2.1_and_EJB3_references"/>Chapter 23. Referencing EJB3 beans in EJB2.1 and vice versa</h2>
                  </div>
               </div>
            </div>
            <p>
		EJB3 beans may reference EJB2.1 and vice versa. This tutorial demonstrates mechanisms for such references.
	</p>
            <div class="sect5" lang="en">
               <div class="titlepage"/>
		EJB2.1 referencing EJB3:
		<p>
		 To start, take a look at the EJB3 SLSB <code class="literal">org.jboss.tutorial.reference21_30.bean.Stateless3Bean</code>,
		 the EJB2.1 SLSB <code class="literal">org.jboss.tutorial.reference21_30.bean.Stateless2Bean</code>
		and the deployment descriptors for the EJB2.1 SLSB <code class="literal">ejb21_app/src/main/resources/META-INF/ejb-jar.xml</code> and
		<code class="literal">ejb21_app/src/main/resources/META-INF/jboss.xml</code>:

			</p>
               <pre class="programlisting">
				
&lt;session&gt;
   	&lt;ejb-name&gt;ejb/Stateless2&lt;/ejb-name&gt;
   	&lt;home&gt;org.jboss.tutorial.reference21_30.bean.Stateless2Home&lt;/home&gt;
   	&lt;remote&gt;org.jboss.tutorial.reference21_30.bean.Stateless2&lt;/remote&gt;
   	&lt;ejb-class&gt;org.jboss.tutorial.reference21_30.bean.Stateless2Bean&lt;/ejb-class&gt;
   	&lt;session-type&gt;Stateless&lt;/session-type&gt;
   	&lt;transaction-type&gt;Container&lt;/transaction-type&gt;
    &lt;ejb-ref&gt;
			&lt;ejb-ref-name&gt;ejb/Stateless3&lt;/ejb-ref-name&gt;
			&lt;ejb-ref-type&gt;Session&lt;/ejb-ref-type&gt;
			&lt;home&gt;org.jboss.tutorial.reference21_30.bean.Stateless3Home&lt;/home&gt;
			&lt;remote&gt;org.jboss.tutorial.reference21_30.bean.Stateless3&lt;/remote&gt;
	&lt;/ejb-ref&gt;
&lt;/session&gt;
				
			</pre>
               <p>
			
               </p>
               <div class="important">
                  <h2>Important</h2>
                  <p>
					Notice, the ejb-jar.xml use a 2.x dtd for this EJB2.x application:
					</p>
                  <pre class="programlisting">
						
&lt;!DOCTYPE ejb-jar PUBLIC "-//Sun Microsystems, Inc.//DTD Enterprise JavaBeans 2.0//EN"
                         "http://java.sun.com/dtd/ejb-jar_2_0.dtd"&gt;
						
					</pre>
                  <p>
				
                  </p>
               </div>
               <p>

			The <code class="literal">ejb-ref</code> element references the 3.0 EJB. This mapping will make available the <code class="literal">Stateless3</code> bean
			in the ENC (java:comp/env) namespace of the <code class="literal">Stateless2</code> EJB.

			</p>
               <div class="important">
                  <h2>Important</h2>
                  <p>
					Observe carefully, the use of <code class="literal">&lt;home&gt;</code> and <code class="literal">&lt;remote&gt;</code> in the <code class="literal">ejb-ref</code>.
					Remember that we can provide a EJB2.1 view for an EJB3 bean. See the "ejb21_client_adaptors" for more details. We have intentionally
					exposed the home and remote view for the EJB3 Stateless3Bean so that it can be referenced by a EJB2.1 bean, without which the EJB2.1
					bean would not have been able to reference this bean through its local ENC (because the home/remote are mandatory for a ejb-ref for EJB2.1 app)
					</p>
                  <pre class="programlisting">
						
@Stateless
@RemoteHome(Stateless3Home.class)
public class Stateless3Bean
{
...
						
					</pre>
                  <p>

					
                  </p>
                  <pre class="programlisting">
						
public interface Stateless3Home extends EJBHome
{

   public Stateless3Remote create() throws java.rmi.RemoteException, javax.ejb.CreateException;
...
						
					</pre>
                  <p>
				
                  </p>
               </div>
               <p>
		
               </p>
            </div>
            <div class="sect5" lang="en">
               <div class="titlepage"/>
		EJB3 referencing EJB2.1 bean:

		<p>
			Two mechanisms for referencing EJB2.1 from a EJB3 are demonstrated. The first mechanism uses annotations exclusively.
			Note the <code class="literal">@EJBs</code> annotation on <code class="literal">org.jboss.tutorial.reference21_30.bean.Stateless3Bean</code>.
			The <code class="literal">name</code> parameter for the <code class="literal">@EJB</code> specifies the name with which the 2.1 EJB will be bound
			in the ENC (java:comp/env) namespace of the <code class="literal">Stateless3Bean</code>. The <code class="literal">mapped-name</code> parameter
			specifies the global JNDI binding of the 2.1 EJB.
			</p>
               <pre class="programlisting">
				
@EJBs(
{@EJB(name = "injected/Stateless2", mappedName = "Stateless2")})
public class Stateless3Bean
{
...
				
			</pre>
               <p>

			
               </p>
               <div class="note">
                  <h2>Note</h2>
                  <p>
					The <code class="literal">testAccess</code> method in the <code class="literal">Stateless3Bean</code> looks up this EJB2.1 using the
					ENC jndi-name:
					</p>
                  <pre class="programlisting">
						
Stateless2Home home = (Stateless2Home) jndiContext.lookup(Container.ENC_CTX_NAME + "/env/injected/Stateless2");
Stateless2 test2 = home.create();
						
					</pre>
                  <p>
					Also note that since the bean being looked up is a EJB2.1 bean, the lookup will return the home interface of the bean.
				</p>
               </div>
               <p>

			The second mechanism of referencing a EJB2.1 bean in a EJB3 bean is through the deployment descriptors. Take a look at the
			<code class="literal">ejb3_app/src/main/resources/META-INF/ejb-jar.xml</code> and <code class="literal">ejb3_app/src/main/resources/META-INF/jboss.xml</code>
			
               </p>
               <pre class="programlisting">
				
&lt;session&gt;
	&lt;ejb-name&gt;Stateless3Bean&lt;/ejb-name&gt;
	&lt;ejb-ref&gt;
		&lt;ejb-ref-name&gt;ejb/Stateless2&lt;/ejb-ref-name&gt;
		&lt;ejb-ref-type&gt;Session&lt;/ejb-ref-type&gt;
	&lt;/ejb-ref&gt;
&lt;/session&gt;
				
			</pre>
               <p>
			
               </p>
               <div class="important">
                  <h2>Important</h2>
                  <p>
					The ejb-jar.xml should use the ejb-jar 3.0 xsd:
					</p>
                  <pre class="programlisting">
						
&lt;ejb-jar
        xmlns="http://java.sun.com/xml/ns/javaee"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="http://java.sun.com/xml/ns/javaee
                            http://java.sun.com/xml/ns/javaee/ejb-jar_3_0.xsd"
        version="3.0"&gt;
        				
					</pre>
                  <p>
				
                  </p>
               </div>
               <p>
			This binds the Stateless2 bean to the ENC (java:comp/env) namespace of the Stateless3Bean. Also take a look at the
			<code class="literal">ejb3_app/src/main/resources/META-INF/jboss.xml</code> which maps the global jndi name of the Stateless2
			bean with the ejb-ref-name.

			</p>
               <pre class="programlisting">
				
&lt;session&gt;
	&lt;ejb-name&gt;Stateless3Bean&lt;/ejb-name&gt;
	&lt;ejb-ref&gt;
		&lt;ejb-ref-name&gt;ejb/Stateless2&lt;/ejb-ref-name&gt;
		&lt;jndi-name&gt;Stateless2&lt;/jndi-name&gt;
	&lt;/ejb-ref&gt;
&lt;/session&gt;
				
			</pre>
               <p>
			This reference is then used to inject the Stateless2 bean in the Stateless3Bean using <code class="literal">@EJB</code> annotation:
			</p>
               <pre class="programlisting">
				
@EJB (name="ejb/Stateless2")
private Stateless2Home stateless2Home;

				
			</pre>
               <p>

			
               </p>
               <div class="note">
                  <h2>Note</h2>
				The <code class="literal">org.jboss.tutorial.reference21_30.bean.Stateless3Bean</code> also exposes a business-remote interface, so
				that the <code class="literal">org.jboss.tutorial.reference21_30.servlet.EJBReferenceServlet</code> can use the business-remote interface.
				<pre class="programlisting">
					
@Stateless
@Remote(Stateless3.class)
@RemoteBinding(jndiBinding = "Stateless3")
public class Stateless3Bean
{
...
					
				</pre>
               </div>
               <p>

			
               </p>
               <div class="important">
                  <h2>Important</h2>
                  <p>
					There's a very important difference between the <code class="literal">remote</code> and a <code class="literal">business-remote</code>
					interface. The EJB2.x remote interfaces, which extend from EJBObject, are referred through the <code class="literal">&lt;remote&gt;</code>
					tag in the ejb-jar.xml. On the other hand, the EJB3 style Plain Old Java Interface which is implemented by your EJB3 style
					POJO bean is known as the business-remote interface and is represented by the <code class="literal">@Remote</code> and it's
					corresponding <code class="literal">&lt;business-remote&gt;</code> tag in ejb-jar.xml.

					Similar is the case with <code class="literal">&lt;local&gt;</code> and the <code class="literal">&lt;business-local&gt;</code> tags in ejb-jar.xml.
				</p>
               </div>
               <p>
		
               </p>
            </div>
            <div class="sect5" lang="en">
               <div class="titlepage"/>
Building and Running
	</div>
            <div class="note">
               <h2>Note</h2>
               <p>
	To build and run the example, make sure you have installed JBoss 5.x.
	See the <a href="#JBossAS5" title="1.1. JBoss Application Server 5.x">Section 1.1, “JBoss Application Server 5.x”</a> for details.
			</p>
            </div>
            <p>
			From the command prompt, move to the "reference21_30" folder under the <a href="#EJB3_TUTORIAL_HOME" title="1.3. Set the EJB3_TUTORIAL_HOME">Section 1.3, “Set the EJB3_TUTORIAL_HOME”</a>
		
            </p>
            <div class="sect5" lang="en">
               <div class="titlepage"/>
Ant Users:
	</div>
            <p>
		Make sure your JBossAS-5.x is running
		</p>
            <pre class="programlisting">
	
$ ant
     
	</pre>
            <p>
		This will deploy the ear into the JBossAS-5.x server ("default" configuration).
	</p>
            <div class="sect5" lang="en">
               <div class="titlepage"/>
		To access the servlet, open a web browser and enter <a xmlns:xlink="http://www.w3.org/1999/xlink" href="http://localhost:8080/jboss-ejb3-tutorial-reference21_30_webapp">http://localhost:8080/jboss-ejb3-tutorial-reference21_30_webapp</a>.
		This will bring up a page where you can click on the <code class="literal">Test</code> button to check that the EJB2.1 and EJB3 beans are referencing
		each other.
	</div>
            <div class="sect5" lang="en">
               <div class="titlepage"/>
Maven Users: Make sure the AS is not running.
	</div>
            <pre class="programlisting">
$ mvn clean install -PRunSingleTutorial
	</pre>
            <p>
		This will create the EAR in the <code class="literal">target</code> folder of the tutorial. Copy this EAR to the deploy folder of JBossAS-5.x
		and start the server (if it's already not started). Then follow the steps mentioned above, to access the servlet from the web browser.
	</p>
         </div>
         <div class="chapter" lang="en">
            <div class="titlepage">
               <div>
                  <div>
                     <h2 class="title">
                        <a id="EJB3_Entity_Relationships"/>Chapter 24. Introduction to relationships between EJB3 entities</h2>
                  </div>
               </div>
            </div>
            <p>
		The "entity" tutorial only showed one-to-many and many-to-one relationships.
		This tutorial will show you one-to-one and many-to-many relationships.
	</p>
            <div class="sect5" lang="en">
               <div class="titlepage"/>
		One-to-One :
		<p>
			There is a unidirectional one-to-one relationship defined between the <code class="literal">org.jboss.tutorial.relationships.bean.Customer</code>
			and <code class="literal">org.jboss.tutorial.relationships.bean.Address</code>. Customer defines the uni-directional relationship.
		</p>
               <pre class="programlisting">
			
@OneToOne(cascade = {CascadeType.ALL})
@JoinColumn(name = "ADDRESS_ID")
public Address getAddress()
{
   return address;
}

			
		</pre>
               <p>
			
                  <code class="literal">CascadeType.ALL</code> specifies that when a Customer is created, if there is any
			Address association, then that Address will be created as well(<code class="literal">CascadeType.PERSIST</code>).
			If the Customer is deleted from persistence storage, the Address will be deleted(<code class="literal">CascadeType.REMOVE</code>).
			If a Customer instance is re-attached to persistence storage, any changes to the Address collection will be merged with
			persistence storage (<code class="literal">CascadeType.MERGE</code>).
		</p>
            </div>
            <div class="sect5" lang="en">
               <div class="titlepage"/>
		Many-To-Many :
		<p>
			There is a many-to-many relationship between <code class="literal">org.jboss.tutorial.relationships.bean.Customer</code>
			and <code class="literal">org.jboss.tutorial.relationships.bean.Flight</code>. In order to have a many-to-many relationship
			there needs to be a distinct join table that maps the many-to-many relationship. This is called an association table.
			 You can have JBoss automatically generate the association table for you, or you can use the <code class="literal">@JoinTable</code>
			 annotation to define it yourself. If you use <code class="literal">@JoinTable</code> it must be defined on both sides of the
			 bi-directional relationship.  Let's look at the Customer side of the relationship:
			 </p>
               <pre class="programlisting">
			 	
@ManyToMany(cascade = {CascadeType.PERSIST, CascadeType.MERGE}, fetch = FetchType.EAGER, mappedBy="customers")
			 	
			 </pre>
               <p>
			 
               </p>
               <p>
			 	The <code class="literal">mappedBy</code> attribute states that the <code class="literal">Flight.customers</code> property is responsible
			 	for mapping and managing the relationship. The spec allows for multiple join and inverse join columns.
			 	See the "Composite Primary Key" tutorial for more information.
			</p>
               <p>
			Let's look at the other side of the relationship in Flight.
			</p>
               <pre class="programlisting">
				
@ManyToMany(cascade = {CascadeType.PERSIST, CascadeType.MERGE}, fetch = FetchType.EAGER)
@JoinTable(table = @Table(name = "flight_customer_table"),
                  joinColumns = {@JoinColumn(name = "FLIGHT_ID")},
                  inverseJoinColumns = {@JoinColumn(name = "CUSTOMER_ID")})
public Set&lt;Customer&gt; getCustomers()
{
   return customers;
}

				
			</pre>
               <p>
			The database associate table will look like this:

			</p>
               <pre class="programlisting">
				
create table FLIGHT_CUSTOMER_TABLE (
      CUSTOMER_ID integer,
      FLIGHT_ID integer
   );
				
			</pre>
               <p>
		
               </p>
            </div>
            <div class="sect5" lang="en">
               <div class="titlepage"/>

Building and Running
	<p>
			
               </p>
               <div class="note">
                  <h2>Note</h2>
                  <p>
						To build and run the example, make sure you have installed JBoss 5.x.
						See the <a href="#JBossAS5" title="1.1. JBoss Application Server 5.x">Section 1.1, “JBoss Application Server 5.x”</a> for details.
					</p>
               </div>
               <p>
			From the command prompt, move to the "relationships" folder under the <a href="#EJB3_TUTORIAL_HOME" title="1.3. Set the EJB3_TUTORIAL_HOME">Section 1.3, “Set the EJB3_TUTORIAL_HOME”</a>
			
               </p>
               <div class="sect5" lang="en">
                  <div class="titlepage"/>
		Ant Users:
			</div>
               <p>
				
               </p>
               <p>
				Make sure your JBossAS-5.x is running
				</p>
               <p>
			
               </p>
               <pre class="programlisting">
			
$ ant
$ ant run

run:
     [java] Air France customers
     [java] Bill
     [java] Monica
     [java] USAir customers
     [java] Molly



		     
			</pre>
               <p>

			
               </p>
               <div class="sect5" lang="en">
                  <div class="titlepage"/>
Maven Users: Make sure the AS is not running.
	</div>
               <p>

	
               </p>
               <pre class="programlisting">
$ mvn clean install -PRunSingleTutorial
			</pre>
               <p>

		
               </p>
            </div>
            <div class="sect5" lang="en">
               <div class="titlepage"/>
			View the tables and rows:

		<p>
			You can view the tables created by JBoss by going to the
			<a xmlns:xlink="http://www.w3.org/1999/xlink" href="http://localhost:8080/jmx-console/HtmlAdaptor?action=inspectMBean&amp;name=jboss%3Aservice%3DHypersonic%2Cdatabase%3DlocalDB">Hypersonic Service</a>,
			scrolling down to the <code class="literal">startDatabaseManager</code> button and clicking it.
			A Hypersonic SQL window will be minimized, but you can open it up to look at the tables and do queries.

		</p>
            </div>
         </div>
         <div class="chapter" lang="en">
            <div class="titlepage">
               <div>
                  <div>
                     <h2 class="title">
                        <a id="Using_resource_references_in_EJB3"/>Chapter 25. Introduction to binding the resources to ENC of EJB3 beans</h2>
                  </div>
               </div>
            </div>
            <p>
		Resources (e.g. data sources, JavaMail sessions, JMS queues) may be added to the local jndi namespace (ENC)
		of individual EJBs. This is to separate the jndi names used in the bean code from the global jndi bindings
		set by the bean deployer. The mapping of the bean local jndi binding and the global binding may be handled
		via the ejb-jar.xml and jboss.xml deployment descriptors.
	</p>
            <div class="sect5" lang="en">
               <div class="titlepage"/>
		ejb-jar.xml :

		<p>
			Take a look at <code class="literal">META-INF/ejb-jar.xml</code>. For <code class="literal">ENCBean</code>, there are 3
			<code class="literal">&lt;resource-ref&gt;</code> elements indicating resource reference names and types.

		</p>
            </div>
            <div class="sect5" lang="en">
               <div class="titlepage"/>
		jboss.xml :
		<p>
			Take a look at <code class="literal">META-INF/jboss.xml</code>. For <code class="literal">ENCBean</code>, there are again
			3 <code class="literal">&lt;resource-ref&gt;</code> elements indicating resource reference names and either the global jndi
			binding via the <code class="literal">&lt;jndi-name&gt;</code> element or the resource name. Resource managers
			are used to map resource names to global jndi bindings via the <code class="literal">&lt;resource-managers&gt;</code> element.

		</p>
            </div>
            <div class="sect5" lang="en">
               <div class="titlepage"/>
		TestENCBean.java :
		<p>
			Take a look at <code class="literal">org.jboss.tutorial.resource_ref.bean.TestENCBean</code>. Each one of the resources are accessed from the
			bean local jndi namespace (i.e. java:comp/env) by the value set in the <code class="literal">&lt;res-ref-name&gt;</code> values
			in the deployment descriptors.
		</p>
            </div>
            <div class="sect5" lang="en">
               <div class="titlepage"/>

Building and Running
	<p>
			
               </p>
               <div class="note">
                  <h2>Note</h2>
                  <p>
						To build and run the example, make sure you have installed JBoss 5.x.
						See the <a href="#JBossAS5" title="1.1. JBoss Application Server 5.x">Section 1.1, “JBoss Application Server 5.x”</a> for details.
					</p>
               </div>
               <p>
			From the command prompt, move to the "resource_ref" folder under the <a href="#EJB3_TUTORIAL_HOME" title="1.3. Set the EJB3_TUTORIAL_HOME">Section 1.3, “Set the EJB3_TUTORIAL_HOME”</a>
			
               </p>
               <div class="sect5" lang="en">
                  <div class="titlepage"/>
		Ant Users:
			</div>
               <p>
				
               </p>
               <p>
				Make sure your JBossAS-5.x is running
				</p>
               <p>
			
               </p>
               <pre class="programlisting">
			
$ ant
$ ant run

run:
     [java] Successfully accessed bean resource references

		     
			</pre>
               <p>

			
               </p>
               <div class="sect5" lang="en">
                  <div class="titlepage"/>
Maven Users: Make sure the AS is not running.
	</div>
               <p>

	
               </p>
               <pre class="programlisting">
$ mvn clean install -PRunSingleTutorial
			</pre>
               <p>

		
               </p>
            </div>
            <p>
		On the server you will notice these logs:
		</p>
            <pre class="programlisting">
			
13:44:09,500 INFO  [TestENCBean] Found data source resource ref
13:44:09,500 INFO  [TestENCBean] Found mail resource ref
13:44:09,500 INFO  [TestENCBean] Found jms queue resource ref
13:44:09,500 INFO  [TestENCBean] Found jms queue resource env ref

			
		</pre>
            <p>
	
            </p>
         </div>
         <div class="chapter" lang="en">
            <div class="titlepage">
               <div>
                  <div>
                     <h2 class="title">
                        <a id="Secondary_Tables_for_EJB3_Entities"/>Chapter 26. Introduction to Secondary tables for EJB3 entities</h2>
                  </div>
               </div>
            </div>
            <p>
		The EJB specification allows you to map an entity bean to multiple tables. You do this by using the <code class="literal">@SecondaryTable</code>
		annotation.
	</p>
            <p>
		The <code class="literal">org.jboss.tutorial.secondary.bean.Customer</code> entity maps its address properties to a
		separate ADDRESS table. The first thing it does is define the secondary table.
		</p>
            <pre class="programlisting">
			
@Entity
@Table(name = "CUSTOMER")
@SecondaryTable(name = "EMBEDDED_ADDRESS", join = {@JoinColumn(name = "ADDRESS_ID")})
public class Customer implements java.io.Serializable
{
}
			
		</pre>
            <p>
		The <code class="literal">@JoinColumn</code> of the secondary table must match the value of the Customer's primary key. To map
		individual properties to a secondary table you use the <code class="literal">secondaryTable</code> member value of <code class="literal">@Column</code>.
		</p>
            <pre class="programlisting">
			
@Column(name = "STREET", secondaryTable = "EMBEDDED_ADDRESS")
public String getStreet()
{
   return street;
}

			
		</pre>
            <p>
	
            </p>
            <div class="sect5" lang="en">
               <div class="titlepage"/>

Building and Running
	<p>
			
               </p>
               <div class="note">
                  <h2>Note</h2>
                  <p>
						To build and run the example, make sure you have installed JBoss 5.x.
						See the <a href="#JBossAS5" title="1.1. JBoss Application Server 5.x">Section 1.1, “JBoss Application Server 5.x”</a> for details.
					</p>
               </div>
               <p>
			From the command prompt, move to the "secondary" folder under the <a href="#EJB3_TUTORIAL_HOME" title="1.3. Set the EJB3_TUTORIAL_HOME">Section 1.3, “Set the EJB3_TUTORIAL_HOME”</a>
			
               </p>
               <div class="sect5" lang="en">
                  <div class="titlepage"/>
		Ant Users:
			</div>
               <p>
				
               </p>
               <p>
				Make sure your JBossAS-5.x is running
				</p>
               <p>
			
               </p>
               <pre class="programlisting">
			
$ ant
$ ant run

run:
     [java] Create Bill Burke and Monica Smith
     [java] Bill and Monica get married
     [java] Get all the Burkes
     [java] There are now 2 Burkes



		     
			</pre>
               <p>

			
               </p>
               <div class="sect5" lang="en">
                  <div class="titlepage"/>
Maven Users: Make sure the AS is not running.
	</div>
               <p>

	
               </p>
               <pre class="programlisting">
$ mvn clean install -PRunSingleTutorial
			</pre>
               <p>

		
               </p>
            </div>
            <div class="sect5" lang="en">
               <div class="titlepage"/>
			View the tables and rows:

		<p>
			You can view the tables created by JBoss by going to the
			<a xmlns:xlink="http://www.w3.org/1999/xlink" href="http://localhost:8080/jmx-console/HtmlAdaptor?action=inspectMBean&amp;name=jboss%3Aservice%3DHypersonic%2Cdatabase%3DlocalDB">Hypersonic Service</a>,
			scrolling down to the <code class="literal">startDatabaseManager</code> button and clicking it.
			A Hypersonic SQL window will be minimized, but you can open it up to look at the tables and do queries.

		</p>
            </div>
         </div>
         <div class="chapter" lang="en">
            <div class="titlepage">
               <div>
                  <div>
                     <h2 class="title">
                        <a id="Security_and_Transactions_in_EJB3"/>Chapter 27. Introduction to Security and Transactions in EJB3</h2>
                  </div>
               </div>
            </div>
            <p>
		The EJB 3.0 specification has made the XML deployment descriptors optional. This tutorial goes over how to
		use the transaction and security annotations of EJB 3.0.

	</p>
            <div class="sect5" lang="en">
               <div class="titlepage"/>
		Transactions :
		<p>
			Using transactions is easy, just use the <span class="ERROR">&lt;listing&gt;javax.ejb.TransactionAttribute&lt;/listing&gt;</span> annotation.
			The <code class="literal">javax.ejb.TransactionAttributeType</code> enum has every transactional type. Here's an example
			for using REQUIRES_NEW transaction type:
			</p>
               <pre class="programlisting">
				
@TransactionAttribute(TransactionAttributeType.REQUIRES_NEW)
public int add(int x, int y)
{
   return x + y;
}

				
			</pre>
               <p>

		
               </p>
            </div>
            <div class="sect5" lang="en">
               <div class="titlepage"/>
		Security :
		<p>
			Take a look at <code class="literal">org.jboss.tutorial.security.bean.CalculatorBean</code>. The <code class="literal">@javax.annotation.security.RolesAllowed</code>
			and <code class="literal">@javax.annotation.security.PermitAll</code> are the EJB 3.0 security annotations. You can attach a method permission to any method
			and define which roles are allowed to invoke on that method. The <code class="literal">javax.ejb.RunAs</code> annotation can also be applied at the class
			level. There is also an additional JBoss specific annotation that you must supply at the class level <code class="literal">@org.jboss.ejb3.annotation.SecurityDomain</code>.
			The <code class="literal">@SecurityDomain</code> specifies the JAAS application-policy name which will be used by JBoss to authenticate and authorize.
			See the JBoss Application Server documentation for more details. In this particular example, the "other" domain is used.
			The "other" domain corresponds to a users.properties and roles.properties files that contain cleartext user, password, and user/role associations.
			If you open the tutorial jar file you will see these two files in there.

		</p>
            </div>
            <div class="sect5" lang="en">
               <div class="titlepage"/>
		Client :
		<p>
			Open up <code class="literal">org.jboss.tutorial.security.client.Client</code>. You'll see that it looks up the stateless bean.
			Also notice that there is no Home interface and you can begin executing on the stateless bean right away.
			The client uses a JBoss's SecurityClient class to pass the user name and password:
			</p>
               <pre class="programlisting">
				
import org.jboss.security.client.SecurityClient;
import org.jboss.security.client.SecurityClientFactory;

SecurityClient securityClient = SecurityClientFactory.getSecurityClient();
securityClient.setSimple("kabir", "invalidpassword");
securityClient.login();
				
			</pre>
               <p>
			
               </p>
               <div class="note">
                  <h2>Note</h2>
                  <p>See the documentation of org.jboss.security.client.SecurityClient for more options</p>
               </div>
               <p>
		
               </p>
            </div>
            <div class="sect5" lang="en">
               <div class="titlepage"/>

Building and Running
	<p>
			
               </p>
               <div class="note">
                  <h2>Note</h2>
                  <p>
						To build and run the example, make sure you have installed JBoss 5.x.
						See the <a href="#JBossAS5" title="1.1. JBoss Application Server 5.x">Section 1.1, “JBoss Application Server 5.x”</a> for details.
					</p>
               </div>
               <p>
			From the command prompt, move to the "security" folder under the <a href="#EJB3_TUTORIAL_HOME" title="1.3. Set the EJB3_TUTORIAL_HOME">Section 1.3, “Set the EJB3_TUTORIAL_HOME”</a>
			
               </p>
               <div class="sect5" lang="en">
                  <div class="titlepage"/>
		Ant Users:
			</div>
               <p>
				
               </p>
               <p>
				Make sure your JBossAS-5.x is running
				</p>
               <p>
			
               </p>
               <pre class="programlisting">
			
$ ant
$ ant run

run:
     [java] Kabir is a student.
     [java] Kabir types in the wrong password
     [java] Authentication exception, principal=kabir
     [java] Kabir types in correct password.
     [java] Kabir does unchecked addition.
     [java] 1 + 1 = 2
     [java] Kabir is not a teacher so he cannot do division
     [java] Insufficient method permissions, principal=kabir, interface=org.jboss.ejb3.EJBContainerInvocation, requiredRoles=[teacher], principalRoles=[student]
     [java] Students are allowed to do subtraction
     [java] 1 - 1 = 0

		     
			</pre>
               <p>

			
               </p>
               <div class="sect5" lang="en">
                  <div class="titlepage"/>
Maven Users: Make sure the AS is not running.
	</div>
               <p>

	
               </p>
               <pre class="programlisting">
$ mvn clean install -PRunSingleTutorial
			</pre>
               <p>

		
               </p>
               <div class="note">
                  <h2>Note</h2>
                  <p>
				If you want to change the roles for the user, through the roles.properties, you will have to
				restart the server, for the role changes to take effect. This is because by default JBoss caches the roles for a
				user and until the cache is flushed, either through this <a xmlns:xlink="http://www.w3.org/1999/xlink" href="http://www.jboss.org/community/docs/DOC-9246">configuration</a>
				or through server restart, the changes won't take effect.
			</p>
               </div>
            </div>
         </div>
         <div class="chapter" lang="en">
            <div class="titlepage">
               <div>
                  <div>
                     <h2 class="title">
                        <a id="Service_POJOs"/>Chapter 28. Service POJOs (JBoss extension of EJB3)</h2>
                  </div>
               </div>
            </div>
            <p>
		Service POJOs allow you to define POJOs as JBoss services. The way you define them is very similar
		to how you define stateless or stateful session beans. One very important difference is that there
		will only ever be ONE instance of the service bean. i.e. it is not pooled - the bean instance is a
		singleton. The singleton bean contains shared state, so data set by one client is accessible by other clients.
	</p>
            <p>
		Take a look at <code class="literal">org.jboss.tutorial.service.bean.ServiceOne.java</code>.
		It has been annotated with <code class="literal">@org.jboss.ejb3.annotation.Service</code>, this defines it as a
		singleton service in JBoss. It implements <code class="literal">org.jboss.tutorial.service.bean.ServiceOneRemote</code>
		and <code class="literal">org.jboss.tutorial.service.bean.ServiceOneLocal</code> just as you would do for a normal stateful/stateless bean.
	</p>
            <p>
		ServiceOne also implements <code class="literal">org.jboss.tutorial.service.bean.ServiceOneManagement</code>.
		<code class="literal">org.jboss.tutorial.service.bean.ServiceOne</code> has been annotated with <code class="literal">@org.jboss.ejb3.annotation.Management</code>.
		JBoss will inspect this interface, and create and install an MBean implementing the attributes and operations defined in the <code class="literal">@Management</code>
		interface. The MBean will work on the same singleton bean instance as the remote and local interfaces.

	</p>
            <div class="sect5" lang="en">
               <div class="titlepage"/>
		Lifecycle :
		<p>
			Just as for "normal" MBeans in JBoss, the <code class="literal">@Service</code> supports lifecycle management. Lifecycle management
			consists of two things:
			</p>
               <div class="itemizedlist">
                  <ul>
                     <li>
					Lifecycle methods
				</li>
                     <li>
					Dependencies
				</li>
                  </ul>
               </div>
               <p>
		
               </p>
            </div>
            <div class="sect5" lang="en">
               <div class="titlepage"/>
		Lifecycle methods :
		<p>
			
                  <code class="literal">org.jboss.tutorial.service.bean.ServiceOneManagement</code> contains the four methods:
			</p>
               <pre class="programlisting">
				
void create() throws Exception;

void start() throws Exception;

void stop();

void destroy();

				
			</pre>
               <p>
			You do not need to include all these methods, you can pick and choose. If present, the service container will call
			these methods as follows:
			</p>
               <div class="itemizedlist">
                  <ul>
                     <li>
                        <code class="literal">create</code> : called by the server when the service is created and all the services it depends
					upon have been created too. At this point the service (and all the services it depends on) is installed in the
					JMX server, but is not yet fully functional.
				</li>
                     <li>
                        <code class="literal">start</code> : called by the server when the service is started and all the services it depends upon
					have been started too. At this point the service (and all the services it depends on) is fully functional.
				</li>
                     <li>
                        <code class="literal">stop</code> : called by the server when the service is stopped. At this point the service
					(and all the services that depend on it) is no longer fully operational.
				</li>
                     <li>
                        <code class="literal">destroy</code> : called by the server when the service is destroyed and removed from the MBean server.
					At this point the service (and all the services that depend on it) are destroyed.
				</li>
                  </ul>
               </div>
               <p>

		
               </p>
            </div>
            <div class="sect5" lang="en">
               <div class="titlepage"/>
		Depends and custom JMX object name :
		<p>
			Let's take a look at how to define the dependencies between services. Open <code class="literal">org.jboss.tutorial.service.bean.ServiceTwo</code>.
			Again it has been annotated with @Service, and it implements the @Management annotated interface <code class="literal">org.jboss.tutorial.service.bean.ServiceTwoManagement</code>.
			</p>
               <pre class="programlisting">
				
@Service(objectName = ServiceTwo.OBJECT_NAME)
@Management(ServiceTwoManagement.class)
@Depends(ServiceOne.OBJECT_NAME)
public class ServiceTwo implements ServiceTwoManagement
{
...
				
			</pre>
               <p>
			The <code class="literal">@org.jboss.ejb3.annotation.Depends</code> annotation specifies that this service depends on
			the service created for ServiceOne. i.e. it cannot be started until the service created for ServiceOne has been started.
			</p>
               <div class="note">
                  <h2>Note</h2>
                  <p>
					You can specify an array of <code class="literal">ObjectName</code>s if you depended on more than one service.
				</p>
               </div>
               <p>
			You will also notice the use of <code class="literal">objectName</code> property of @Service. This is used to install the service
			under a custom ObjectName instead of the default ObjectName. So in this tutorial, our ServiceTwo will be registered at
			<code class="literal">tutorial:service=ServiceTwo</code>
		
               </p>
            </div>
            <div class="sect5" lang="en">
               <div class="titlepage"/>
		Depends injection :
		<p>
			Take a look at <code class="literal">org.jboss.tutorial.bean.ServiceThree</code>. It has dependencies on other MBeans, but rather than
			annotating the class with @Depends, the dependencies are specified on fields and setter methods.
			</p>
               <pre class="programlisting">
				
@Depends(ServiceOne.OBJECT_NAME)
public ObjectName serviceOneName;

private ServiceTwoManagement service2;

@Depends(ServiceTwo.OBJECT_NAME)
public void setServiceTwo(ServiceTwoManagement service2)
{
	this.service2 = service2;
}
				
			</pre>
               <p>
			With regard to the lifecycle dependencies, the effect of annotating fields and setters with @Depends is the same
			as if we annotated the class. So, ServiceThree cannot be started until ServiceOne (<code class="literal">tutorial:service=ServiceOne</code>) and ServiceTwo(<code class="literal">tutorial:service=ServiceTwo</code>)
			are started. Annotating the fields and setters with @Depends though, allows you to inject the dependencies. So in this tutorial,
			the <code class="literal">ServiceThree.serviceOneName</code> will be injected with the <code class="literal">ObjectName</code> which corresponds to
			ServiceOne.	More interesting is the injection of ServiceTwo. <code class="literal">setServiceTwo()</code> takes a parameter, which is the
			<code class="literal">ServiceTwoManagement</code> management interface of ServiceTwo. The server creates a dynamic proxy for
			the ServiceTwoManagement interface, and injects that. This means that you can call the methods on the <code class="literal">service2</code>
			field without caring that you are actually invoking methods on another service.
		</p>
            </div>
            <div class="sect5" lang="en">
               <div class="titlepage"/>
		Interceptors :
		<p>
			You can define interceptors for your service beans in the same way as shown in the "interceptors" tutorial.
			This example defines one in the ServiceThree bean class itself:
			</p>
               <pre class="programlisting">
				
@AroundInvoke
public Object intercept(InvocationContext ctx) throws Exception
{
   System.out.println("ServiceThree - Interceptor");
   return ctx.proceed();
}
				
			</pre>
               <p>
		
               </p>
            </div>
            <div class="sect5" lang="en">
               <div class="titlepage"/>
		Defining Management Interface via XML :
		<p>
			You can deploy a Service bean as an XMBean, where the management attributes and operations are defined via xml.
			Take a look at <code class="literal">org.jboss.tutorial.service.bean.XMBeanService</code>. Note the @Service annotation
			specifies an <code class="literal">xmbean</code> property. Also note there is no @Management annotation.
			</p>
               <pre class="programlisting">
				
@Service(objectName = XMBeanService.OBJECT_NAME, xmbean = "resource:META-INF/service-xmbean.xml")
@Remote(XMBeanServiceRemote.class)
public class XMBeanService implements XMBeanServiceRemote
{
...
				
			</pre>
               <p>
			 Now take a look at <code class="literal">META-INF/service-xmbean.xml</code>. This is the file referenced by the <code class="literal">xmbean</code>
			 property and specifies the bean's management attributes and operations. Note the <code class="literal">class</code>, <code class="literal">constructor</code>,
			 <code class="literal">attribute</code> and <code class="literal">operation</code> elements.
		</p>
            </div>
            <div class="sect5" lang="en">
               <div class="titlepage"/>

Building and Running
	<p>
			
               </p>
               <div class="note">
                  <h2>Note</h2>
                  <p>
						To build and run the example, make sure you have installed JBoss 5.x.
						See the <a href="#JBossAS5" title="1.1. JBoss Application Server 5.x">Section 1.1, “JBoss Application Server 5.x”</a> for details.
					</p>
               </div>
               <p>
			From the command prompt, move to the "service" folder under the <a href="#EJB3_TUTORIAL_HOME" title="1.3. Set the EJB3_TUTORIAL_HOME">Section 1.3, “Set the EJB3_TUTORIAL_HOME”</a>
			
               </p>
               <div class="sect5" lang="en">
                  <div class="titlepage"/>
		Ant Users:
			</div>
               <p>
				
               </p>
               <p>
				Make sure the "default" server configuration of JBossAS-5.x is running
				</p>
               <p>
			
               </p>
               <pre class="programlisting">
			
$ ant
$ ant run

run:
     [java] invoking remote business interface of ServiceOne...
     [java] Set the attribute value through ServiceOneRemote to 100
     [java] attribute value for (ServiceOne) singleton obtained via JMX is what we set via remote interface: 100
     [java] Invoking ServiceThree via JMX...
     [java] Hello from service One
     [java] ServiceThree - Calling ServiceTwo.sayHello() via MBean proxy
     [java] invoking XMBean (configured through deployment descriptor)...
     [java] Set the attribute value to 50
     [java] Invoking XMBean through JMX
     [java] attribute value for (XMBeanService deployment descriptor configured) singleton obtained via JMX is what we set via remote interface: 50
     [java] Hello from an XMBean

		     
			</pre>
               <p>

			
               </p>
               <div class="sect5" lang="en">
                  <div class="titlepage"/>
Maven Users: Make sure the AS is not running.
	</div>
               <p>

	
               </p>
               <pre class="programlisting">
$ mvn clean install -PRunSingleTutorial
			</pre>
               <p>

		
               </p>
            </div>
            <p>
		On the server side when the application is deployed, you will notice these logs:

		</p>
            <pre class="programlisting">
			
16:56:54,036 INFO  [STDOUT] ServiceOne - Created
...
16:56:54,082 INFO  [STDOUT] ServiceOne - Started
...
16:56:54,142 INFO  [STDOUT] ServiceTwo - Started
...
16:56:54,226 INFO  [STDOUT] ServiceThree - Started

			
		</pre>
            <p>
		Notice that the order is maintained because of the dependencies we have configured on the @Service.
	</p>
         </div>
         <div class="chapter" lang="en">
            <div class="titlepage">
               <div>
                  <div>
                     <h2 class="title">
                        <a id="Service_POJOs_through_deployment_descriptors"/>Chapter 29. Service POJOs (JBoss extension of EJB3) using deployment descriptors</h2>
                  </div>
               </div>
            </div>
            <p>
		This tutorial is similar to the "service" tutorial which shows how to use Service POJOs in JBoss.
		In this tutorial we will use deployment descriptors instead of annotations to configure the services.
	</p>
            <p>
		Take a look at <code class="literal">org.jboss.tutorial.service_deployment_descriptor.bean.ServiceOne</code> and the corresponding deployment
		descriptor <code class="literal">META-INF/jboss.xml</code>. The <code class="literal">&lt;service&gt;</code> tag defines it as a
		singleton service in JBoss. It implements <code class="literal">org.jboss.tutorial.service_deployment_descriptor.bean.ServiceOneRemote</code>
		and <code class="literal">org.jboss.tutorial.service_deployment_descriptor.bean.ServiceOneLocal</code> using the <code class="literal">&lt;business-remote&gt;</code>
		and <code class="literal">&lt;business-local&gt;</code> tags.
	</p>
            <p>
		ServiceOne also implements <code class="literal">org.jboss.tutorial.service_deployment_descriptor.bean.ServiceOneManagement</code>
		identified through the <code class="literal">&lt;management&gt;</code> tag. JBoss will inspect this interface, and create and
		install an MBean implementing the attributes and operations defined in the interface. The MBean will work on the same
		singleton bean instance as the remote and local interfaces.
	</p>
            <p>
		The <code class="literal">META-INF/jboss.xml</code> also shows that the default ObjectName of the service can be overriden
		using the <code class="literal">&lt;object-name&gt;</code> tag:

		</p>
            <pre class="programlisting">
			
&lt;service&gt;
   &lt;ejb-name&gt;ServiceOne&lt;/ejb-name&gt;
   &lt;ejb-class&gt;org.jboss.tutorial.service_deployment_descriptor.bean.ServiceOne&lt;/ejb-class&gt;
   &lt;business-local&gt;org.jboss.tutorial.service_deployment_descriptor.bean.ServiceOneLocal&lt;/business-local&gt;
   &lt;business-remote&gt;org.jboss.tutorial.service_deployment_descriptor.bean.ServiceOneRemote&lt;/business-remote&gt;
   &lt;object-name&gt;tutorial:service=serviceOne&lt;/object-name&gt;
   &lt;management&gt;org.jboss.tutorial.service_deployment_descriptor.bean.ServiceOneManagement&lt;/management&gt;
   &lt;jndi-name&gt;serviceOne/remote&lt;/jndi-name&gt;
   &lt;local-jndi-name&gt;serviceOne/local&lt;/local-jndi-name&gt;
&lt;/service&gt;
			
		</pre>
            <p>
	
            </p>
            <p>
		Take a look at <code class="literal">org.jboss.tutorial.service_deployment_descriptor.bean.ServiceThree</code> and
		<code class="literal">org.jboss.tutorial.service_deployment_descriptor.bean.ServiceTwo</code> where we use the <code class="literal">@Depends</code>
		annotation to add dependencies between services.
		</p>
            <div class="note">
               <h2>Note</h2>
               <p>
				For a detailed explanation of @Depends in @Service, take a look at our "service" tutorial.
			</p>
            </div>
            <p>
	
            </p>
            <div class="sect5" lang="en">
               <div class="titlepage"/>

Building and Running
	<p>
			
               </p>
               <div class="note">
                  <h2>Note</h2>
                  <p>
						To build and run the example, make sure you have installed JBoss 5.x.
						See the <a href="#JBossAS5" title="1.1. JBoss Application Server 5.x">Section 1.1, “JBoss Application Server 5.x”</a> for details.
					</p>
               </div>
               <p>
			From the command prompt, move to the "service_deployment_descriptor" folder under the <a href="#EJB3_TUTORIAL_HOME" title="1.3. Set the EJB3_TUTORIAL_HOME">Section 1.3, “Set the EJB3_TUTORIAL_HOME”</a>
			
               </p>
               <div class="sect5" lang="en">
                  <div class="titlepage"/>
		Ant Users:
			</div>
               <p>
				
               </p>
               <p>
				Make sure the "default" server configuration of JBossAS-5.x is running
				</p>
               <p>
			
               </p>
               <pre class="programlisting">
			
$ ant
$ ant run

run:
     [java] attribute value for singleton obtained via JMX is what we set via remote interface: 100
     [java] Hello from service One
     [java] Hello from service Two
		     
			</pre>
               <p>

			
               </p>
               <div class="sect5" lang="en">
                  <div class="titlepage"/>
Maven Users: Make sure the AS is not running.
	</div>
               <p>

	
               </p>
               <pre class="programlisting">
$ mvn clean install -PRunSingleTutorial
			</pre>
               <p>

		
               </p>
            </div>
            <p>
		On the server side when the application is deployed, you will notice these logs:

		</p>
            <pre class="programlisting">
			
17:37:17,869 INFO  [STDOUT] ServiceOne - Started
...
17:37:17,910 INFO  [STDOUT] ServiceTwo - Started
...
17:37:17,949 INFO  [STDOUT] ServiceThree - Started

			
		</pre>
            <p>
		Notice that the order is maintained because of the dependencies we have configured on the @Service.
	</p>
         </div>
         <div class="chapter" lang="en">
            <div class="titlepage">
               <div>
                  <div>
                     <h2 class="title">
                        <a id="Single_Inheritance_in_EJB3_Entities"/>Chapter 30. Introduction Single Inheritance in EJB3 Entities</h2>
                  </div>
               </div>
            </div>
            <p>
		The EJB specification allows you to define entities that inherit from one another. The inheritance relationships can be reflected in
		queries as well. So, if you queried based on the base class, the query is polymorphic.
	</p>
            <p>
		The tutorial example uses the single table strategy to map an inheritance relationship of <code class="literal">org.jboss.tutorial.singleinheritance.bean.Pet</code>,
		which is the base class for <code class="literal">org.jboss.tutorial.singleinheritance.bean.Cat</code> and <code class="literal">org.jboss.tutorial.singleinheritance.bean.Dog</code>.
		With the single table strategy, the entire class hierarchy is persisted in one big single table. A discriminator column is required to
		differentiate between which class type is persisted in a particular row. This is what the annotations look like for Pet.

		</p>
            <pre class="programlisting">
			
@Entity
@Inheritance(strategy = InheritanceType.SINGLE_TABLE)
@DiscriminatorColumn(name = "ANIMAL_TYPE", discriminatorType = DiscriminatorType.STRING)
public class Pet implements java.io.Serializable
{
}
			
		</pre>
            <p>

		The <code class="literal">@DiscriminatorColumn</code> specifies the column that will hold the type of the persisted entity.
		For subclasses, they must define the value of the discriminator column that will identify the class.

		</p>
            <p>
			Here's the Dog entity which extends Pet:
			</p>
            <pre class="programlisting">
				
@Entity
@Inheritance(strategy = InheritanceType.SINGLE_TABLE)
@DiscriminatorColumn(discriminatorType = DiscriminatorType.STRING)
@DiscriminatorValue("DOG")
public class Dog extends Pet
{
}
				
			</pre>
            <p>
		
            </p>
            <p>

	
            </p>
            <div class="sect5" lang="en">
               <div class="titlepage"/>
		Polymorphic queries:
		<p>
			
                  <code class="literal">org.jboss.tutorial.singleinheritance.bean.PetDAOBean</code> stateless EJB wraps some polymorphic queries.
			</p>
               <pre class="programlisting">
				
public List findByWeight(double weight)
{
   return manager.createQuery("from Pet p where p.weight &lt; :weight").setParameter("weight", weight).getResultList();
}

				
			</pre>
               <p>
		
               </p>
		Even though the <span class="ERROR">&lt;listing&gt;findByWeight&lt;/listing&gt;</span> method queries on Pet, either Dog or Cat instances can be returned.
	</div>
            <div class="sect5" lang="en">
               <div class="titlepage"/>
		Table Mapping :
		<p>
			The table mapping for this example looks like this:
			</p>
               <pre class="programlisting">
				
create table PET (
  ID integer primary key,
  ANIMAL_TYPE varchar,
  NAME varchar,
  WEIGHT double,
  LIVES int,
  NUMBONES int
);

				
			</pre>
               <p>
		
               </p>
            </div>
            <div class="sect5" lang="en">
               <div class="titlepage"/>

Building and Running
	<p>
			
               </p>
               <div class="note">
                  <h2>Note</h2>
                  <p>
						To build and run the example, make sure you have installed JBoss 5.x.
						See the <a href="#JBossAS5" title="1.1. JBoss Application Server 5.x">Section 1.1, “JBoss Application Server 5.x”</a> for details.
					</p>
               </div>
               <p>
			From the command prompt, move to the "singleinheritance" folder under the <a href="#EJB3_TUTORIAL_HOME" title="1.3. Set the EJB3_TUTORIAL_HOME">Section 1.3, “Set the EJB3_TUTORIAL_HOME”</a>
			
               </p>
               <div class="sect5" lang="en">
                  <div class="titlepage"/>
		Ant Users:
			</div>
               <p>
				
               </p>
               <p>
				Make sure your JBossAS-5.x is running
				</p>
               <p>
			
               </p>
               <pre class="programlisting">
			
$ ant
$ ant run

run:
     [java] Sox
     [java] Junior

		     
			</pre>
               <p>

			
               </p>
               <div class="sect5" lang="en">
                  <div class="titlepage"/>
Maven Users: Make sure the AS is not running.
	</div>
               <p>

	
               </p>
               <pre class="programlisting">
$ mvn clean install -PRunSingleTutorial
			</pre>
               <p>

		
               </p>
            </div>
            <div class="sect5" lang="en">
               <div class="titlepage"/>
			View the tables and rows:

		<p>
			You can view the tables created by JBoss by going to the
			<a xmlns:xlink="http://www.w3.org/1999/xlink" href="http://localhost:8080/jmx-console/HtmlAdaptor?action=inspectMBean&amp;name=jboss%3Aservice%3DHypersonic%2Cdatabase%3DlocalDB">Hypersonic Service</a>,
			scrolling down to the <code class="literal">startDatabaseManager</code> button and clicking it.
			A Hypersonic SQL window will be minimized, but you can open it up to look at the tables and do queries.

		</p>
            </div>
         </div>
         <div class="chapter" lang="en">
            <div class="titlepage">
               <div>
                  <div>
                     <h2 class="title">
                        <a id="Stateful_Session_Beans_in_EJB3_with_deployment_descriptors"/>Chapter 31. Configuring Stateful Session Beans with deployment descriptors in EJB3</h2>
                  </div>
               </div>
            </div>
            <p>
		Take a look at the <code class="literal">META-INF/ejb-jar.xml</code> and <code class="literal">org.jboss.tutorial.stateful_deployment_descriptor.bean.ShoppingCartBean</code>.
		You specify a stateful bean with the "session" and "session-type" tags. Note that all bean types in EJB 3.0 are homeless,
		so there is no requirement for a "home" or "local-home" tag. The bean class is specified with the "ejb-class" tag.
	</p>
            <p>
		ShoppingCartBean also implements a business-remote interface. Take a look at <code class="literal">org.jboss.tutorial.stateful_deployment_descriptor.bean.ShoppingCart</code>.
		To define this as the business-remote interface of ShoppingCartBean you need to use the "business-remote" tag in the ejb-jar.xml. Here's the <code class="literal">META-INF/ejb-jar.xml</code>:

		</p>
            <pre class="programlisting">
			
&lt;session&gt;
         &lt;ejb-name&gt;ShoppingCart&lt;/ejb-name&gt;
         &lt;business-remote&gt;org.jboss.tutorial.stateful_deployment_descriptor.bean.ShoppingCart&lt;/business-remote&gt;
         &lt;ejb-class&gt;org.jboss.tutorial.stateful_deployment_descriptor.bean.ShoppingCartBean&lt;/ejb-class&gt;
         &lt;session-type&gt;Stateful&lt;/session-type&gt;
         &lt;remove-method&gt;
            &lt;bean-method&gt;
               &lt;method-name&gt;checkout&lt;/method-name&gt;
            &lt;/bean-method&gt;
            &lt;retain-if-exception&gt;false&lt;/retain-if-exception&gt;
         &lt;/remove-method&gt;
         &lt;transaction-type&gt;Container&lt;/transaction-type&gt;
&lt;/session&gt;
			
		</pre>
            <p>

		
            </p>
            <div class="note">
               <h2>Note</h2>
               <p>
				There's a very important difference between the <code class="literal">remote</code> and a <code class="literal">business-remote</code>
				interface. The EJB2.x remote interfaces, which extend from EJBObject, are referred through the <code class="literal">&lt;remote&gt;</code>
				tag in the ejb-jar.xml. On the other hand, the EJB3 style Plain Old Java Interface which is implemented by your EJB3 style
				POJO bean is known as the business-remote interface and is represented by the <code class="literal">@Remote</code> and it's
				corresponding <code class="literal">&lt;business-remote&gt;</code> tag in ejb-jar.xml.

				Similar is the case with <code class="literal">&lt;local&gt;</code> and the <code class="literal">&lt;business-local&gt;</code> tags in ejb-jar.xml.
			</p>
            </div>
            <p>

	
            </p>
            <div class="sect5" lang="en">
               <div class="titlepage"/>
		@Remove :
		<p>
			Take another look at <code class="literal">META-INF/ejb-jar.xml</code>. Look for the "remove-method" tag.
			Instead of explicitly calling EJBObject.remove() in your applications and thus polluting it further with J2EE specific code,
			any method specified in the "remove-method" tag will cause the stateful bean instance to be removed from the container
			at the end of the method call. This deployment descriptor behavior mimics the <code class="literal">@Remove</code> annotation.

		</p>
            </div>
            <div class="sect5" lang="en">
               <div class="titlepage"/>
		JNDI Bindings through deployment descriptor :

		<p>
			The CalculatorBean will have its remote interface bound in JNDI. Take a look at <code class="literal">META-INF/jboss.xml</code>.
			Note the <code class="literal">jndi-name</code> tag. This specifies the jndi binding for the remote interface of the bean.

		</p>
            </div>
            <div class="sect5" lang="en">
               <div class="titlepage"/>
		Client :
		<p>
			Open up <code class="literal">org.jboss.tutorial.stateful_deployment_descriptor.client.Client</code>.
			You'll see that it looks up the stateful bean under its jndi name.  Also notice that there is no Home interface
			and you can begin executing on the stateful bean right away. When you access the bean in JNDI, an instance of the stateful
			bean will be created on the server. So, when you need a different instance of the stateful bean, you do an additional
			jndi lookup to get this new reference.
		</p>
            </div>
            <div class="sect5" lang="en">
               <div class="titlepage"/>

Building and Running
	<p>
			
               </p>
               <div class="note">
                  <h2>Note</h2>
                  <p>
						To build and run the example, make sure you have installed JBoss 5.x.
						See the <a href="#JBossAS5" title="1.1. JBoss Application Server 5.x">Section 1.1, “JBoss Application Server 5.x”</a> for details.
					</p>
               </div>
               <p>
			From the command prompt, move to the "stateful_deployment_descriptor" folder under the <a href="#EJB3_TUTORIAL_HOME" title="1.3. Set the EJB3_TUTORIAL_HOME">Section 1.3, “Set the EJB3_TUTORIAL_HOME”</a>
			
               </p>
               <div class="sect5" lang="en">
                  <div class="titlepage"/>
		Ant Users:
			</div>
               <p>
				
               </p>
               <p>
				Make sure your JBossAS-5.x is running
				</p>
               <p>
			
               </p>
               <pre class="programlisting">
			
$ ant
$ ant run

run:
     [java] Buying 1 memory stick
     [java] Buying another memory stick
     [java] Buying a laptop
     [java] Print cart:
     [java] 2     Memory stick
     [java] 1     Laptop
     [java] Checkout
     [java] Should throw an object not found exception by invoking on cart after @Remove method
     [java] Successfully caught no such object exception.

		     
			</pre>
               <p>

			
               </p>
               <div class="sect5" lang="en">
                  <div class="titlepage"/>
Maven Users: Make sure the AS is not running.
	</div>
               <p>

	
               </p>
               <pre class="programlisting">
$ mvn clean install -PRunSingleTutorial
			</pre>
               <p>

		
               </p>
            </div>
         </div>
         <div class="chapter" lang="en">
            <div class="titlepage">
               <div>
                  <div>
                     <h2 class="title">
                        <a id="Stateless_Session_Beans_in_EJB3_with_deployment_descriptors"/>Chapter 32. Configuring Stateless Session Beans with deployment descriptors in EJB3</h2>
                  </div>
               </div>
            </div>
            <p>
		CalculatorBean is defined as a stateless session bean through the <code class="literal">&lt;session&gt;</code> and
		<code class="literal">&lt;session-type&gt;</code> elements. This marks the class as a stateless bean and the deployer will
		deploy that class as a stateless bean EJB container.
	</p>
            <p>
		CalculatorBean also implements two interfaces. One is the business-remote interface of the EJB the other is the business-local
		interface. Take a look at <code class="literal">org.jboss.tutorial.stateless_deployment_descriptor.bean.CalculatorRemote</code>. To define this
		as the business-remote interface of Calculator bean you specify the interface with the <code class="literal">&lt;remote&gt;</code> tag.
		Similarly for <code class="literal">org.jboss.tutorial.stateless_deployment_descriptor.bean.CalculatorLocal</code> you need to specify the
		business-local interface with the <code class="literal">&lt;local&gt;</code> tag. Here's the <code class="literal">META-INF/ejb-jar.xml</code>:

		</p>
            <pre class="programlisting">
			
&lt;session&gt;
         &lt;ejb-name&gt;Calculator&lt;/ejb-name&gt;
         &lt;business-local&gt;org.jboss.tutorial.stateless_deployment_descriptor.bean.CalculatorLocal&lt;/business-local&gt;
         &lt;business-remote&gt;org.jboss.tutorial.stateless_deployment_descriptor.bean.CalculatorRemote&lt;/business-remote&gt;
         &lt;ejb-class&gt;org.jboss.tutorial.stateless_deployment_descriptor.bean.CalculatorBean&lt;/ejb-class&gt;
         &lt;session-type&gt;Stateless&lt;/session-type&gt;
         &lt;transaction-type&gt;Container&lt;/transaction-type&gt;
&lt;/session&gt;
			
		</pre>
            <p>

		
            </p>
            <div class="note">
               <h2>Note</h2>
               <p>
				There's a very important difference between the <code class="literal">remote</code> and a <code class="literal">business-remote</code>
				interface. The EJB2.x remote interfaces, which extend from EJBObject, are referred through the <code class="literal">&lt;remote&gt;</code>
				tag in the ejb-jar.xml. On the other hand, the EJB3 style Plain Old Java Interface which is implemented by your EJB3 style
				POJO bean is known as the business-remote interface and is represented by the <code class="literal">@Remote</code> and it's
				corresponding <code class="literal">&lt;business-remote&gt;</code> tag in ejb-jar.xml.

				Similar is the case with <code class="literal">&lt;local&gt;</code> and the <code class="literal">&lt;business-local&gt;</code> tags in ejb-jar.xml.
			</p>
            </div>
            <p>

	
            </p>
            <div class="sect5" lang="en">
               <div class="titlepage"/>
		JNDI Bindings through deployment descriptor :

		<p>
			The Calculator bean will have two JNDI bindings for the remote and Local interface. The <code class="literal">META-INF/jboss.xml</code>
			through the <code class="literal">&lt;jndi-name&gt;</code> and the <code class="literal">&lt;local-jndi-name&gt;</code> specifies the jndi-name
			for the remote and the local interfaces, respectively:

			</p>
               <pre class="programlisting">
				
&lt;session&gt;
         &lt;ejb-name&gt;Calculator&lt;/ejb-name&gt;
         &lt;jndi-name&gt;org.jboss.tutorial.stateless_deployment_descriptor.bean.CalculatorRemote&lt;/jndi-name&gt;
         &lt;local-jndi-name&gt;org.jboss.tutorial.stateless_deployment_descriptor.bean.CalculatorLocal&lt;/local-jndi-name&gt;
&lt;/session&gt;
				
			</pre>
               <p>

		
               </p>
            </div>
            <div class="sect5" lang="en">
               <div class="titlepage"/>
		Client :

		<p>
			Open up <code class="literal">org.jboss.tutorial.stateless_deployment_descriptor.client.Client</code>.
			The client looks up the bean using the jndi-name specified in the jboss.xml. Also notice that there is no Home interface
			and you can begin executing on the stateless bean right away.

		</p>
            </div>
            <div class="sect5" lang="en">
               <div class="titlepage"/>

Building and Running
	<p>
			
               </p>
               <div class="note">
                  <h2>Note</h2>
                  <p>
						To build and run the example, make sure you have installed JBoss 5.x.
						See the <a href="#JBossAS5" title="1.1. JBoss Application Server 5.x">Section 1.1, “JBoss Application Server 5.x”</a> for details.
					</p>
               </div>
               <p>
			From the command prompt, move to the "stateless_deployment_descriptor" folder under the <a href="#EJB3_TUTORIAL_HOME" title="1.3. Set the EJB3_TUTORIAL_HOME">Section 1.3, “Set the EJB3_TUTORIAL_HOME”</a>
			
               </p>
               <div class="sect5" lang="en">
                  <div class="titlepage"/>
		Ant Users:
			</div>
               <p>
				
               </p>
               <p>
				Make sure your JBossAS-5.x is running
				</p>
               <p>
			
               </p>
               <pre class="programlisting">
			
$ ant
$ ant run

run:
     [java] 1 + 1 = 2
     [java] 1 - 1 = 0

		     
			</pre>
               <p>

			
               </p>
               <div class="sect5" lang="en">
                  <div class="titlepage"/>
Maven Users: Make sure the AS is not running.
	</div>
               <p>

	
               </p>
               <pre class="programlisting">
$ mvn clean install -PRunSingleTutorial
			</pre>
               <p>

		
               </p>
            </div>
         </div>
         <div class="chapter" lang="en">
            <div class="titlepage">
               <div>
                  <div>
                     <h2 class="title">
                        <a id="Table_per_Class_inheritance_in_EJB3_Entities"/>Chapter 33. Table per Class inheritance in EJB3 Entities</h2>
                  </div>
               </div>
            </div>
            <p>
		The EJB3 specification allows you to define entities that inherit from one another. The inheritance
		relationships can be reflected in queries as well. So, if you queried based on the base class, the
		query is polymorphic.
	</p>
            <p>
		This tutorial uses the table per class strategy to map an inheritance relationship of
		<code class="literal">org.jboss.tutorial.tableperinheritance.bean.Pet</code>, which is the base class for
		<code class="literal">org.jboss.tutorial.tableperinheritance.bean.Cat</code> and <code class="literal">org.jboss.tutorial.tableperinheritance.bean.Dog</code>.
	</p>
            <p>
		With the table per class strategy there is a table per class in the hierarchy, and each table has
		every single property that particular class will persist.
	</p>
            <p>
		This is what the annotations look like for Pet:

		</p>
            <pre class="programlisting">
			
@Entity
@Inheritance(strategy = InheritanceType.TABLE_PER_CLASS)
public class Pet implements java.io.Serializable
{

...
			
		</pre>
            <p>
		The subclass annotations look like this:

		</p>
            <pre class="programlisting">
			
@Entity
public class Dog extends Pet
{
...
			

		</pre>
            <p>

	
            </p>
            <div class="sect5" lang="en">
               <div class="titlepage"/>
		Polymorphic Queries :
		<p>
			
                  <code class="literal">org.jboss.tutorial.tableperinheritance.bean.PetDAOBean</code> stateless EJB wraps some polymorphic queries :
			</p>
               <pre class="programlisting">
				
public List findByWeight(double weight)
{
   return manager.createQuery("from Pet p where p.weight &lt; :weight").setParameter("weight", weight).getResultList();
}

				
			</pre>
               <p>
			Even though the <code class="literal">findByWeight</code> method queries on Pet, either Dog or Cat instances can be returned.
		</p>
            </div>
            <div class="sect5" lang="en">
               <div class="titlepage"/>
		Table Mapping :

		<p>
			The table mapping for this example looks like this:
			</p>
               <pre class="programlisting">
				
create table CAT (
  ID integer primary key,
  LIVES int
  NAME varchar,
  WEIGHT double
);

create table DOG (
  ID integer primary key,
  NUMBONES int
  NAME varchar,
  WEIGHT double
);

				
			</pre>
               <p>
		
               </p>
		The table per class strategy is less efficient than the single table strategy as the SQL query is more complicated.
	</div>
            <div class="sect5" lang="en">
               <div class="titlepage"/>

Building and Running
	<p>
			
               </p>
               <div class="note">
                  <h2>Note</h2>
                  <p>
						To build and run the example, make sure you have installed JBoss 5.x.
						See the <a href="#JBossAS5" title="1.1. JBoss Application Server 5.x">Section 1.1, “JBoss Application Server 5.x”</a> for details.
					</p>
               </div>
               <p>
			
               </p>
               <div class="important">
                  <h2>Important</h2>
                  <p>
					Because of a bug in HSQL, this tutorial does not work against the HSQL DB (which
					JBoss ships by default). Till this is fixed, running the client is not possible.
					Alternately, you can configure a datasource to use some other database and then
					use that datasource in the persistence.xml
				</p>
               </div>
               <p>
			From the command prompt, move to the "tableperinheritance" folder under the <a href="#EJB3_TUTORIAL_HOME" title="1.3. Set the EJB3_TUTORIAL_HOME">Section 1.3, “Set the EJB3_TUTORIAL_HOME”</a>
			
               </p>
               <div class="sect5" lang="en">
                  <div class="titlepage"/>
		Ant Users:
			</div>
               <p>
				
               </p>
               <p>
				Make sure the "default" server configuration of JBossAS-5.x is running
				</p>
               <p>
			
               </p>
               <pre class="programlisting">
			
$ ant
		     
			</pre>
               <p>

			
               </p>
               <div class="sect5" lang="en">
                  <div class="titlepage"/>
Maven Users: Make sure the AS is not running.
	</div>
               <p>

	
               </p>
               <pre class="programlisting">
$ mvn clean install -PRunSingleTutorial
			</pre>
               <p>

		
               </p>
            </div>
            <div class="sect5" lang="en">
               <div class="titlepage"/>
			View the tables and rows:

		<p>
			You can view the tables created by JBoss by going to the
			<a xmlns:xlink="http://www.w3.org/1999/xlink" href="http://localhost:8080/jmx-console/HtmlAdaptor?action=inspectMBean&amp;name=jboss%3Aservice%3DHypersonic%2Cdatabase%3DlocalDB">Hypersonic Service</a>,
			scrolling down to the <code class="literal">startDatabaseManager</code> button and clicking it.
			A Hypersonic SQL window will be minimized, but you can open it up to look at the tables and do queries.

		</p>
            </div>
         </div>
         <div class="chapter" lang="en">
            <div class="titlepage">
               <div>
                  <div>
                     <h2 class="title">
                        <a id="Timer_service_in_EJB3"/>Chapter 34. Introduction to timer service in EJB3</h2>
                  </div>
               </div>
            </div>
            <p>
		This example shows you how to access <code class="literal">javax.ejb.SessionContext</code> as well as using
		the EJB Timer Service.  It also explains how callbacks work in EJB 3.0.

	</p>
            <div class="sect5" lang="en">
               <div class="titlepage"/>
		SessionContext injection :

		<p>
			The <code class="literal">javax.ejb.SessionContext</code> is injected using the <code class="literal">@javax.annotation.Resource</code> annotation.
			When the stateless bean instance is created the field will be initialized with the correct SessionContext.
			Take a look at <code class="literal">org.jboss.tutorial.timer.bean.ExampleTimerBean</code>
			
               </p>
               <pre class="programlisting">
				
private @Resource SessionContext ctx;

				

			</pre>
               <p>
		
               </p>
            </div>
            <div class="sect5" lang="en">
               <div class="titlepage"/>
		Timeout Callbacks :
		<p>
			The rest of the bean example registers a timer with the EJB Timer service. In the EJB 2.1 specification
			it was required to implement an interface to get ejbTimeout callbacks. In JBoss EJB3, it is implemented
			as an annotation. All you have to define is a method annotated with <code class="literal">javax.ejb.Timeout</code>.

		</p>
            </div>
            <div class="sect5" lang="en">
               <div class="titlepage"/>

Building and Running
	<p>
			
               </p>
               <div class="note">
                  <h2>Note</h2>
                  <p>
						To build and run the example, make sure you have installed JBoss 5.x.
						See the <a href="#JBossAS5" title="1.1. JBoss Application Server 5.x">Section 1.1, “JBoss Application Server 5.x”</a> for details.
					</p>
               </div>
               <p>
			From the command prompt, move to the "timer" folder under the <a href="#EJB3_TUTORIAL_HOME" title="1.3. Set the EJB3_TUTORIAL_HOME">Section 1.3, “Set the EJB3_TUTORIAL_HOME”</a>
			
               </p>
               <div class="sect5" lang="en">
                  <div class="titlepage"/>
		Ant Users:
			</div>
               <p>
				
               </p>
               <p>
				Make sure your JBossAS-5.x is running
				</p>
               <p>
			
               </p>
               <pre class="programlisting">
			
$ ant
$ ant run

run:
     [java] Timer scheduled to trigger after 5 seconds

		     
			</pre>
               <p>

			
               </p>
               <div class="sect5" lang="en">
                  <div class="titlepage"/>
Maven Users: Make sure the AS is not running.
	</div>
               <p>

	
               </p>
               <pre class="programlisting">
$ mvn clean install -PRunSingleTutorial
			</pre>
               <p>

		
               </p>
            </div>
            <p>
		On the server you will notice these logs:
		</p>
            <pre class="programlisting">
			
INFO  [STDOUT] ---------------------
INFO  [STDOUT] Created a timer event to be triggered after 5000 milli seconds
INFO  [STDOUT] ---------------------
INFO  [STDOUT] ---------------------
INFO  [STDOUT] * Received Timer event: Hello World
INFO  [STDOUT] ---------------------

			
		</pre>
            <p>
	
            </p>
         </div>
         <div class="chapter" lang="en">
            <div class="titlepage">
               <div>
                  <div>
                     <h2 class="title">
                        <a id="Hibernate_Session_In_EJB3"/>Chapter 35. Injecting Hibernate Session and Session Factory in JBoss EJB3</h2>
                  </div>
               </div>
            </div>
            <p>

		Persistent classes that are mapped using Hibernate *.hbm.xml files are supported in JBoss. The EJB3 Deployer will search the archive
		for any <code class="literal">.hbm.xml</code> files and add them to the definition of the underlying Hibernate SessionFactory. These
         <code class="literal">.hbm.xml</code> files can be virtually anywhere within the archive under any java package or directory.
		Take a look at the <code class="literal">customer.hbm.xml</code> for an example.
	</p>
            <p>
         Class mappings defined in <code class="literal">.hbm.xml</code> files can be managed by EntityManagers just as annotated
         @Entity beans are.  Also, you are allowed to have relationships between a <code class="literal">.hbm.xml</code>
         mapped class and an EJB3 entity.  So, mixing/matching is allowed. Which means you can have some entities defined in .hbm.xml and
         some others through @Entity annotations.
     </p>
            <div class="sect5" lang="en">
               <div class="titlepage"/>
      Injecting Hibernate Session and SessionFactory :
      <p>
         You can inject a <code class="literal">org.hibernate.Session</code> and <code class="literal">org.hibernate.SessionFactory</code>
         directly into your EJBs just as you can do with EntityManagers and EntityManagerFactorys. The behavior of a Session is
         just the same as the behavior of an injected EntityManager.  The application server controls the lifecycle of the
         Session so that you do not have to open, flush, or close the session.  Extended persistence contexts also work
         with injected Hibernate Sessions.
         </p>
               <pre class="programlisting">
         	
import org.hibernate.Query;
import org.hibernate.Session;

@Stateless
@Remote(CustomerRemote.class)
@RemoteBinding(jndiBinding = "CustBean")
public class CustomerBean implements CustomerRemote
{

   @PersistenceContext
   private Session session;

         	
         </pre>
               <p>
         Take a look at <code class="literal">org.jboss.tutorial.hibernate.bean.CustomerBean</code> for more details.
      </p>
            </div>
            <div class="sect5" lang="en">
               <div class="titlepage"/>
      Accessing org.hibernate.Session and org.hibernate.Query from EntityManager:
      <p>
         You can get access to the current underlying Hibernate Session by calling the <code class="literal">getDelegate</code> method on the
         EntityManager :

      	</p>
               <pre class="programlisting">
      		
@Stateless
@Remote(CustomerRemote.class)
@RemoteBinding (jndiBinding="AnotherCustBean")
public class AnotherCustomerBean implements CustomerRemote
{

   @PersistenceContext
   private EntityManager em;

   public Customer getCustomer(long id)
   {
      org.hibernate.Session session = (Session) em.getDelegate();
      return (Customer) session.get(Customer.class, id);
   }
...
			
      	</pre>
               <p>
      	Take a look at <code class="literal">org.jboss.tutorial.hibernate.bean.AnotherCustomerBean</code> for more details.
   </p>
               <p>
         You can get access to the current underlying Hibernate Query by typecasting your reference to a <code class="code">org.hibernate.ejb.QueryImpl</code>.

		</p>
               <pre class="programlisting">
      		
public List&lt;Customer&gt; getCustomers(String fname)
{
   org.hibernate.ejb.QueryImpl queryImpl = (QueryImpl) em.createQuery("from Customer where fname ='" + fname + "'");
   org.hibernate.Query query = queryImpl.getHibernateQuery();
   return query.list();
}

			
      </pre>
               <p>
	
               </p>
            </div>
            <div class="sect5" lang="en">
               <div class="titlepage"/>
Building and Running
	</div>
            <div class="note">
               <h2>Note</h2>
               <p>
	To build and run the example, make sure you have installed JBoss 5.x.
	See the <a href="#JBossAS5" title="1.1. JBoss Application Server 5.x">Section 1.1, “JBoss Application Server 5.x”</a> for details.
			</p>
            </div>
            <p>
			From the command prompt, move to the "hibernate" folder under the <a href="#EJB3_TUTORIAL_HOME" title="1.3. Set the EJB3_TUTORIAL_HOME">Section 1.3, “Set the EJB3_TUTORIAL_HOME”</a>
		
            </p>
            <div class="sect5" lang="en">
               <div class="titlepage"/>
Ant Users:
	</div>
            <p>
		Make sure your JBossAS-5.x is running
		</p>
            <pre class="programlisting">
	
$ ant
$ ant run

run:
     [java] Jai Pai created with id = 1
     [java] Jaikiran Pai created with id = 2
     [java] Jai NoLastName created with id = 3
     [java] Searching for customer with id = 2
     [java] Found customer Jaikiran Pai with id = 2
     [java] Searching for customer with id = 3
     [java] Found customer Jai NoLastName with id = 3
     [java] Searching for customers with first name Jai
     [java] Found 2 customers with first name Jai
     [java] Searching for customers with first name Jaikiran
     [java] Found 1 customers with first name Jaikiran

     
	</pre>
            <div class="sect5" lang="en">
               <div class="titlepage"/>
Maven Users: Make sure the AS is not running.
	</div>
            <pre class="programlisting">
$ mvn clean install -PRunSingleTutorial
	</pre>
         </div>
         <div class="chapter" lang="en">
            <div class="titlepage">
               <div>
                  <div>
                     <h2 class="title">
                        <a id="Asynchronous_Invocations"/>Chapter 36. Asynchronous proxy for EJBs - JBoss specific extension to EJB3</h2>
                  </div>
               </div>
            </div>
            <p>
         A JBoss extension to EJB 3.0 is that from the remote or local interface of a stateful session bean,
         stateless session bean or service bean you can obtain an asynchronous proxy. Methods called
         on the asynchronous proxy will be executed asynchronously, and the results can be obtained later on.

      </p>
            <div class="important">
               <h2>Important</h2>
               <p>
      		This JBoss specific feature of obtaining a asynchronous proxy to invoke any method on the bean asynchronously
      		is NOT the same as the Asynchronous Methods feature in EJB 3.1. In EJB 3.1, you can mark your bean business methods
      		to be asynchronous by using the @Asynchronous annotation.
      	</p>
            </div>
            <p>
      
            </p>
            <div class="sect5" lang="en">
               <div class="titlepage"/>
      	Example :
      	<p>
      		Take a look at <code class="literal">org.jboss.tutorial.asynch.bean.Echo</code> and <code class="literal">org.jboss.tutorial.asynch.bean.EchoBean</code>.
      		They define a normal stateless session bean with a remote interface, nothing special. Now take a look at
      		<code class="literal">org.jboss.tutorial.asynch.client.Client</code>. It shows an example of asynchronous calls on a remote interface.
      		We will walk through what it does here. The following lines just obtain the remote interface of the bean and call a method
      		following the standard synchronous usage pattern:
      		</p>
               <pre class="programlisting">
      			
InitialContext ctx = new InitialContext();
Echo echo = (Echo) ctx.lookup("EchoBean/remote");
System.out.println("-------- Synchronous call");
String ret = echo.echo("normal call");
System.out.println(ret);

      			

      		</pre>
               <p>

      		Next we obtain the asynchronous proxy and make a call via that. The method will be invoked asynchronously :
      		</p>
               <pre class="programlisting">
      			
Echo asynchEcho = org.jboss.ejb3.common.proxy.plugins.async.AsyncUtils.mixinAsync(echo);
System.out.println("-------- Asynchronous call");
ret = asynchEcho.echo("asynchronous call");
System.out.println("Direct return of async invocation is: " + ret);

      			
      		</pre>
               <p>
      		We use the <code class="literal">org.jboss.ejb3.common.proxy.plugins.async.AsyncUtils</code>'s <code class="literal">mixinAsync</code> method to
      		create the asynchronous proxy. All methods invoked on this proxy are invoked asynchronously, and the returned value will
      		always be null (or 0 in the case of numeric primitive types). In this example, the echo() method called has low overhead,
      		but imagine if this was a method that took a long time. In this case it would be good to be able to go ahead with some other tasks.
      	</p>
               <p>
      		In Client.java, we make another call on the normal remote interface while "waiting" for the asynchronous call:

      		</p>
               <pre class="programlisting">
      			
System.out.println("-------- Synchronous call");
ret = echo.echo("normal call 2");
System.out.println(ret);
      			
      		</pre>
               <p>

      		Now that we have finished everything we want to do, while waiting for the asynchronus call to complete, we invoke the
      		<code class="literal">getFutureResult(asynchProxy)</code> API on the <code class="literal">org.jboss.ejb3.common.proxy.plugins.async.AsyncUtils</code>.
      		This will return us an instance of <code class="literal">java.util.concurrent.Future</code>. To obtain the final result of the asynchronous
      		call, we invoke the <code class="literal">get()</code> API on the returned <code class="literal">java.util.concurrent.Future</code> object.

      		</p>
               <pre class="programlisting">
      			
System.out.println("-------- Result of Asynchronous call");
Future&lt;String&gt; future = (Future&lt;String&gt;) AsyncUtils.getFutureResult(asynchEcho);

// blocking call
ret = (String) future.get();
System.out.println(ret);

      			
      		</pre>
               <p>
      		
               </p>
               <div class="note">
                  <h2>Note</h2>
                  <p>
      				The java.util.concurrent.Future.get() API is blocking and if the asynchronous operation is not yet done, it will wait
      				for the operation to complete.
      			</p>
               </div>
               <p>

      	
               </p>
            </div>
            <div class="sect5" lang="en">
               <div class="titlepage"/>
Building and Running
	</div>
            <div class="note">
               <h2>Note</h2>
               <p>
	To build and run the example, make sure you have installed JBoss 5.x.
	See the <a href="#JBossAS5" title="1.1. JBoss Application Server 5.x">Section 1.1, “JBoss Application Server 5.x”</a> for details.
			</p>
            </div>
            <p>
			From the command prompt, move to the "asynch" folder under the <a href="#EJB3_TUTORIAL_HOME" title="1.3. Set the EJB3_TUTORIAL_HOME">Section 1.3, “Set the EJB3_TUTORIAL_HOME”</a>
		
            </p>
            <div class="sect5" lang="en">
               <div class="titlepage"/>
Ant Users:
	</div>
            <p>
		Make sure your JBossAS-5.x is running
		</p>
            <pre class="programlisting">
	
$ ant
$ ant run

run:
     [java] -------- Synchronous call
     [java] normal call
     [java] -------- Asynchronous call
     [java] Direct return of async invocation is: null
     [java] -------- Synchronous call
     [java] normal call 2
     [java] -------- Result of Asynchronous call
     [java] asynchronous call

     
	</pre>
            <div class="sect5" lang="en">
               <div class="titlepage"/>
Maven Users: Make sure the AS is not running.
	</div>
            <pre class="programlisting">
$ mvn clean install -PRunSingleTutorial
	</pre>
         </div>
         <div class="chapter" lang="en">
            <div class="titlepage">
               <div>
                  <div>
                     <h2 class="title">
                        <a id="Partial_deployment_descriptor"/>Chapter 37. Partial Deployment Descriptors</h2>
                  </div>
               </div>
            </div>
            <p>
      EJB 3.0 allows for partial deployment descriptors to augment or override the behavior of source code annotations. This tutorial describes
      the use of partial deployment descriptors.
   </p>
            <div class="sect5" lang="en">
               <div class="titlepage"/>
      Overview :
		<p>
	 		Beans in EJB 3.0 can be specified via source code annotations and/or a deployment descriptor. The deployment descriptor is used to
	 		augment or override the source code annotations. There are some limitations on which annotations may be overridden, however.
	 		The annotations that specify the bean itself (e.g. <code class="literal">@Stateless</code>, <code class="literal">@Stateful</code>,
	 		<code class="literal">@MessageDriven</code>, <code class="literal">@Service</code>,  <code class="literal">@Consumer</code>) cannot be overridden.
	 		The EJB 3.0 <code class="literal">ejb-jar.xml</code> deployment descriptor xsd specifies the majority of tags as optional in order to
	 		support annotation augmentation and overrides. The deployment descriptor does not need to specify all of the required information,
	 		just that additional information to override or augment the source code annotations.
      </p>
            </div>
            <div class="sect5" lang="en">
               <div class="titlepage"/>
      Example :
      	<p>
         	This section contains examples of complete and partial deployment descriptors for completely specifying or overriding
         	specific behaviors of EJBs.
      	</p>
               <div class="sect5" lang="en">
                  <div class="titlepage"/>
         	Complete deployment descriptor :
         	<p>
            	Take a look at the <code class="literal">META-INF/ejb-jar.xml</code>. The ejb-jar.xml in this tutorial configures the <code class="literal">CompleteXMLDD</code>
            	bean only through the deployment descriptor. The <code class="literal">PartialXMLDD</code> bean is configured through the deployment descriptor
            	as well as through annotations.
				</p>
                  <pre class="programlisting">
					
&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;ejb-jar
        xmlns="http://java.sun.com/xml/ns/javaee"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="http://java.sun.com/xml/ns/javaee
                            http://java.sun.com/xml/ns/javaee/ejb-jar_3_0.xsd"
        version="3.0"&gt;
	&lt;description&gt;Partial deployment descriptors for EJB in JBoss&lt;/description&gt;
   	&lt;display-name&gt;Partial deployment descriptors&lt;/display-name&gt;
   	&lt;enterprise-beans&gt;
      &lt;session&gt;
         &lt;ejb-name&gt;CompleteXMLDD&lt;/ejb-name&gt;
         &lt;business-remote&gt;org.jboss.tutorial.partial_deployment_descriptor.bean.CompleteXMLDD&lt;/business-remote&gt;
         &lt;ejb-class&gt;org.jboss.tutorial.partial_deployment_descriptor.bean.CompleteXMLDDBean&lt;/ejb-class&gt;
         &lt;session-type&gt;Stateless&lt;/session-type&gt;
         &lt;transaction-type&gt;Container&lt;/transaction-type&gt;
         &lt;ejb-ref&gt;
            &lt;ejb-ref-name&gt;ejb/PartialXMLDD&lt;/ejb-ref-name&gt;
            &lt;ejb-ref-type&gt;Session&lt;/ejb-ref-type&gt;
            &lt;mapped-name&gt;PartialXMLDD/remote&lt;/mapped-name&gt;
            &lt;injection-target&gt;
             	&lt;injection-target-class&gt;org.jboss.tutorial.partial_deployment_descriptor.bean.CompleteXMLDDBean&lt;/injection-target-class&gt;
             	&lt;injection-target-name&gt;partialXMLDDBean&lt;/injection-target-name&gt;
             &lt;/injection-target&gt;
         &lt;/ejb-ref&gt;
         &lt;resource-ref&gt;
             &lt;res-ref-name&gt;TimerService&lt;/res-ref-name&gt;
             &lt;res-type&gt;javax.ejb.TimerService&lt;/res-type&gt;
             &lt;res-auth&gt;Container&lt;/res-auth&gt;
             &lt;res-sharing-scope&gt;Shareable&lt;/res-sharing-scope&gt;
             &lt;injection-target&gt;
             	&lt;injection-target-class&gt;org.jboss.tutorial.partial_deployment_descriptor.bean.CompleteXMLDDBean&lt;/injection-target-class&gt;
             	&lt;injection-target-name&gt;timerService&lt;/injection-target-name&gt;
             &lt;/injection-target&gt;
         &lt;/resource-ref&gt;
         &lt;post-construct&gt;
         	&lt;lifecycle-callback-class&gt;org.jboss.tutorial.partial_deployment_descriptor.bean.ExternalCallbackListener&lt;/lifecycle-callback-class&gt;
         	&lt;lifecycle-callback-method&gt;postConstruct&lt;/lifecycle-callback-method&gt;
         &lt;/post-construct&gt;

         &lt;security-identity&gt;
            &lt;run-as&gt;
               &lt;role-name&gt;admin&lt;/role-name&gt;
            &lt;/run-as&gt;
         &lt;/security-identity&gt;
      &lt;/session&gt;
      &lt;session&gt;
         &lt;ejb-name&gt;PartialXMLDD&lt;/ejb-name&gt;
         &lt;business-remote&gt;org.jboss.tutorial.partial_deployment_descriptor.bean.PartialXMLDD&lt;/business-remote&gt;
         &lt;ejb-class&gt;org.jboss.tutorial.partial_deployment_descriptor.bean.PartialXMLDDBean&lt;/ejb-class&gt;
         &lt;session-type&gt;Stateful&lt;/session-type&gt;
         &lt;init-method&gt;
         	&lt;create-method&gt;
         		&lt;method-name&gt;create&lt;/method-name&gt;
         	&lt;/create-method&gt;
         	&lt;bean-method&gt;
         		&lt;method-name&gt;init&lt;/method-name&gt;
         	&lt;/bean-method&gt;
         &lt;/init-method&gt;
         &lt;remove-method&gt;
         	&lt;bean-method&gt;
         		&lt;method-name&gt;remove&lt;/method-name&gt;
         	&lt;/bean-method&gt;
         &lt;/remove-method&gt;
         &lt;transaction-type&gt;Container&lt;/transaction-type&gt;

         &lt;env-entry&gt;
            &lt;env-entry-name&gt;id&lt;/env-entry-name&gt;
            &lt;env-entry-type&gt;java.lang.String&lt;/env-entry-type&gt;
            &lt;env-entry-value&gt;5678&lt;/env-entry-value&gt;
         &lt;/env-entry&gt;
         &lt;resource-ref&gt;
            &lt;res-ref-name&gt;DefaultDS&lt;/res-ref-name&gt;
            &lt;res-type&gt;javax.sql.DataSource&lt;/res-type&gt;
            &lt;res-auth&gt;Container&lt;/res-auth&gt;
            &lt;res-sharing-scope&gt;Shareable&lt;/res-sharing-scope&gt;
            &lt;injection-target&gt;
            	&lt;injection-target-class&gt;org.jboss.tutorial.partial_deployment_descriptor.bean.PartialXMLDDBean&lt;/injection-target-class&gt;
            	&lt;injection-target-name&gt;ds&lt;/injection-target-name&gt;
            &lt;/injection-target&gt;
         &lt;/resource-ref&gt;
      &lt;/session&gt;
   &lt;/enterprise-beans&gt;
   &lt;interceptors&gt;
   	&lt;interceptor&gt;
   		&lt;interceptor-class&gt;org.jboss.tutorial.partial_deployment_descriptor.bean.FirstInterceptor&lt;/interceptor-class&gt;
   		&lt;around-invoke&gt;
   			&lt;method-name&gt;interceptorMethod&lt;/method-name&gt;
   		&lt;/around-invoke&gt;
   	&lt;/interceptor&gt;
   	&lt;interceptor&gt;
   		&lt;interceptor-class&gt;org.jboss.tutorial.partial_deployment_descriptor.bean.SecondInterceptor&lt;/interceptor-class&gt;
   	&lt;/interceptor&gt;
   &lt;/interceptors&gt;
   &lt;assembly-descriptor&gt;
   	  &lt;security-role&gt;
         &lt;role-name&gt;admin&lt;/role-name&gt;
      &lt;/security-role&gt;
      &lt;security-role&gt;
         &lt;role-name&gt;normal&lt;/role-name&gt;
      &lt;/security-role&gt;
      &lt;method-permission&gt;
         &lt;role-name&gt;normal&lt;/role-name&gt;
         &lt;method&gt;
            &lt;ejb-name&gt;CompleteXMLDD&lt;/ejb-name&gt;
            &lt;method-name&gt;sayHello&lt;/method-name&gt;
         &lt;/method&gt;
      &lt;/method-permission&gt;
      &lt;method-permission&gt;
         &lt;unchecked/&gt;
         &lt;method&gt;
            &lt;ejb-name&gt;CompleteXMLDD&lt;/ejb-name&gt;
            &lt;method-name&gt;sayBye&lt;/method-name&gt;
         &lt;/method&gt;
      &lt;/method-permission&gt;
      &lt;method-permission&gt;
         &lt;role-name&gt;admin&lt;/role-name&gt;
         &lt;method&gt;
            &lt;ejb-name&gt;PartialXMLDD&lt;/ejb-name&gt;
            &lt;method-name&gt;echoMessage&lt;/method-name&gt;
         &lt;/method&gt;
         &lt;method&gt;
            &lt;ejb-name&gt;PartialXMLDD&lt;/ejb-name&gt;
            &lt;method-name&gt;changeMessage&lt;/method-name&gt;
         &lt;/method&gt;
      &lt;/method-permission&gt;
      &lt;container-transaction&gt;
         &lt;method&gt;
            &lt;ejb-name&gt;CompleteXMLDD&lt;/ejb-name&gt;
            &lt;method-name&gt;greetWithNotSupportedTransaction&lt;/method-name&gt;
         &lt;/method&gt;
         &lt;trans-attribute&gt;NotSupported&lt;/trans-attribute&gt;
      &lt;/container-transaction&gt;
      &lt;container-transaction&gt;
         &lt;method&gt;
            &lt;ejb-name&gt;CompleteXMLDD&lt;/ejb-name&gt;
            &lt;method-name&gt;greetWithRequiredTransaction&lt;/method-name&gt;
            &lt;method-params&gt;
               &lt;method-param&gt;java.lang.String&lt;/method-param&gt;
            &lt;/method-params&gt;
         &lt;/method&gt;
         &lt;trans-attribute&gt;Required&lt;/trans-attribute&gt;
      &lt;/container-transaction&gt;
      &lt;interceptor-binding&gt;
      	&lt;ejb-name&gt;CompleteXMLDD&lt;/ejb-name&gt;
      	&lt;interceptor-class&gt;org.jboss.tutorial.partial_deployment_descriptor.bean.FirstInterceptor&lt;/interceptor-class&gt;
      	&lt;interceptor-class&gt;org.jboss.tutorial.partial_deployment_descriptor.bean.SecondInterceptor&lt;/interceptor-class&gt;
   	  &lt;/interceptor-binding&gt;
      &lt;exclude-list&gt;
         &lt;method&gt;
            &lt;ejb-name&gt;CompleteXMLDD&lt;/ejb-name&gt;
            &lt;method-name&gt;uncallableMethod&lt;/method-name&gt;
         &lt;/method&gt;
      &lt;/exclude-list&gt;

   &lt;/assembly-descriptor&gt;

&lt;/ejb-jar&gt;

			
		</pre>
                  <p>
       
                  </p>
               </div>
               <div class="sect5" lang="en">
                  <div class="titlepage"/>
         Transactions :
         <p>
            The following <code class="literal">ejb-jar.xml</code> file overrides any <code class="literal">@TransactionAttribute</code> annotations for the
            <code class="literal">greetWithNotSupportedTransaction</code> method of the <code class="literal">CompleteXMLDD</code> bean and adds a
            <code class="literal">@TransactionAttribute</code> annotation for <code class="literal">NOT SUPPORTED</code>.
            </p>
                  <pre class="programlisting">
            	
@TransactionAttribute (TransactionAttributeType.REQUIRES_NEW)
public String greetWithNotSupportedTransaction(String name)
{

...
&lt;container-transaction&gt;
   &lt;method&gt;
      &lt;ejb-name&gt;CompleteXMLDD&lt;/ejb-name&gt;
      &lt;method-name&gt;greetWithNotSupportedTransaction&lt;/method-name&gt;
   &lt;/method&gt;
   &lt;trans-attribute&gt;NotSupported&lt;/trans-attribute&gt;
&lt;/container-transaction&gt;
...
            </pre>
                  <p>
         
                  </p>
               </div>
               <div class="sect5" lang="en">
                  <div class="titlepage"/>
         References :
         <p>
            The following <code class="literal">ejb-jar.xml</code> file creates a EJB reference and injects the EJB to the injection
            target of the <code class="literal">partialXMLDDBean</code> member variable.
            </p>
                  <pre class="programlisting">
&lt;ejb-name&gt;CompleteXMLDD&lt;/ejb-name&gt;
...
&lt;ejb-ref&gt;
   &lt;ejb-ref-name&gt;ejb/PartialXMLDD&lt;/ejb-ref-name&gt;
   &lt;ejb-ref-type&gt;Session&lt;/ejb-ref-type&gt;
   &lt;mapped-name&gt;PartialXMLDD/remote&lt;/mapped-name&gt;
   &lt;injection-target&gt;
    	&lt;injection-target-class&gt;org.jboss.tutorial.partial_deployment_descriptor.bean.CompleteXMLDDBean&lt;/injection-target-class&gt;
    	&lt;injection-target-name&gt;partialXMLDDBean&lt;/injection-target-name&gt;
    &lt;/injection-target&gt;
&lt;/ejb-ref&gt;
...
            </pre>
                  <p>
         
                  </p>
               </div>
               <div class="sect5" lang="en">
                  <div class="titlepage"/>
         Callbacks :
         <p>
            The following <code class="literal">ejb-jar.xml</code> file adds a <code class="literal">@PostConstruct</code> annotation to the
            <code class="literal">postConstruct</code> method of the <code class="literal">CompleteXMLDD</code> bean.
            </p>
                  <pre class="programlisting">
            	
&lt;ejb-name&gt;CompleteXMLDD&lt;/ejb-name&gt;
...
&lt;post-construct&gt;
	&lt;lifecycle-callback-class&gt;org.jboss.tutorial.partial_deployment_descriptor.bean.ExternalCallbackListener&lt;/lifecycle-callback-class&gt;
	&lt;lifecycle-callback-method&gt;postConstruct&lt;/lifecycle-callback-method&gt;
&lt;/post-construct&gt;
...
            	
            </pre>
                  <p>
         
                  </p>
               </div>
            </div>
            <div class="sect5" lang="en">
               <div class="titlepage"/>

Building and Running
	<p>
			
               </p>
               <div class="note">
                  <h2>Note</h2>
                  <p>
						To build and run the example, make sure you have installed JBoss 5.x.
						See the <a href="#JBossAS5" title="1.1. JBoss Application Server 5.x">Section 1.1, “JBoss Application Server 5.x”</a> for details.
					</p>
               </div>
               <p>
			From the command prompt, move to the "partial_deployment_descriptor" folder under the <a href="#EJB3_TUTORIAL_HOME" title="1.3. Set the EJB3_TUTORIAL_HOME">Section 1.3, “Set the EJB3_TUTORIAL_HOME”</a>
			
               </p>
               <div class="sect5" lang="en">
                  <div class="titlepage"/>
		Ant Users:
			</div>
               <p>
				
               </p>
               <p>
				Make sure your JBossAS-5.x is running
				</p>
               <p>
			
               </p>
               <pre class="programlisting">
			
$ ant
$ ant run

run:
     [java] jai is a normal user
     [java] Hello, jai. I am the CompleteXMLDDBean. I have the following resources with me:
     [java] Timer Service : org.jboss.ejb3.timerservice.jboss.TimerServiceFacade@184a6b9
     [java] PartialXMLDD Bean : Proxy to jboss.j2ee:jar=jboss-ejb3-tutorial-partial_deployment_descriptor.jar,name=PartialXMLDD,service=EJB3 implementing [interface org.jboss.ejb3.proxy.intf.EjbProxy, interface org.jboss.tutorial.partial_deployment_descriptor.bean.PartialXMLDD, interface org.jboss.ejb3.proxy.intf.StatefulSessionProxy, interface org.jboss.ejb3.proxy.intf.SessionProxy]
     [java]
     [java] Welcome jai, you are in a method with no transaction supported
     [java] Welcome jai, you are in a method with a REQUIRED transaction
     [java] Bye, jai. Hope to see you again
     [java] We'll try calling an uncallable method
     [java] Caught expected exception : Caller unauthorized
     [java] bill is an admin
     [java] Sending Hello World message to bean. We expect the bean to change it
     [java] This message has been changed
     [java] Now calling echo message
     [java] Hello World
     [java] We are done with the bean, let's remove it
     [java] Bean removed


		     
			</pre>
               <p>

			
               </p>
               <div class="sect5" lang="en">
                  <div class="titlepage"/>
Maven Users: Make sure the AS is not running.
	</div>
               <p>

	
               </p>
               <pre class="programlisting">
$ mvn clean install -PRunSingleTutorial
			</pre>
               <p>

		
               </p>
            </div>
         </div>
         <div class="chapter" lang="en">
            <div class="titlepage">
               <div>
                  <div>
                     <h2 class="title">
                        <a id="Consumer_and_Producer"/>Chapter 38. Message Driven POJOs (JBoss specific)</h2>
                  </div>
               </div>
            </div>
            <p>
		The idea of Message Driven POJOs is to give a message consumer (an MDB), a typed interface
		that message producers can send messages through.  Both the publisher and subscriber would be typed interfaces.
		This further facilitates the removal of all the lookups and bootstrap code you have to do to obtain
		and send a message and receive and dispatch a JMS message. With regular JMS you have to :
		</p>
            <div class="itemizedlist">
               <ul>
                  <li>Get a connectionfactory</li>
                  <li>Get a connection</li>
                  <li>Get a destination</li>
                  <li>... and so on</li>
               </ul>
            </div>
            <p>
		For the Message Driven POJOs, you just do:
		</p>
            <div class="itemizedlist">
               <ul>
                  <li>Get a producer</li>
                  <li>Invoke on producer</li>
               </ul>
            </div>
            <p>
	
            </p>
            <div class="sect5" lang="en">
               <div class="titlepage"/>
		Model :
		<p>
			Message Driven POJOs will have the same model as Stateless/Stateful beans. There is a bean class tagged as
			<code class="literal">@org.jboss.ejb3.annotation.Consumer</code> that must implement one or more <code class="literal">@org.jboss.ejb3.annotation.Producer</code> interfaces. Just
			as a stateless bean is tagged as <code class="literal">@Stateless</code> and implements one or more
			<code class="literal">@Remote</code> or <code class="literal">@Local</code> interfaces. Take a look at <code class="literal">org.jboss.tutorial.consumer.bean.ExampleConsumerBean</code>

			
               </p>
               <pre class="programlisting">
				
@Consumer(activationConfig =
{@ActivationConfigProperty(propertyName = "destinationType", propertyValue = "javax.jms.Queue"),
      @ActivationConfigProperty(propertyName = "destination", propertyValue = "queue/tutorial/example")})
@Depends ("jboss.messaging.destination:service=Queue,name=tutorial")
public class ExampleConsumerBean implements ExampleProducerRemote, ExampleProducerLocal, ExampleProducerXA
{
...
   public void method1(String msg, int val)
   {
      System.out.println("method1(" + msg + ", " + val + ")");
   }

   public void method2(String msg, Map&lt;String, String&gt; map)
   {
      System.out.println("method2: " + msg);
      for (String key : map.keySet())
      {
         System.out.println("method2 key/val: " + key + ":" + map.get(key));
      }
   }
				
			</pre>
               <p>
			Here's one of the @Producer interfaces :
			</p>
               <pre class="programlisting">
				
@Producer
public interface ExampleProducerRemote extends ExampleProducer
{
...
				
			</pre>
               <p>
			You can see in this example that the <code class="literal">ExampleConsumerBean</code> implements the @Producer interfaces and defines
			the methods which can receive JMS messages. These interfaces will be used by clients(JMS Publishers) to send messages to the
			consumer via JMS.
			</p>
               <div class="note">
                  <h2>Note</h2>
                  <p>
					For each <code class="literal">@Producer</code> interface the <code class="literal">@Consumer</code> implements, there
					will be a proxy that implements that <code class="literal">@Producer</code> registered in JNDI under the fully qualified name of
					that <code class="literal">@Producer</code> interface.
				</p>
               </div>
               <p>
			Let's now look at the client <code class="literal">org.jboss.tutorial.consumer.client.Client</code>
			
               </p>
               <pre class="programlisting">
				
public static void main(String[] args) throws Exception
   {
      InitialContext ctx = new InitialContext();
      ExampleProducerRemote remote = (ExampleProducerRemote) ctx.lookup(ExampleProducerRemote.class.getName());

      // you can typecast the returned proxy to obtain a ProducerManager interface that allows you to manage
      // interaction with JMS.
      ProducerManager manager = ((ProducerObject) remote).getProducerManager();


      // connect - internally creates a JMS connection
      manager.connect();

      try
      {
         // Call method1
         remote.method1("Remote method1 called", 1);
         System.out.println("Remote method1 called");

         // Call method2
         Map&lt;String, String&gt; map = new HashMap&lt;String, String&gt;();
         map.put("hello", "world");
         map.put("great", "ejb3");

         remote.method2("Remote method2 called", map);
         System.out.println("Remote method2 called");
      }
      finally
      {
         // instead of typecasting, you can use a helper class that does everything for you.
         ProducerConfig.close(remote);
      }
				
			</pre>
               <p>
			When the <code class="literal">@Consumer</code> is deployed by the EJB3 container, it looks for all of its <code class="literal">@Producer</code> interfaces
			and registers each one of them in JNDI under their fully qualified class name.
			The client looks up the <code class="literal">ExampleProducerRemote</code> from the JNDI and uses the returned proxy to send the message.
			The returned proxy can be cast to <code class="literal">org.jboss.ejb3.mdb.ProducerObject</code>. It then gets a <code class="literal">org.jboss.ejb3.mdb.ProducerManager</code>,
			that manages the JMS connection for this proxy. To start being able to send messages to the Queue, the client calls <code class="literal">connect</code> on the
			<code class="literal">ProducerManager</code>. When the client calls <code class="literal">method1()</code> on the proxy, this method call is converted
			into a JMS message and published to the Queue of the Consumer. The consumer will receive the message and invoke its <code class="literal">method1</code> method.
		</p>
            </div>
            <div class="sect5" lang="en">
               <div class="titlepage"/>
		Producer default values :
		<p>
			The proxy registered in JNDI will know how to contact the JMS Queue/Topic to publish messages. You can specify explicitly through
			the <code class="literal">connectionFactory</code> attribute of the <code class="literal">@Producer</code>annotation what the JMS ConnectionFactory
			JNDI name is, or you can rely on defaults.

			</p>
               <div class="note">
                  <h2>Note</h2>
                  <p>
					The default value for the ConnectionFactory JNDI name is "ConnectionFactory". If you additionally tag the producer as @ProducerLocal instead of @Producer,
					then "java:/ConnectionFactory" will be used.
				</p>
               </div>
               <p>
		
               </p>
            </div>
            <div class="sect5" lang="en">
               <div class="titlepage"/>
		@ProducerLocal :
		<p>
			If you tag a producer as @ProducerLocal, the proxy will lookup the connection factory via the default InitialContext
			when connect() is called. Otherwise, the ConnectFactory reference will be embedded directly within the proxy.

		</p>
            </div>
            <div class="sect5" lang="en">
               <div class="titlepage"/>
		@MessageProperties :
		<p>
			The methods defined in a Producer are turned into JMS messages. The default message properties are a Time To Live of 0, a
			Priority of 4, and a delivery mode of PERSISTENT. You can override these default values in a couple of ways.
			</p>
               <div class="itemizedlist">
                  <ul>
                     <li>
					You can use the @MessageProperties anntotation and tag the Producer class directly to override the values:
					<pre class="programlisting">
						
@Producer
@MessageProperties(delivery=DeliveryMode.NON_PERSISTENT, timeToLive=1000, priority=1)
public interface ExampleProducer
{
...
						
					</pre>
					In this configuration, all method calls on ExampleProducer will use the JMS message properties defined with the
					<code class="literal">@MessageProperties</code> annotation on the interface.

				</li>
                     <li>
					You can specify @MessageProperties on a per method basis :
					<pre class="programlisting">
						
public interface ExampleProducer
{
   void method1(String msg, int val);

   @MessageProperties(delivery = DeliveryMode.NON_PERSISTENT)
   void method2(String msg, Map&lt;String, String&gt; map);
}
						
					</pre>
					So, in the above example, <code class="literal">method1()</code> uses the default message properties, and
					<code class="literal">method2()</code> overrides the defaults via the <code class="literal">@MessageProperties</code> annotation attached to it.

				</li>
                  </ul>
               </div>
               <p>

		
               </p>
            </div>
            <div class="sect5" lang="en">
               <div class="titlepage"/>
		Obtaining the current message :
		<p>
			Sometimes you may need to access the real JMS message. Maybe you need to obtain the replyTo destination or set an
			acknowledgement or something. You can obtain it by using the <code class="literal">@org.jboss.ejb3.annotation.CurrentMessage</code> annotation.
			</p>
               <pre class="programlisting">
				
@CurrentMessage
private Message currentMessage;


				
			</pre>
               <p>
			This annotation will inject the current JMS message into your Consumer bean before your target method is invoked.
		</p>
            </div>
            <div class="sect5" lang="en">
               <div class="titlepage"/>

Building and Running
	<p>
			
               </p>
               <div class="note">
                  <h2>Note</h2>
                  <p>
						To build and run the example, make sure you have installed JBoss 5.x.
						See the <a href="#JBossAS5" title="1.1. JBoss Application Server 5.x">Section 1.1, “JBoss Application Server 5.x”</a> for details.
					</p>
               </div>
               <p>
			From the command prompt, move to the "consumer" folder under the <a href="#EJB3_TUTORIAL_HOME" title="1.3. Set the EJB3_TUTORIAL_HOME">Section 1.3, “Set the EJB3_TUTORIAL_HOME”</a>
			
               </p>
               <div class="sect5" lang="en">
                  <div class="titlepage"/>
		Ant Users:
			</div>
               <p>
				
               </p>
               <p>
				Make sure your JBossAS-5.x is running
				</p>
               <p>
			
               </p>
               <pre class="programlisting">
			
$ ant
$ ant run

run:
     [java] Remote method1 called
     [java] Remote method2 called

		     
			</pre>
               <p>

			
               </p>
               <div class="sect5" lang="en">
                  <div class="titlepage"/>
Maven Users: Make sure the AS is not running.
	        </div>
               <p>

	
               </p>
               <pre class="programlisting">
$ mvn clean install -PRunSingleTutorial
			</pre>
               <p>

		
               </p>
            </div>
         </div>
         <div class="chapter" lang="en">
            <div class="titlepage">
               <div>
                  <div>
                     <h2 class="title">
                        <a id="TODO"/>Chapter 39. TODO</h2>
                  </div>
               </div>
            </div>
            <div class="toc">
               <dl>
                  <dt>
                     <span class="section">
                        <a href="#Maven_Users_TODO">39.1. TODO - Provide better support for Maven</a>
                     </span>
                  </dt>
               </dl>
            </div>
            <div class="section" lang="en">
               <div class="titlepage">
                  <div>
                     <div>
                        <h2 class="title">
                           <a id="Maven_Users_TODO"/>39.1. TODO - Provide better support for Maven</h2>
                     </div>
                  </div>
               </div>
               <p>
             The current release should have the necessary support to run individual tutorials
             through Maven. This section is just a placeholder and will be removed soon.
			</p>
            </div>
         </div>
      </div>
   </body>
</html>